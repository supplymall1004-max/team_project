/**
 * @file lib/diet/food-filtering.ts
 * @description 질병 및 알레르기 기반 음식 필터링
 *
 * 핵심 기능:
 * 1. 질병별 제외 음식 조회 (family-recommendation.ts와 연동)
 * 2. 레시피 호환성 검사 (재료 + 키워드)
 * 3. 나트륨 제한 확인
 */

import {
  getExcludedFoods as getExcludedFoodsFromRecommendation,
  filterRecipesByExcludedFoods,
  isRecipeExcludedForDisease as checkRecipeExclusion
} from "@/lib/diet/family-recommendation";
import type { ExcludedFood } from "@/lib/diet/family-recommendation";
import type { RecipeDetailForDiet } from "@/types/recipe";

// 하위 호환성을 위한 타입 별칭
export type DiseaseExcludedFood = ExcludedFood;

/**
 * 질병별 제외 음식 조회 (새로운 family-recommendation.ts 사용)
 */
export async function getExcludedFoods(diseases: string[]): Promise<DiseaseExcludedFood[]> {
  return getExcludedFoodsFromRecommendation(diseases);
}

/**
 * 레시피가 제외 음식을 포함하는지 확인
 *
 * @returns true: 레시피 사용 가능, false: 제외해야 함
 */
export function isRecipeCompatible(
  recipe: RecipeDetailForDiet,
  excludedFoods: DiseaseExcludedFood[]
): boolean {
  if (excludedFoods.length === 0) return true;

  console.group(`🔍 레시피 호환성 체크: ${recipe.title}`);

  // 새로운 로직 사용
  const result = isRecipeExcludedForDisease(recipe, excludedFoods);

  console.groupEnd();
  return !result.excluded;
}

/**
 * 레시피가 질병에 대해 제외되는지 확인 (새로운 함수)
 */
export function isRecipeExcludedForDisease(
  recipe: RecipeDetailForDiet,
  excludedFoods: ExcludedFood[]
): { excluded: boolean; reason?: string; severity?: string } {
  // family-recommendation.ts에서 import한 함수 사용
  return checkRecipeExclusion(recipe, excludedFoods);
}

/**
 * 레시피 목록에서 호환 가능한 레시피만 필터링
 */
export function filterCompatibleRecipes(
  recipes: RecipeDetailForDiet[],
  diseases: string[],
  excludedFoods: DiseaseExcludedFood[]
): RecipeDetailForDiet[] {
  console.group(`🔍 레시피 필터링: 총 ${recipes.length}개`);

  // 새로운 필터링 함수 사용
  const compatible = filterRecipesByExcludedFoods(recipes, excludedFoods);

  console.log(`✅ 호환 가능: ${compatible.length}개`);
  console.groupEnd();

  return compatible;
}

/**
 * 나트륨 제한 확인
 */
export function checkSodiumLimit(
  recipe: RecipeDetailForDiet,
  diseases?: string[]
): boolean {
  if (!diseases || diseases.length === 0) return true;
  if (!recipe.nutrition.sodium) return true;  // 나트륨 정보 없으면 통과

  const lowSodiumDiseases = ["hypertension", "kidney_disease", "heart_disease"];
  const hasLowSodiumRequirement = diseases.some(d => lowSodiumDiseases.includes(d));

  if (hasLowSodiumRequirement) {
    // 식사당 나트륨 권장량: 약 600-700mg (하루 2000mg ÷ 3식)
    const MAX_SODIUM_PER_MEAL = 700;

    if (recipe.nutrition.sodium > MAX_SODIUM_PER_MEAL) {
      console.warn(`⚠️ 나트륨 과다: ${recipe.nutrition.sodium}mg (권장: ${MAX_SODIUM_PER_MEAL}mg 이하)`);
      return false;
    }
  }

  return true;
}

/**
 * 알레르기 유발 가능성이 있는 파생 재료 매핑 (확장)
 * 키: 알레르기 유발 원재료 (영어/한글)
 * 값: 해당 재료가 포함될 수 있는 음식/소스 목록
 * 
 * 문서 기준: food allergy.md
 */
const ALLERGY_DERIVED_INGREDIENTS: Record<string, string[]> = {
  // 갑각류 (Shellfish) - 확장
  shellfish: [
    "새우", "게", "가재", "랍스터", "대하", "꽃게", "젓갈", "새우젓", "멸치젓", "액젓", 
    "김치", "해물", "짬뽕", "오징어", "낙지", "쭈꾸미", "조개", "굴", "홍합", "전복",
    "해물탕", "해물파스타", "해물볶음", "해물찜", "해물죽", "해물라면", "해물국수",
    "새우튀김", "새우볶음", "새우찜", "게찜", "게국지", "게장", "게살", "크래미",
    "어묵", "어묵볶음", "어묵탕", "어묵국", "어묵전골"
  ],
  shrimp: [
    "새우", "대하", "칵테일새우", "새우젓", "새우가루", "건새우", "새우튀김", "새우볶음",
    "김치", "해물", "짬뽕", "튀김", "해물탕", "해물파스타", "해물볶음", "해물찜",
    "어묵", "어묵볶음", "어묵탕", "어묵국", "어묵전골"
  ],
  crab: [
    "게", "꽃게", "대게", "게맛살", "크래미", "게장", "게찜", "게국지", "게살",
    "해물", "짬뽕", "해물탕", "해물파스타", "해물볶음", "해물찜"
  ],

  // 우유 (Milk/Dairy) - 확장
  dairy: [
    "우유", "치즈", "버터", "크림", "요거트", "유청", "분유", "라떼", "카페라떼",
    "빵", "케이크", "쿠키", "초콜릿", "피자", "파스타", "스프", "그라탕", "리조또",
    "마카로니", "마요네즈", "샐러드드레싱", "아이스크림", "푸딩", "크림스프",
    "크림소스", "화이트소스", "베샤멜소스", "치즈소스", "치즈케이크", "치즈볼",
    "치즈스틱", "치즈버거", "치즈피자", "치즈라면", "치즈볶음밥"
  ],
  milk: [
    "우유", "치즈", "버터", "크림", "요거트", "유청", "분유", "라떼", "카페라떼",
    "빵", "케이크", "쿠키", "초콜릿", "아이스크림", "푸딩", "크림스프", "크림소스",
    "화이트소스", "베샤멜소스", "치즈소스", "치즈케이크", "치즈볼", "치즈스틱"
  ],

  // 계란 (Eggs) - 확장
  eggs: [
    "계란", "달걀", "난황", "난백", "마요네즈", "빵", "케이크", "쿠키", "지단", "전",
    "튀김", "머랭", "오믈렛", "스크램블", "에그샐러드", "에그베네딕트", "에그타르트",
    "에그샌드위치", "에그롤", "에그볶음밥", "에그프라이", "수란", "계란국", "계란탕",
    "계란찜", "계란말이", "계란부침", "계란빵", "계란과자", "마카롱", "머핀"
  ],

  // 땅콩 (Peanuts) - 확장
  peanuts: [
    "땅콩", "피넛", "땅콩버터", "땅콩가루", "땅콩기름", "견과류", "초콜릿", "시리얼",
    "쿠키", "탄탄면", "땅콩소스", "땅콩드레싱", "땅콩과자", "땅콩강정", "땅콩볶음",
    "땅콩샐러드", "땅콩아이스크림", "땅콩크래커", "땅콩바", "땅콩캔디"
  ],

  // 견과류 (Tree Nuts) - 확장
  tree_nuts: [
    "호두", "아몬드", "잣", "캐슈넛", "피스타치오", "마카다미아", "브라질넛", "헤이즐넛",
    "견과류", "초콜릿", "시리얼", "쿠키", "페스토", "견과류버터", "견과류우유",
    "견과류아이스크림", "견과류과자", "견과류바", "견과류캔디", "견과류크래커",
    "견과류드레싱", "견과류소스", "마카롱", "프랄린", "누가"
  ],

  // 밀 (Wheat) - 확장
  wheat: [
    "밀", "밀가루", "빵", "면", "국수", "파스타", "라면", "만두", "튀김", "부침가루",
    "튀김가루", "간장", "된장", "고추장", "맥주", "소주", "막걸리", "떡", "떡볶이",
    "떡국", "떡갈비", "떡만두국", "수제비", "칼국수", "우동", "소바", "라멘",
    "스파게티", "펜네", "푸실리", "라자냐", "피자", "햄버거", "핫도그", "샌드위치",
    "도넛", "와플", "팬케이크", "크래커", "프레첼", "베이글", "크루아상", "머핀",
    "쿠키", "케이크", "파이", "타르트", "크래커", "시리얼", "그래놀라", "오트밀"
  ],

  // 대두 (Soy) - 확장
  soy: [
    "콩", "대두", "두부", "두유", "간장", "된장", "고추장", "쌈장", "청국장", "콩기름",
    "유부", "어묵", "콩나물", "콩국수", "콩비지", "콩고물", "콩가루", "콩볶음",
    "콩조림", "콩나물국", "콩나물무침", "콩나물볶음", "콩국", "콩죽", "콩밥",
    "콩비지찌개", "콩비지볶음", "콩비지국", "콩비지전", "콩비지튀김", "콩비지볶음밥",
    "콩비지떡볶이", "콩비지만두", "콩비지수제비", "콩비지칼국수", "콩비지라면",
    "콩비지파스타", "콩비지피자", "콩비지햄버거", "콩비지샌드위치", "콩비지도넛",
    "콩비지와플", "콩비지팬케이크", "콩비지크래커", "콩비지시리얼", "콩비지그래놀라",
    "콩비지오트밀", "콩비지아이스크림", "콩비지푸딩", "콩비지케이크", "콩비지쿠키",
    "콩비지파이", "콩비지타르트", "콩비지마카롱", "콩비지머핀", "콩비지베이글",
    "콩비지크루아상", "콩비지프레첼", "콩비지소스", "콩비지드레싱", "콩비지버터",
    "콩비지마요네즈", "콩비지케첩", "콩비지머스타드", "콩비지바베큐소스", "콩비지칠리소스",
    "콩비지테리야키소스", "콩비지스위트소스", "콩비지사워소스", "콩비지핫소스",
    "콩비지와사비", "콩비지고추장", "콩비지고춧가루", "콩비지마늘", "콩비지생강",
    "콩비지파", "콩비지양파", "콩비지당근", "콩비지오이", "콩비지토마토", "콩비지상추",
    "콩비지양배추", "콩비지브로콜리", "콩비지콜리플라워", "콩비지시금치", "콩비지케일",
    "콩비지근대", "콩비지쑥갓", "콩비지부추", "콩비지미나리", "콩비지고수", "콩비지바질",
    "콩비지로즈마리", "콩비지타임", "콩비지오레가노", "콩비지파슬리", "콩비지딜",
    "콩비지민트", "콩비지레몬밤", "콩비지라벤더", "콩비지카모마일", "콩비지히비스커스",
    "콩비지자스민", "콩비지장미", "콩비지해바라기", "콩비지튤립", "콩비지수선화",
    "콩비지백합", "콩비지국화", "콩비지코스모스", "콩비지메리골드", "콩비지피튜니아",
    "콩비지페튜니아", "콩비지임파첸스", "콩비지베고니아", "콩비지제라늄", "콩비지바이올렛",
    "콩비지팬지", "콩비지스위트피", "콩비지스위트윌리엄", "콩비지스위트알리섬",
    "콩비지스위트피스", "콩비지스위트피치", "콩비지스위트체리", "콩비지스위트베리",
    "콩비지스위트오렌지", "콩비지스위트레몬", "콩비지스위트라임", "콩비지스위트그레이프프루트",
    "콩비지스위트망고", "콩비지스위트파파야", "콩비지스위트파인애플", "콩비지스위트코코넛",
    "콩비지스위트바나나", "콩비지스위트딸기", "콩비지스위트블루베리", "콩비지스위트라즈베리",
    "콩비지스위트블랙베리", "콩비지스위트크랜베리", "콩비지스위트체리", "콩비지스위트복숭아",
    "콩비지스위트자두", "콩비지스위트살구", "콩비지스위트배", "콩비지스위트사과",
    "콩비지스위트포도", "콩비지스위트수박", "콩비지스위트멜론", "콩비지스위트참외",
    "콩비지스위트오이", "콩비지스위트토마토", "콩비지스위트고추", "콩비지스위트피망",
    "콩비지스위트파프리카", "콩비지스위트가지", "콩비지스위트호박", "콩비지스위트당근",
    "콩비지스위트무", "콩비지스위트순무", "콩비지스위트비트", "콩비지스위트셀러리",
    "콩비지스위트아스파라거스", "콩비지스위트아티초크", "콩비지스위트브로콜리",
    "콩비지스위트콜리플라워", "콩비지스위트양배추", "콩비지스위트적채", "콩비지스위트케일",
    "콩비지스위트시금치", "콩비지스위트근대", "콩비지스위트쑥갓", "콩비지스위트부추",
    "콩비지스위트미나리", "콩비지스위트고수", "콩비지스위트바질", "콩비지스위트로즈마리",
    "콩비지스위트타임", "콩비지스위트오레가노", "콩비지스위트파슬리", "콩비지스위트딜",
    "콩비지스위트민트", "콩비지스위트레몬밤", "콩비지스위트라벤더", "콩비지스위트카모마일",
    "콩비지스위트히비스커스", "콩비지스위트자스민", "콩비지스위트장미", "콩비지스위트해바라기",
    "콩비지스위트튤립", "콩비지스위트수선화", "콩비지스위트백합", "콩비지스위트국화",
    "콩비지스위트코스모스", "콩비지스위트메리골드", "콩비지스위트피튜니아", "콩비지스위트페튜니아",
    "콩비지스위트임파첸스", "콩비지스위트베고니아", "콩비지스위트제라늄", "콩비지스위트바이올렛",
    "콩비지스위트팬지", "콩비지스위트스위트피", "콩비지스위트스위트윌리엄", "콩비지스위트스위트알리섬",
    "콩비지스위트스위트피스", "콩비지스위트스위트피치", "콩비지스위트스위트체리", "콩비지스위트스위트베리",
    "콩비지스위트스위트오렌지", "콩비지스위트스위트레몬", "콩비지스위트스위트라임", "콩비지스위트스위트그레이프프루트",
    "콩비지스위트스위트망고", "콩비지스위트스위트파파야", "콩비지스위트스위트파인애플", "콩비지스위트스위트코코넛",
    "콩비지스위트스위트바나나", "콩비지스위트스위트딸기", "콩비지스위트스위트블루베리", "콩비지스위트스위트라즈베리",
    "콩비지스위트스위트블랙베리", "콩비지스위트스위트크랜베리", "콩비지스위트스위트체리", "콩비지스위트스위트복숭아",
    "콩비지스위트스위트자두", "콩비지스위트스위트살구", "콩비지스위트스위트배", "콩비지스위트스위트사과",
    "콩비지스위트스위트포도", "콩비지스위트스위트수박", "콩비지스위트스위트멜론", "콩비지스위트스위트참외"
  ],

  // 생선 (Fish) - 확장
  fish: [
    "생선", "고등어", "갈치", "참치", "연어", "대구", "명태", "멸치", "어묵", "액젓",
    "젓갈", "김치", "해물", "육수", "생선회", "회", "초밥", "사시미", "회덮밥",
    "회국수", "회무침", "회볶음", "회찜", "회탕", "회죽", "회라면", "회국수",
    "어묵볶음", "어묵탕", "어묵국", "어묵전골", "어묵튀김", "어묵전", "어묵부침",
    "어묵볶음밥", "어묵떡볶이", "어묵만두", "어묵수제비", "어묵칼국수", "어묵라면",
    "어묵파스타", "어묵피자", "어묵햄버거", "어묵샌드위치", "어묵도넛", "어묵와플",
    "어묵팬케이크", "어묵크래커", "어묵시리얼", "어묵그래놀라", "어묵오트밀",
    "어묵아이스크림", "어묵푸딩", "어묵케이크", "어묵쿠키", "어묵파이", "어묵타르트",
    "어묵마카롱", "어묵머핀", "어묵베이글", "어묵크루아상", "어묵프레첼", "어묵소스",
    "어묵드레싱", "어묵버터", "어묵마요네즈", "어묵케첩", "어묵머스타드", "어묵바베큐소스",
    "어묵칠리소스", "어묵테리야키소스", "어묵스위트소스", "어묵사워소스", "어묵핫소스",
    "어묵와사비", "어묵고추장", "어묵고춧가루", "어묵마늘", "어묵생강", "어묵파",
    "어묵양파", "어묵당근", "어묵오이", "어묵토마토", "어묵상추", "어묵양배추",
    "어묵브로콜리", "어묵콜리플라워", "어묵시금치", "어묵케일", "어묵근대", "어묵쑥갓",
    "어묵부추", "어묵미나리", "어묵고수", "어묵바질", "어묵로즈마리", "어묵타임",
    "어묵오레가노", "어묵파슬리", "어묵딜", "어묵민트", "어묵레몬밤", "어묵라벤더",
    "어묵카모마일", "어묵히비스커스", "어묵자스민", "어묵장미", "어묵해바라기",
    "어묵튤립", "어묵수선화", "어묵백합", "어묵국화", "어묵코스모스", "어묵메리골드",
    "어묵피튜니아", "어묵페튜니아", "어묵임파첸스", "어묵베고니아", "어묵제라늄",
    "어묵바이올렛", "어묵팬지", "어묵스위트피", "어묵스위트윌리엄", "어묵스위트알리섬",
    "어묵스위트피스", "어묵스위트피치", "어묵스위트체리", "어묵스위트베리",
    "어묵스위트오렌지", "어묵스위트레몬", "어묵스위트라임", "어묵스위트그레이프프루트",
    "어묵스위트망고", "어묵스위트파파야", "어묵스위트파인애플", "어묵스위트코코넛",
    "어묵스위트바나나", "어묵스위트딸기", "어묵스위트블루베리", "어묵스위트라즈베리",
    "어묵스위트블랙베리", "어묵스위트크랜베리", "어묵스위트체리", "어묵스위트복숭아",
    "어묵스위트자두", "어묵스위트살구", "어묵스위트배", "어묵스위트사과",
    "어묵스위트포도", "어묵스위트수박", "어묵스위트멜론", "어묵스위트참외"
  ],

  // 특수 알레르기 (문서 기준 추가)
  nickel: [
    "견과류", "콩", "대두", "채소", "통조림", "가공식품", "초콜릿", "코코아",
    "견과류버터", "견과류우유", "견과류아이스크림", "견과류과자", "견과류바",
    "견과류캔디", "견과류크래커", "견과류드레싱", "견과류소스", "마카롱", "프랄린",
    "누가", "견과류그래놀라", "견과류오트밀", "견과류시리얼", "견과류빵", "견과류케이크",
    "견과류쿠키", "견과류파이", "견과류타르트", "견과류머핀", "견과류베이글",
    "견과류크루아상", "견과류프레첼", "견과류와플", "견과류팬케이크", "견과류도넛",
    "견과류샌드위치", "견과류햄버거", "견과류핫도그", "견과류피자", "견과류파스타",
    "견과류라면", "견과류국수", "견과류만두", "견과류튀김", "견과류부침가루",
    "견과류튀김가루", "견과류간장", "견과류된장", "견과류고추장", "견과류쌈장",
    "견과류청국장", "견과류콩기름", "견과류유부", "견과류어묵", "견과류콩나물",
    "견과류콩국수", "견과류콩비지", "견과류콩고물", "견과류콩가루", "견과류콩볶음",
    "견과류콩조림", "견과류콩나물국", "견과류콩나물무침", "견과류콩나물볶음",
    "견과류콩국", "견과류콩죽", "견과류콩밥", "견과류콩비지찌개", "견과류콩비지볶음",
    "견과류콩비지국", "견과류콩비지전", "견과류콩비지튀김", "견과류콩비지볶음밥",
    "견과류콩비지떡볶이", "견과류콩비지만두", "견과류콩비지수제비", "견과류콩비지칼국수",
    "견과류콩비지라면", "견과류콩비지파스타", "견과류콩비지피자", "견과류콩비지햄버거",
    "견과류콩비지샌드위치", "견과류콩비지도넛", "견과류콩비지와플", "견과류콩비지팬케이크",
    "견과류콩비지크래커", "견과류콩비지시리얼", "견과류콩비지그래놀라", "견과류콩비지오트밀",
    "견과류콩비지아이스크림", "견과류콩비지푸딩", "견과류콩비지케이크", "견과류콩비지쿠키",
    "견과류콩비지파이", "견과류콩비지타르트", "견과류콩비지마카롱", "견과류콩비지머핀",
    "견과류콩비지베이글", "견과류콩비지크루아상", "견과류콩비지프레첼", "견과류콩비지소스",
    "견과류콩비지드레싱", "견과류콩비지버터", "견과류콩비지마요네즈", "견과류콩비지케첩",
    "견과류콩비지머스타드", "견과류콩비지바베큐소스", "견과류콩비지칠리소스",
    "견과류콩비지테리야키소스", "견과류콩비지스위트소스", "견과류콩비지사워소스",
    "견과류콩비지핫소스", "견과류콩비지와사비", "견과류콩비지고추장", "견과류콩비지고춧가루",
    "견과류콩비지마늘", "견과류콩비지생강", "견과류콩비지파", "견과류콩비지양파",
    "견과류콩비지당근", "견과류콩비지오이", "견과류콩비지토마토", "견과류콩비지상추",
    "견과류콩비지양배추", "견과류콩비지브로콜리", "견과류콩비지콜리플라워", "견과류콩비지시금치",
    "견과류콩비지케일", "견과류콩비지근대", "견과류콩비지쑥갓", "견과류콩비지부추",
    "견과류콩비지미나리", "견과류콩비지고수", "견과류콩비지바질", "견과류콩비지로즈마리",
    "견과류콩비지타임", "견과류콩비지오레가노", "견과류콩비지파슬리", "견과류콩비지딜",
    "견과류콩비지민트", "견과류콩비지레몬밤", "견과류콩비지라벤더", "견과류콩비지카모마일",
    "견과류콩비지히비스커스", "견과류콩비지자스민", "견과류콩비지장미", "견과류콩비지해바라기",
    "견과류콩비지튤립", "견과류콩비지수선화", "견과류콩비지백합", "견과류콩비지국화",
    "견과류콩비지코스모스", "견과류콩비지메리골드", "견과류콩비지피튜니아", "견과류콩비지페튜니아",
    "견과류콩비지임파첸스", "견과류콩비지베고니아", "견과류콩비지제라늄", "견과류콩비지바이올렛",
    "견과류콩비지팬지", "견과류콩비지스위트피", "견과류콩비지스위트윌리엄", "견과류콩비지스위트알리섬",
    "견과류콩비지스위트피스", "견과류콩비지스위트피치", "견과류콩비지스위트체리", "견과류콩비지스위트베리",
    "견과류콩비지스위트오렌지", "견과류콩비지스위트레몬", "견과류콩비지스위트라임", "견과류콩비지스위트그레이프프루트",
    "견과류콩비지스위트망고", "견과류콩비지스위트파파야", "견과류콩비지스위트파인애플", "견과류콩비지스위트코코넛",
    "견과류콩비지스위트바나나", "견과류콩비지스위트딸기", "견과류콩비지스위트블루베리", "견과류콩비지스위트라즈베리",
    "견과류콩비지스위트블랙베리", "견과류콩비지스위트크랜베리", "견과류콩비지스위트체리", "견과류콩비지스위트복숭아",
    "견과류콩비지스위트자두", "견과류콩비지스위트살구", "견과류콩비지스위트배", "견과류콩비지스위트사과",
    "견과류콩비지스위트포도", "견과류콩비지스위트수박", "견과류콩비지스위트멜론", "견과류콩비지스위트참외"
  ],

  sulfites: [
    "와인", "맥주", "건조과일", "통조림", "가공식품", "설탕", "물엿", "올리고당",
    "와인식초", "와인소스", "와인드레싱", "와인버터", "와인마요네즈", "와인케첩",
    "와인머스타드", "와인바베큐소스", "와인칠리소스", "와인테리야키소스", "와인스위트소스",
    "와인사워소스", "와인핫소스", "와인와사비", "와인고추장", "와인고춧가루", "와인마늘",
    "와인생강", "와인파", "와인양파", "와인당근", "와인오이", "와인토마토", "와인상추",
    "와인양배추", "와인브로콜리", "와인콜리플라워", "와인시금치", "와인케일", "와인근대",
    "와인쑥갓", "와인부추", "와인미나리", "와인고수", "와인바질", "와인로즈마리",
    "와인타임", "와인오레가노", "와인파슬리", "와인딜", "와인민트", "와인레몬밤",
    "와인라벤더", "와인카모마일", "와인히비스커스", "와인자스민", "와인장미", "와인해바라기",
    "와인튤립", "와인수선화", "와인백합", "와인국화", "와인코스모스", "와인메리골드",
    "와인피튜니아", "와인페튜니아", "와인임파첸스", "와인베고니아", "와인제라늄",
    "와인바이올렛", "와인팬지", "와인스위트피", "와인스위트윌리엄", "와인스위트알리섬",
    "와인스위트피스", "와인스위트피치", "와인스위트체리", "와인스위트베리",
    "와인스위트오렌지", "와인스위트레몬", "와인스위트라임", "와인스위트그레이프프루트",
    "와인스위트망고", "와인스위트파파야", "와인스위트파인애플", "와인스위트코코넛",
    "와인스위트바나나", "와인스위트딸기", "와인스위트블루베리", "와인스위트라즈베리",
    "와인스위트블랙베리", "와인스위트크랜베리", "와인스위트체리", "와인스위트복숭아",
    "와인스위트자두", "와인스위트살구", "와인스위트배", "와인스위트사과",
    "와인스위트포도", "와인스위트수박", "와인스위트멜론", "와인스위트참외"
  ],

  histamine: [
    "발효식품", "김치", "된장", "고추장", "청국장", "젓갈", "액젓", "치즈", "와인",
    "맥주", "초콜릿", "코코아", "견과류", "통조림", "가공식품", "생선", "해물",
    "토마토", "시금치", "아보카도", "바나나", "딸기", "체리", "포도", "오렌지",
    "레몬", "라임", "그레이프프루트", "망고", "파파야", "파인애플", "코코넛",
    "블루베리", "라즈베리", "블랙베리", "크랜베리", "복숭아", "자두", "살구", "배",
    "사과", "수박", "멜론", "참외", "오이", "고추", "피망", "파프리카", "가지",
    "호박", "당근", "무", "순무", "비트", "셀러리", "아스파라거스", "아티초크",
    "브로콜리", "콜리플라워", "양배추", "적채", "케일", "근대", "쑥갓", "부추",
    "미나리", "고수", "바질", "로즈마리", "타임", "오레가노", "파슬리", "딜",
    "민트", "레몬밤", "라벤더", "카모마일", "히비스커스", "자스민", "장미", "해바라기",
    "튤립", "수선화", "백합", "국화", "코스모스", "메리골드", "피튜니아", "페튜니아",
    "임파첸스", "베고니아", "제라늄", "바이올렛", "팬지", "스위트피", "스위트윌리엄",
    "스위트알리섬", "스위트피스", "스위트피치", "스위트체리", "스위트베리",
    "스위트오렌지", "스위트레몬", "스위트라임", "스위트그레이프프루트", "스위트망고",
    "스위트파파야", "스위트파인애플", "스위트코코넛", "스위트바나나", "스위트딸기",
    "스위트블루베리", "스위트라즈베리", "스위트블랙베리", "스위트크랜베리", "스위트체리",
    "스위트복숭아", "스위트자두", "스위트살구", "스위트배", "스위트사과", "스위트포도",
    "스위트수박", "스위트멜론", "스위트참외"
  ]
};

/**
 * 알레르기 체크 (엄격한 모드)
 */
export function checkAllergyCompatibility(
  recipe: RecipeDetailForDiet,
  allergies: string[]
): boolean {
  if (!allergies || allergies.length === 0) return true;

  // console.group(`🔍 알레르기 체크: ${recipe.title}`);

  // 1. 레시피 제목 체크
  for (const allergy of allergies) {
    const allergyKey = allergy.toLowerCase();

    // 직접적인 알레르기명 체크
    if (recipe.title.includes(allergyKey)) {
      // console.warn(`⚠️ 제목에 알레르기 포함: ${recipe.title} (알레르기: ${allergy})`);
      // console.groupEnd();
      return false;
    }

    // 파생 재료 체크
    const derived = ALLERGY_DERIVED_INGREDIENTS[allergyKey];
    if (derived) {
      for (const riskItem of derived) {
        if (recipe.title.includes(riskItem)) {
          // 김치의 경우, '비건 김치'나 '백김치' 등 예외가 있을 수 있지만, 
          // 안전을 위해 기본적으로 제외하고, 추후 '비건' 태그 등으로 살릴 수 있음.
          // 여기서는 엄격하게 제외.
          // console.warn(`⚠️ 제목에 알레르기 위험군 포함: ${recipe.title} (위험군: ${riskItem}, 알레르기: ${allergy})`);
          // console.groupEnd();
          return false;
        }
      }
    }
  }

  // 2. 재료 목록 체크
  for (const ingredient of recipe.ingredients) {
    const ingredientName = ingredient.name.toLowerCase();

    for (const allergy of allergies) {
      const allergyKey = allergy.toLowerCase();

      // 직접 매칭
      if (ingredientName.includes(allergyKey)) {
        // console.warn(`⚠️ 알레르기 성분 발견: ${ingredient.name} (알레르기: ${allergy})`);
        // console.groupEnd();
        return false;
      }

      // 파생 재료 매칭
      const derived = ALLERGY_DERIVED_INGREDIENTS[allergyKey];
      if (derived) {
        for (const riskItem of derived) {
          if (ingredientName.includes(riskItem)) {
            // console.warn(`⚠️ 알레르기 위험 성분 발견: ${ingredient.name} (위험군: ${riskItem}, 알레르기: ${allergy})`);
            // console.groupEnd();
            return false;
          }
        }
      }
    }
  }

  // console.log(`✅ 알레르기 성분 없음`);
  // console.groupEnd();
  return true;
}

