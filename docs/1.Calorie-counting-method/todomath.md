# 식약처 API 기반 AI 식단 생성 시스템 업데이트 계획서

## 개요
식약처 API를 활용하여 사용자의 질병, 알레르기, 나이, 상태, 임신유무, 청소년 발달 등 모든 요소를 반영한 하루 및 주간 식단 생성 로직을 구현합니다.

---

## Phase 1: 식약처 API 통합 및 레시피 병합 시스템

### 1.1 식약처 API 레시피 조회 및 병합 로직
- [ ] `lib/diet/mfds-recipe-fetcher.ts` 새로 생성
  - [ ] 식약처 API에서 레시피 목록을 대량으로 가져오는 함수 구현
  - [ ] 페이지네이션 처리 (startIdx, endIdx)
  - [ ] API 호출 실패 시 재시도 로직
  - [ ] 레시피 중복 제거 로직 (RCP_SEQ 기준)
- [ ] `lib/diet/recipe-merger.ts` 새로 생성
  - [ ] DB 레시피와 식약처 API 레시피를 병합하는 함수
  - [ ] 중복 제거 로직 (slug 또는 foodsafety_rcp_seq 기준)
  - [ ] 영양 정보 통합 (DB 우선, 없으면 API 데이터 사용)
  - [ ] 재료 정보 통합 (RCP_PARTS_DTLS 파싱)
- [ ] `lib/diet/queries.ts` 수정
  - [ ] `getRecipesWithNutrition()` 함수에 식약처 API 병합 로직 추가
  - [ ] 캐싱 전략 구현 (식약처 API 호출 최소화)
  - [ ] 병합된 레시피 목록 반환

### 1.2 식약처 API 필드 매핑 및 파싱
- [ ] `lib/services/mfds-recipe-api.ts` 확장
  - [ ] `INFO_K` (칼륨) 필드 파싱 추가
  - [ ] `INFO_P` (인) 필드 파싱 추가
  - [ ] `INFO_GI` (GI 지수) 필드 파싱 추가 (있는 경우)
  - [ ] `RCP_INGRDIENT` (재료 목록) 상세 파싱 개선
  - [ ] `RCP_WAY` (조리법) 파싱 추가
- [ ] 타입 정의 확장
  - [ ] `types/recipe.ts`에 칼륨, 인, GI 지수 필드 추가
  - [ ] `RecipeWithNutrition` 인터페이스 확장

---

## Phase 2: 칼로리 계산 공식 확장

### 2.1 다중 칼로리 계산 공식 지원
- [ ] `lib/health/calorie-calculator-enhanced.ts` 확장
  - [ ] Harris-Benedict 공식 구현 완료 확인 및 테스트
  - [ ] EER (추정 에너지 필요량) 공식 구현
    - [ ] 3-8세 남아/여아 공식
    - [ ] 9-18세 남아/여아 공식
  (PA 계수 포함)
  - [ ] 임신부 칼로리 계산 공식 구현
    - [ ] 임신 초기 (0 kcal 추가)
    - [ ] 임신 중기 (+340 kcal)
    - [ ] 임신 후기 (+452 kcal)
  - [ ] CKD (만성 신장 질환) 칼로리 계산 구현
    - [ ] 30-35 kcal/kg (표준 체중 기준)
    - [ ] 표준 체중 계산 로직 추가
- [ ] 공식 자동 선택 로직
  - [ ] 나이 기반 자동 선택 (18세 미만 → EER, 18세 이상 → Mifflin-St Jeor)
  - [ ] 임신 상태 기반 자동 선택
  - [ ] 질병 기반 자동 선택 (CKD → CKD 공식)
  - [ ] 사용자 수동 선택 옵션 제공

### 2.2 질병별 칼로리 조정 계수 업데이트
- [ ] `lib/diet/calorie-calculator.ts` 수정
  - [ ] 당뇨: 0.85 → 0.80-0.90 (문서 기준)
  - [ ] 비만: 0.80 유지
  - [ ] 통풍: 0.90 유지
  - [ ] 심혈관 질환: 체중 감량 필요 시 -500~-1000 kcal
  - [ ] CKD: 30-35 kcal/kg (표준 체중) 적용
- [ ] 최소 안전 칼로리 보장 로직 확인
  - [ ] 여성: 1200 kcal
  - [ ] 남성: 1500 kcal
  - [ ] 임신부: 임신 전 TEE +340/452 kcal 추가

### 2.3 칼로리 계산 결과 표시
- [ ] `components/health/calorie-calculator-display.tsx` 확인/수정
  - [ ] 사용된 공식 표시
  - [ ] 계산 과정 단계별 표시
  - [ ] 질병별 조정 내역 표시
  - [ ] 최종 목표 칼로리 강조

---

## Phase 3: 질병별 제외 음식 데이터베이스 확장

### 3.1 질병별 제외 음식 마스터 데이터 구축
- [ ] `supabase/migrations/YYYYMMDDHHmmss_expand_disease_excluded_foods.sql` 생성
  - [ ] 당뇨 제외 음식 추가
    - [ ] 단순당: 설탕, 꿀, 사탕, 초콜릿, 젤리
    - [ ] 정제 곡물: 흰쌀밥, 흰 밀가루 빵, 파스타
    - [ ] 가당 음료: 탄산음료, 주스, 믹스커피
    - [ ] 고나트륨: 라면, 찌개 국물, 가공육
    - [ ] 고지방: 튀긴 음식, 도넛, 패스트푸드
  - [ ] 심혈관 질환 제외 음식 추가
    - [ ] 고나트륨: 라면, 찌개, 국물, 가공육 (햄, 소시지, 베이컨)
    - [ ] 포화지방: 삼겹살, 갈비, 닭 껍질, 버터, 전지방 유제품
    - [ ] 트랜스지방: 마가린, 쇼트닝, 도넛, 크래커
    - [ ] 단순당: 탄산음료, 주스, 사탕, 케이크
  - [ ] CKD 제외 음식 추가
    - [ ] 고칼륨: 바나나, 멜론, 키위, 오렌지, 시금치, 근대, 쑥, 부추, 호박, 토마토, 버섯, 고구마, 감자, 잡곡밥
    - [ ] 고인: 우유, 치즈, 요구르트, 땅콩, 호두, 아몬드, 콩류 (팥, 녹두, 완두콩)
    - [ ] 고나트륨: 국물 요리, 찌개, 라면, 가공식품
    - [ ] 고단백질: 내장육, 고기 (제한량 초과 시)
  - [ ] 통풍 제외 음식 추가
    - [ ] 고퓨린: 내장육 (간, 콩팥), 고등어, 꽁치, 정어리, 맥주, 진한 육수
    - [ ] 중간 퓨린: 대부분의 육류, 가금류, 새우, 게, 굴, 장어
    - [ ] 과당 음료: 탄산음료, 가당 주스, 스포츠 음료
  - [ ] 위장 질환 제외 음식 추가
    - [ ] 고지방: 튀긴 음식, 육류 지방, 버터, 치즈, 초콜릿
    - [ ] 산성 음식: 오렌지, 레몬, 자몽, 토마토, 토마토소스
    - [ ] 자극성: 커피, 탄산음료, 술, 박하사탕, 매운 음식, 고춧가루, 후추
    - [ ] FODMAPs (IBS): 양파, 마늘, 밀가루, 콩류, 버섯, 자일리톨, 소르비톨
- [ ] `scripts/seed-health-data.ts` 수정
  - [ ] 위 제외 음식 데이터를 시드 스크립트에 추가
  - [ ] `excluded_food_type` 필드 설정 (ingredient 또는 recipe_keyword)
  - [ ] `severity` 필드 설정 (high, medium, low)
  - [ ] `reason` 필드에 제외 이유 설명 추가

### 3.2 알레르기 파생 재료 확장
- [ ] `lib/diet/food-filtering.ts` 수정
  - [ ] `ALLERGY_DERIVED_INGREDIENTS` 매핑 확장
    - [ ] 새우 → 새우젓, 김치, 해물, 짬뽕, 튀김, 액젓, 멸치젓
    - [ ] 게 → 게장, 크래미, 게맛살, 해물, 짬뽕
    - [ ] 우유 → 치즈, 버터, 크림, 요거트, 라떼, 빵, 케이크, 쿠키, 초콜릿, 피자, 파스타, 스프
    - [ ] 계란 → 마요네즈, 빵, 케이크, 쿠키, 지단, 전, 튀김, 머랭
    - [ ] 땅콩 → 땅콩버터, 견과류, 초콜릿, 시리얼, 쿠키, 탄탄면
    - [ ] 견과류 → 초콜릿, 시리얼, 쿠키, 페스토
    - [ ] 밀 → 밀가루, 빵, 면, 국수, 파스타, 라면, 만두, 튀김, 부침가루, 간장, 된장, 고추장, 맥주
    - [ ] 대두 → 두부, 두유, 간장, 된장, 고추장, 쌈장, 청국장, 콩기름, 유부, 어묵
    - [ ] 생선 → 어묵, 액젓, 젓갈, 김치, 해물, 육수
  - [ ] 특수 알레르기 파생 재료 추가
    - [ ] 니켈: 초콜릿, 코코아, 견과류, 콩류, 통곡물, 통조림, 시금치
    - [ ] 아황산염: 말린 과일, 와인, 맥주, 가공 육류, 샐러드 드레싱
    - [ ] 히스타민: 치즈, 와인, 맥주, 소시지, 오래된 생선, 시금치, 토마토

---

## Phase 4: 필터링 로직 강화

### 4.1 질병별 영양소 제한 필터링
- [ ] `lib/diet/recommendation.ts` 수정
  - [ ] 당뇨 필터링 강화
    - [ ] 탄수화물 50g 초과 제외 (기존 50g 유지)
    - [ ] GI 지수 고려 (있는 경우)
    - [ ] 단순당 함량 체크
  - [ ] 심혈관 질환 필터링 강화
    - [ ] 나트륨 400mg 초과 제외 (기존 500mg → 400mg로 강화)
    - [ ] 포화지방 비율 체크
    - [ ] 트랜스지방 함량 체크
  - [ ] CKD 필터링 강화
    - [ ] 칼륨 함량 체크 (INFO_K 필드 사용)
    - [ ] 인 함량 체크 (INFO_P 필드 사용)
    - [ ] 단백질 30g 초과 제외 (기존 유지)
    - [ ] 나트륨 700mg 초과 제외 (식사당)
  - [ ] 통풍 필터링 추가
    - [ ] 퓨린 함량 추정 (재료 기반)
    - [ ] 고퓨린 식품 제외
    - [ ] 과당 함량 체크
  - [ ] 위장 질환 필터링 추가
    - [ ] 고지방 식품 제외
    - [ ] 산성 음식 제외
    - [ ] 자극성 조리법 제외 (튀김, 볶음, 매운 양념)
    - [ ] FODMAPs 체크 (IBS 환자)

### 4.2 알레르기 필터링 강화
- [ ] `lib/diet/food-filtering.ts` 수정
  - [ ] `checkAllergyCompatibility()` 함수 개선
    - [ ] 재료 목록 상세 검사 (RCP_PARTS_DTLS 파싱 결과 사용)
    - [ ] 레시피 제목 검사
    - [ ] 조리법 검사 (RCP_WAY, RCP_WAY2)
    - [ ] 파생 재료 엄격 검사
  - [ ] 알레르기 파생 재료 매칭 로직 개선
    - [ ] 부분 문자열 매칭 (includes) → 정확한 단어 매칭으로 개선
    - [ ] 예외 처리 (예: "비건 김치"는 새우 알레르기에서 제외)
    - [ ] 대소문자 무시 매칭

### 4.3 재료 기반 필터링 개선
- [ ] `lib/services/mfds-recipe-api.ts` 수정
  - [ ] `parseIngredients()` 함수 개선
    - [ ] 재료명 정규화 (공백 제거, 단위 제거)
    - [ ] 재료 카테고리 분류 (주재료, 부재료, 조미료)
    - [ ] 재료명 동의어 처리 (예: "계란" = "달걀")
- [ ] `lib/diet/food-filtering.ts`에 재료 파싱 결과 활용
  - [ ] 파싱된 재료 목록을 필터링에 사용
  - [ ] 재료 카테고리별 필터링 (주재료 우선 검사)

---

## Phase 5: 임산부 및 청소년 식단 로직 추가

### 5.1 임산부 칼로리 계산 및 식단 생성
- [ ] `lib/health/calorie-calculator-enhanced.ts` 수정
  - [ ] 임신 상태 감지 로직 추가
  - [ ] 임신 주차별 칼로리 추가 계산
  - [ ] 임신 전 BMI 기반 체중 증가 목표 설정
- [ ] `lib/diet/recommendation.ts` 수정
  - [ ] 임산부 제외 음식 필터링 추가
    - [ ] 생선 (수은 함량 높은 생선 제외)
    - [ ] 날 음식 (회, 스시)
    - [ ] 미숙한 치즈
    - [ ] 알코올
    - [ ] 카페인 과다
  - [ ] 임산부 필수 영양소 우선순위 설정
    - [ ] 엽산, 철분, 칼슘 함유 식품 가산점
- [ ] `lib/diet/personal-diet-generator.ts` 수정
  - [ ] 임산부 식사 비율 조정 (일반 성인과 동일 유지)
  - [ ] 영양소 목표 조정 (단백질 증가, 철분, 엽산)

### 5.2 청소년 (EER 공식 적용
- [ ] `lib/health/calorie-calculator-enhanced.ts` 수정
  - [ ] EER 공식 구현 완료 확인
  - [ ] PA 계수 매핑 (비활동적, 낮은 활동, 활동적, 매우 활동적)
  - [ ] 나이별 자동 선택 로직
- [ ] `lib/diet/personal-diet-generator.ts` 수정
  - [ ] 청소년 식사 비율 적용 (아침 25%, 점심 35%, 저녁 30%, 간식 10%)
  - [ ] 성장기 필수 영양소 우선순위 설정
    - [ ] 단백질, 칼슘, 비타민 함유 식품 가산점
  - [ ] 청소년 제외 음식 필터링 (성인과 동일)

---

## Phase 6: 식단 생성 로직 통합 및 최적화

### 6.1 통합 필터링 파이프라인 구축
- [ ] `lib/diet/integrated-filter.ts` 새로 생성
  - [ ] 모든 필터링 로직을 통합하는 메인 함수
  - [ ] 필터링 순서 최적화
    1. 알레르기 필터링 (가장 엄격, Hard Exclusion)
    2. 질병별 제외 음식 필터링 (Hard Exclusion)
    3. 질병별 영양소 제한 필터링 (Soft Filtering)
    4. 선호/비선호 식재료 필터링
    5. 특수 식단 필터링 (도시락, 헬스, 저탄수, 비건 등)
  - [ ] 필터링 결과 로깅 (제외된 레시피와 이유)
  - [ ] `exclusionNotes` 생성 로직
- [ ] `lib/diet/recommendation.ts` 수정
  - [ ] `isRecipeCompatible()` 함수를 `integrated-filter.ts`로 이동
  - [ ] 통합 필터링 파이프라인 사용

### 6.2 식단 생성 알고리즘 개선
- [ ] `lib/diet/recommendation.ts` 수정
  - [ ] 매크로 목표 충족 알고리즘 개선
    - [ ] 단백질 우선 충족 (특히 CKD 환자)
    - [ ] 탄수화물/지방 비율 조정
    - [ ] 나트륨 제한 준수
  - [ ] 레시피 점수 계산 개선
    - [ ] 영양소 균형 점수 증가
    - [ ] 질병별 권장 식품 가산점
    - [ ] 선호 식재료 매칭 점수 증가
  - [ ] 식사별 칼로리 배분 개선
    - [ ] 질병별 조정 (당뇨: 탄수화물 균등 분배)
    - [ ] 임산부/청소년 비율 적용

### 6.3 주간 식단 생성 로직 업데이트
- [ ] `lib/diet/weekly-diet-generator.ts` 수정
  - [ ] 통합 필터링 파이프라인 적용
  - [ ] 레시피 다양성 강화 (주간 내 중복 최소화)
  - [ ] 주간 영양소 균형 체크
  - [ ] 장보기 리스트 생성 개선 (재료 통합 및 카테고리별 정렬)
- [ ] `lib/diet/family-diet-generator.ts` 수정
  - [ ] 통합 필터링 파이프라인 적용
  - [ ] 가족 구성원별 개인 식단 생성 시 필터링 적용
  - [ ] 통합 식단 생성 시 모든 구성원의 제약 조건 동시 만족

---

## Phase 7: API 및 데이터베이스 업데이트

### 7.1 API 엔드포인트 업데이트
- [ ] `app/api/diet/daily/route.ts` 확인/수정
  - [ ] 식약처 API 레시피 병합 로직 추가
  - [ ] 통합 필터링 파이프라인 적용
  - [ ] 응답에 `exclusionNotes` 필드 추가
- [ ] `app/api/diet/weekly/route.ts` 확인/수정
  - [ ] 식약처 API 레시피 병합 로직 추가
  - [ ] 통합 필터링 파이프라인 적용
  - [ ] 주간 식단 다양성 강화 로직 적용
- [ ] `app/api/family/diet/[date]/route.ts` 확인/수정
  - [ ] 식약처 API 레시피 병합 로직 추가
  - [ ] 통합 필터링 파이프라인 적용
  - [ ] 가족 구성원별 필터링 적용

### 7.2 데이터베이스 스키마 업데이트
- [ ] `supabase/migrations/YYYYMMDDHHmmss_add_nutrition_fields.sql` 생성
  - [ ] `recipes` 테이블에 칼륨, 인 필드 추가 (있는 경우)
  - [ ] `recipes` 테이블에 GI 지수 필드 추가 (있는 경우)
  - [ ] 인덱스 추가 (영양소 기반 필터링 성능 향상)
- [ ] `disease_excluded_foods` 테이블 확인
  - [ ] 필요한 컬럼이 모두 있는지 확인
  - [ ] 인덱스 최적화

---

## Phase 8: 테스트 및 검증

### 8.1 단위 테스트 작성
- [ ] `__tests__/lib/diet/integrated-filter.test.ts` 생성
  - [ ] 알레르기 필터링 테스트
  - [ ] 질병별 제외 음식 필터링 테스트
  - [ ] 영양소 제한 필터링 테스트
- [ ] `__tests__/lib/health/calorie-calculator-enhanced.test.ts` 생성
  - [ ] EER 공식 테스트
  - [ ] 임신부 칼로리 계산 테스트
  - [ ] CKD 칼로리 계산 테스트
- [ ] `__tests__/lib/diet/mfds-recipe-fetcher.test.ts` 생성
  - [ ] 식약처 API 호출 테스트
  - [ ] 레시피 병합 테스트

### 8.2 통합 테스트 작성
- [ ] `__tests__/api/diet/daily.test.ts` 생성
  - [ ] 일일 식단 생성 통합 테스트
  - [ ] 필터링 적용 확인 테스트
- [ ] `__tests__/api/diet/weekly.test.ts` 생성
  - [ ] 주간 식단 생성 통합 테스트
  - [ ] 다양성 확인 테스트

### 8.3 수동 테스트 시나리오
- [ ] 당뇨 + 땅콩 알레르기 사용자 식단 생성 테스트
- [ ] CKD 환자 식단 생성 테스트 (칼륨, 인 제한 확인)
- [ ] 임산부 식단 생성 테스트 (임신 주차별 칼로리 확인)
- [ ] 청소년 식단 생성 테스트 (EER 공식 적용 확인)
- [ ] 통풍 환자 식단 생성 테스트 (퓨린 제한 확인)
- [ ] 위장 질환 환자 식단 생성 테스트 (자극성 음식 제외 확인)
- [ ] 가족 식단 생성 테스트 (개인/통합 식단 모두 확인)

---

## Phase 9: 문서화 및 로깅

### 9.1 코드 문서화
- [ ] 모든 새로 생성된 함수에 JSDoc 주석 추가
- [ ] 복잡한 알고리즘에 상세 주석 추가
- [ ] 타입 정의에 설명 추가

### 9.2 로깅 개선
- [ ] 필터링 과정 상세 로깅 (`console.group` 사용)
- [ ] 제외된 레시피와 이유 로깅
- [ ] 칼로리 계산 과정 로깅
- [ ] 성능 측정 로깅 (API 호출 시간, 필터링 시간)

### 9.3 사용자 가이드 문서 작성
- [ ] `docs/diet-filtering-guide.md` 생성
  - [ ] 필터링 로직 설명
  - [ ] 질병별 제외 음식 목록
  - [ ] 알레르기 파생 재료 목록
  - [ ] 칼로리 계산 공식 설명

---

## Phase 10: 성능 최적화

### 10.1 캐싱 전략
- [ ] 식약처 API 응답 캐싱 (Redis 또는 메모리 캐시)
- [ ] 필터링 결과 캐싱 (사용자별, 날짜별)
- [ ] 레시피 병합 결과 캐싱

### 10.2 데이터베이스 최적화
- [ ] 인덱스 추가 (영양소 필드, 질병 코드 등)
- [ ] 쿼리 최적화 (JOIN 최소화, 필요한 필드만 SELECT)
- [ ] 배치 처리 (대량 레시피 조회 시)

### 10.3 API 호출 최적화
- [ ] 병렬 API 호출 (Promise.all 사용)
- [ ] 요청 배치 처리
- [ ] 실패 시 폴백 전략 (DB 레시피만 사용)

---

## 우선순위 및 일정

### 높은 우선순위 (필수)
1. Phase 1: 식약처 API 통합 및 레시피 병합 시스템
2. Phase 2: 칼로리 계산 공식 확장
3. Phase 3: 질병별 제외 음식 데이터베이스 확장
4. Phase 4: 필터링 로직 강화

### 중간 우선순위 (중요)
5. Phase 5: 임산부 및 청소년 식단 로직 추가
6. Phase 6: 식단 생성 로직 통합 및 최적화
7. Phase 7: API 및 데이터베이스 업데이트

### 낮은 우선순위 (개선)
8. Phase 8: 테스트 및 검증
9. Phase 9: 문서화 및 로깅
10. Phase 10: 성능 최적화

---

## 참고 문서
- `docs/PRD.md`: 제품 요구사항 정의서
- `docs/1.Calorie-counting-method/math.md`: 로직 구현 상세 계획
- `docs/1.Calorie-counting-method/diabetes`: 당뇨 식단 가이드
- `docs/1.Calorie-counting-method/Cardiovascular Diseases`: 심혈관 질환 식단 가이드
- `docs/1.Calorie-counting-method/Chronic Kidney Disease, CKD`: 신장 질환 식단 가이드
- `docs/1.Calorie-counting-method/Gout`: 통풍 식단 가이드
- `docs/1.Calorie-counting-method/Gastrointestinal Diseases`: 위장 질환 식단 가이드
- `docs/1.Calorie-counting-method/maternity`: 임산부 식단 가이드
- `docs/1.Calorie-counting-method/growing-children`: 청소년 식단 가이드
- `docs/1.Calorie-counting-method/food allergy`: 알레르기 가이드

