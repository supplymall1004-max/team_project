사용자님의 요청에 따라, 식약처 API를 활용하여 사용자의 질병, 알레르기, 상태 등을 반영한 하루 및 주간 식단 생성 로직의 **상세 구현 계획서**를 작성해 드립니다.

이 계획은 비개발자 초보자도 이해하기 쉽도록 모듈별로 구분하고, 첨부해 주신 모든 문서(`PRD.md`, 칼로리 계산법, 질병별 식단 파일)의 핵심 내용을 반영했습니다.

-----

## 1\. 🔍 MFDS API 및 데이터 분석 (Data Analysis)

식약처 API(식품영양성분DB)는 레시피 또는 개별 식품의 영양 성분 정보를 제공합니다. 로직을 구현하기 위해 레시피 API가 반드시 제공해야 하는 필수 데이터 필드를 가정하고 이를 분석합니다.

| 분류 | 필수 데이터 필드 (MFDS API 가정) | 로직 반영 목표 | 참고 파일 |
| :--- | :--- | :--- | :--- |
| **기본 정보** | `RCP_NM` (레시피 이름), `RCP_ID` (레시피 고유번호), `RCP_PAT2` (음식 분류: 주식/반찬/국 등) | 식단 구성의 다양성 및 균형 확보. | PRD.md |
| **재료 정보** | `RCP_INGRDIENT` (사용된 모든 재료 목록 - **가장 중요**), `RCP_UNIT` (단위) | **알레르기/질병 제외 로직의 핵심 데이터.** (예: '땅콩', '소고기', '소금', '우유' 등) | food allergy, CKD, Gout |
| **영양 성분** | `INFO_ENG` (칼로리/Kcal), `INFO_CAR` (탄수화물), `INFO_PRO` (단백질), `INFO_FAT` (지방), `INFO_NA` (나트륨/Sodium) | **매크로 및 칼로리 목표 달성** (단백질 제한, 나트륨 제한 등). | Calorie-counting-method, Diet method |
| **추가 성분** | `INFO_K` (칼륨), `INFO_P` (인), `INFO_GI` (GI 지수 또는 유사 대체 지표) | **CKD(칼륨, 인) 및 당뇨/CVD(GI 지수)** 필터링에 사용. (API에 필드가 없으면 재료 기반으로 유추 로직 필요) | Chronic Kidney Disease, CKD |

-----

## 2\. 📝 데이터 모델 정의 (Input/Output Structure)

### 2.1. 사용자 입력 데이터 구조 (User Profile Data)

| 필드명 | 데이터 타입 | 설명 | 필수 반영 로직 |
| :--- | :--- | :--- | :--- |
| `name` | String | 사용자 이름 | PRD의 `memberTabs[].name`에 사용. |
| `age` | Integer | 만 나이 | BMR, EER(성장기), 임신 상태 계산 기준. |
| `gender` | String | 성별 (남/여) | BMR 및 EER 공식 적용. |
| `weight` | Float | 현재 체중 (kg) | BMR, TEE, CKD(kg당 제한) 계산. |
| `height` | Float | 신장 (cm) | BMR 계산. |
| `activityLevel` | Float/String | 활동 계수 (1.2, 1.375 등) | TEE 계산에 사용. |
| `pregnancyStatus` | String | 임신 여부 / 주차 (임신 전, 1, 2, 3분기) | 추가 칼로리 요구량 계산. |
| `diseaseFlags` | Array\<String\> | 질병 목록 (예: "당뇨", "통풍", "CKD", "역류성 식도염") | **제한 성분 및 필터링 로직 활성화.** |
| `allergyIngredients` | Array\<String\> | 알레르기 유발 식품 (예: "땅콩", "우유", "대두") | **레시피 강제 제외 로직 활성화.** |

### 2.2. 식단 결과 데이터 구조 (PRD Output 반영)

PRD에 명시된 최종 응답 구조에 맞추어 `exclusionNotes` 필드를 채울 수 있도록 로직을 설계해야 합니다.

| 필드명 | 데이터 타입 | 설명 | 생성 로직 소스 |
| :--- | :--- | :--- | :--- |
| `healthFlags` | Array\<String\> | 입력된 질병, 알레르기 목록 (UI 설명란 사용) | 사용자 입력 |
| `nutrientTotals` | Object | 최종 선정된 식단의 총 영양소 합 (Kcal, Carb, Protein, Fat) | 3단계 식단 생성 로직 |
| **`exclusionNotes[]`** | Array\<String\> | **제외된 음식 또는 대체 조리법에 대한 요약 문구.** (예: "당뇨: 고GI 탄수화물 제외", "땅콩 알레르기: 땅콩 성분 일체 제외") | 4단계 필터링 로직 결과 |

-----

## 3\. 🎯 핵심 로직 1: 맞춤 칼로리 및 매크로 목표 계산 모듈

사용자의 상태에 따라 **가장 엄격한 기준**을 적용하여 일일 목표 칼로리(TEE)와 3대 영양소(매크로) 목표를 설정합니다.

### A. TEE (총 에너지 소비량) 계산

1.  **기본 BMR/TEE 계산:** 미플린-세인트 제어 공식(Mifflin-St Jeor) 및 활동 계수(PA)를 사용하여 기본 TEE를 계산합니다.
2.  **특수 상태 보정:**
      * **성장기:** 만 나이와 성별을 기준으로 EER(추정 에너지 필요량) 공식을 적용하거나, 권장 칼로리 범위표를 참고하여 TEE를 보정합니다.
      * **임산부:** 임신 전 TEE에 주차별 추가 칼로리(2분기 +340kcal, 3분기 +452kcal)를 더하여 TEE를 결정합니다.
3.  **질병 상태 보정 (최우선):**
      * **CKD (만성 신장 질환):** 30\~35 kcal/kg (표준 체중 또는 조정 체중 기준)을 TEE로 설정합니다. 이 값이 다른 계산 결과보다 낮거나 높더라도 신장 질환 관리가 최우선입니다.

### B. 매크로 (탄/단/지) 목표 설정

| 질환/상태 | 단백질 목표 (g/kg Ideal BW) | 나트륨 목표 (mg/일) | 칼륨/인 관리 목표 |
| :--- | :--- | :--- | :--- |
| **일반/다이어트** | 1.2\~1.6 g/kg 목표 (포만감 및 근육 유지) | 2,000 mg 이하 | - |
| **CKD (비투석)** | **0.6\~0.8 g/kg로 엄격히 제한** | 2,000 mg 이하 | 칼륨, 인 800\~1,000 mg/일 이하 제한 |
| **심혈관 질환 (CVD)** | 저지방 양질의 단백질 선택 | 2,000 mg 이하 **(강화)** | - |
| **통풍 (Gout)** | 저퓨린 단백질 선택 (가금류 껍질 제거, 달걀 흰자) | - | - |

-----

## 4\. 🛑 핵심 로직 2: 레시피 제외(필터링) 로직 모듈

레시피 DB에서 최종 식단을 선정하기 전, 사용자의 건강 정보와 매칭하여 부적합한 레시피를 제거하거나 점수를 깎는(Soft Filter) 다층 필터링을 적용합니다.

### A. 강제 제외 (Hard Exclusion) - 알레르기 및 금기 사항

| 필터링 종류 | 필터링 기준 | 제외 로직 | 로직 구현 방법 |
| :--- | :--- | :--- | :--- |
| **식품 알레르기** | 사용자 `allergyIngredients` 목록 | **레시피의 `RCP_INGRDIENT` 필드에 해당 재료가 포함된 경우 무조건 제외** (부분 포함 시에도) | `string.includes()` 또는 정규식을 사용하여 재료 목록 매칭. |
| **CKD 퓨린 제한** | 고퓨린 식품 (내장육, 특정 어패류, 육즙) | CKD 환자일 경우, 고퓨린 식품을 주재료로 하는 레시피는 제외 또는 경고. | CKD 고위험 식재료 목록 DB 구축 후 매칭. |
| **당뇨/CVD 금기** | 가공육, 트랜스지방, 고나트륨 식품 | 가공된 햄, 베이컨, 소시지 등이 포함된 레시피는 제외. | 가공식품 목록 DB 구축 후 매칭. |

### B. 성분 기반 위험 점수 부여 (Soft Filtering)

강제 제외되지 않은 레시피에 대해, 위험 성분 함량에 따라 점수를 부여하여 식단 선정 시 참고합니다.

| 질환/상태 | 위험 성분 (MFDS API 필드) | 위험 점수 부여 기준 (예시) | **제외 사유 출력 (exclusionNotes)** |
| :--- | :--- | :--- | :--- |
| **당뇨** | **탄수화물(Carb), GI** | 흰쌀밥, 단순당, 액상과당 함량이 높은 레시피는 점수 감소. | "고GI 탄수화물 및 단순당 제한" |
| **CKD** | **칼륨(K), 인(P), 나트륨(Na)** | **칼륨과 인 함량이 높은** 유제품, 견과류, 잡곡밥 레시피는 점수 감소. | "고칼륨, 고인 성분 포함 레시피 제외/점수 감소" |
| **CVD** | **나트륨(Na), 지방(Fat)** | **나트륨 400mg 이상**, 포화지방 비율이 높은 레시피는 점수 감소. | "저염식(2,000mg 이하), 포화지방 제한" |
| **위장 질환** | **조리법(RCP\_WAY)** | 튀김, 매운 양념(`RCP_WAY`에 "튀김", "볶음" 또는 "고춧가루" 재료 포함 시)은 점수 감소. | "고지방 튀김, 매운 양념 최소화" |

-----

## 5\. 🍽️ 식단 생성 및 최적화 로직 (Meal Generation & Optimization)

### A. 일일 식단 생성 플로우

1.  **필터링된 레시피 풀 준비:** 4단계의 강제 제외/소프트 필터링을 거친 레시피 목록을 준비합니다.
2.  **칼로리 할당:** TEE 목표(3단계 결과)를 기반으로 아침(25%), 점심(35%), 저녁(30%), 간식(10%) 등으로 칼로리를 배분합니다.
3.  **매크로 충족 순회:**
      * **단백질 최우선:** 3단계에서 설정된 \*\*단백질 목표(g)\*\*를 가장 먼저 충족시키는 것을 목표로 합니다. (특히 CKD 환자의 경우, **제한선**을 넘지 않는 것이 최우선입니다.)
      * **레시피 선택:** 각 끼니별 음식 분류(`RCP_PAT2` - 주식/반찬/국 등)를 고려하여 레시피를 조합합니다.
      * **최적화 함수:** 선택된 레시피 조합의 **총 칼로리 및 매크로**가 3단계 목표 범위(예: 목표 TEE의 $\pm 10\%$)에 가장 근접하고, 4단계 **위험 점수가 가장 낮은** 조합을 최종 식단으로 선정합니다.
4.  **`exclusionNotes` 생성:** 최종 식단에 반영된 필터링 정보를 요약하여 PRD의 `exclusionNotes[]` 필드에 담아 응답합니다.

### B. 주간 식단 확장 로직

1.  **다양성 확보:** 7일간의 식단 생성 시, 동일한 레시피(`RCP_ID`) 또는 유사한 주재료가 **연속되거나 너무 자주** 반복되지 않도록 \*\*사용 빈도 점수(Frequency Score)\*\*를 적용하여 다양성을 확보합니다.
2.  **재고 관리 (선택):** 사용자가 이전에 등록한 재고(식재료) 정보를 반영하여, 식단에 포함된 재료를 재구매 없이 소진할 수 있는 레시피에 **가산점**을 부여합니다.
3.  **주간 매크로 균형:** 일일 칼로리는 $\pm 10\%$의 변동을 허용하되, **주간 총합 칼로리**와 **주간 총합 매크로**가 3단계 목표에 최대한 가깝게 균형을 이루도록 조정합니다.