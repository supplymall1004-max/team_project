# 식단 생성 로직 설명서

이 문서는 식단 생성 시스템이 어떻게 작동하는지 비개발자도 쉽게 이해할 수 있도록 설명합니다.

## 📋 전체 흐름 개요

식단 생성은 **5단계**로 이루어집니다:

```
1. 사용자 정보 수집 → 2. 레시피 가져오기 → 3. 필터링 → 4. 식사별 선택 → 5. 저장
```

각 단계를 자세히 설명하겠습니다.

---

## 1단계: 사용자 정보 수집 👤

### 무엇을 하나요?
식단을 만들기 전에, 사용자의 건강 정보를 가져옵니다.

### 가져오는 정보들:
- **기본 정보**: 나이, 성별, 키, 몸무게
- **목표 칼로리**: 하루에 섭취할 칼로리 목표
- **질병 정보**: 당뇨, 고혈압, 신장질환 등
- **알레르기**: 견과류, 우유, 계란 등
- **선호/비선호 재료**: 좋아하는 음식, 싫어하는 음식
- **식단 선호도**: 채식주의, 저탄수화물 등

### 코드 위치:
```464:503:lib/diet/queries.ts
export async function generateAndSaveDietPlan(
  userId: string,
  date: string
): Promise<DailyDietPlan | null> {
  // ... 건강 정보 조회 ...
  const healthProfile = await getUserHealthProfile(userId);
  // ... 건강 정보 검증 ...
}
```

### 왜 필요한가요?
사용자마다 필요한 영양소와 피해야 할 음식이 다르기 때문입니다. 예를 들어:
- 당뇨 환자는 탄수화물을 제한해야 합니다
- 고혈압 환자는 나트륨을 제한해야 합니다
- 알레르기가 있으면 해당 재료가 들어간 음식을 피해야 합니다

---

## 2단계: 레시피 가져오기 📚

### 무엇을 하나요?
식단에 사용할 수 있는 모든 레시피를 가져옵니다.

### 레시피를 어디서 가져오나요?

#### 1️⃣ 데이터베이스 (우선순위 1)
- 우리 시스템에 저장된 레시피들
- 사용자가 직접 추가한 레시피
- 관리자가 등록한 레시피

#### 2️⃣ 식약처 API (우선순위 2)
- 식약처에서 제공하는 공식 레시피 데이터
- 데이터베이스에 레시피가 적을 때 보완용으로 사용

#### 3️⃣ 폴백 레시피 (우선순위 3)
- 데이터베이스와 식약처 API 모두 실패했을 때 사용
- 시스템에 기본으로 내장된 레시피들

### 코드 위치:
```116:242:lib/diet/queries.ts
export async function getRecipesWithNutrition(): Promise<...> {
  // 1. 데이터베이스에서 레시피 조회
  const { data, error } = await supabase
    .from("recipes")
    .select(...)
  
  // 2. 식약처 API 레시피 가져오기 (병합)
  const mfdsRecipes = await fetchMfdsRecipesQuick(500);
  
  // 3. 병합하여 반환
  const mergedRecipes = mergeRecipes(dbRecipes, mfdsRecipes);
}
```

### 레시피에 포함된 정보:
- 레시피 이름, 이미지
- 칼로리, 단백질, 탄수화물, 지방, 나트륨
- 조리 시간, 난이도
- 재료 목록

---

## 3단계: 필터링 🔍

### 무엇을 하나요?
사용자에게 맞지 않는 레시피를 제거합니다.

### 필터링 순서:

#### 1️⃣ 알레르기 필터링 (가장 엄격)
- 사용자가 알레르기가 있는 재료가 들어간 레시피는 **무조건 제외**
- 예: 우유 알레르기가 있으면 → 우유가 들어간 모든 레시피 제외

#### 2️⃣ 질병별 제외 음식 필터링
- 질병에 따라 피해야 할 음식이 데이터베이스에 저장되어 있음
- 예: 당뇨 → 설탕, 꿀 등 고당류 음식 제외
- 예: 통풍 → 퓨린이 많은 해산물, 육류 제외

#### 3️⃣ 영양소 제한 필터링
- 질병에 따라 특정 영양소를 제한해야 함
- 예: 고혈압 → 나트륨 700mg 이상인 레시피 제외
- 예: 신장질환 → 칼륨, 인, 단백질이 많은 레시피 제외

#### 4️⃣ 나트륨 제한 필터링
- 일반적으로도 나트륨이 너무 높은 레시피는 제외

#### 5️⃣ 비선호 재료 필터링
- 사용자가 싫어하는 재료가 들어간 레시피 제외

### 코드 위치:
```1:100:lib/diet/integrated-filter.ts
/**
 * 통합 필터링 파이프라인
 * 필터링 단계:
 * 1. 알레르기 필터링 (엄격한 모드)
 * 2. 질병별 제외 음식 필터링 (데이터베이스 기반)
 * 3. 질병별 영양소 제한 필터링 (칼륨, 인, 퓨린, FODMAPs 등)
 * 4. 나트륨 제한 필터링
 * 5. 선호도 필터링 (비선호 재료 제외)
 */
```

### 필터링 예시:

**사용자 정보:**
- 알레르기: 우유
- 질병: 당뇨
- 비선호: 양파

**레시피 후보:**
1. 김치찌개 (양파 포함) → ❌ 비선호 재료로 제외
2. 크림파스타 (우유 포함) → ❌ 알레르기로 제외
3. 설탕떡볶이 (설탕 많음) → ❌ 당뇨로 제외
4. 된장찌개 (모든 조건 통과) → ✅ 통과

---

## 4단계: 식사별 레시피 선택 🍽️

### 무엇을 하나요?
필터링을 통과한 레시피 중에서 아침, 점심, 저녁, 간식에 맞는 레시피를 선택합니다.

### 식사 구성:

각 식사는 **밥 + 반찬 3개 + 국/찌개**로 구성됩니다.

#### 칼로리 배분:
- **아침**: 하루 칼로리의 30%
- **점심**: 하루 칼로리의 40%
- **저녁**: 하루 칼로리의 25%
- **간식**: 하루 칼로리의 5%

#### 어린이의 경우:
- **아침**: 하루 칼로리의 25%
- **점심**: 하루 칼로리의 35%
- **저녁**: 하루 칼로리의 30%
- **간식**: 하루 칼로리의 10%

### 각 요리별 칼로리 배분:

#### 밥 (40%)
- 흰쌀밥, 현미밥, 잡곡밥 등
- 주간 컨텍스트 고려: 이번 주에 이미 먹은 밥 종류는 제외

#### 반찬 3개 (각 15%, 총 45%)
- 나물, 볶음, 구이 등
- 각 반찬이 목표 칼로리의 15%를 차지하도록 선택
- 주간 컨텍스트 고려: 이번 주에 이미 먹은 반찬은 제외

#### 국/찌개 (15%)
- 된장찌개, 미역국, 계란국 등
- 주간 컨텍스트 고려: 이번 주에 이미 먹은 국은 제외

### 코드 위치:
```517:600:lib/diet/personal-diet-generator.ts
async function selectMealComposition(
  mealType: "breakfast" | "lunch" | "dinner",
  targetCalories: number,
  // ... 기타 파라미터들 ...
): Promise<MealComposition> {
  // 칼로리 배분
  const riceCalories = targetCalories * DISH_CALORIE_RATIOS.rice;
  const sidesCalories = targetCalories * DISH_CALORIE_RATIOS.sides;
  const soupCalories = targetCalories * DISH_CALORIE_RATIOS.soup;

  // 1. 밥 선택
  const rice = await selectDishForMeal("rice", ...);
  
  // 2. 반찬 3개 선택
  for (let i = 0; i < 3; i++) {
    const side = await selectDishForMeal("side", ...);
  }
  
  // 3. 국/찌개 선택
  const soup = await selectDishForMeal("soup", ...);
}
```

### 선택 과정 예시:

**목표: 아침 식사 600kcal**

1. **밥 선택** (240kcal 목표)
   - 후보: 흰쌀밥(200kcal), 현미밥(180kcal), 잡곡밥(220kcal)
   - 선택: 현미밥 (건강하고 칼로리 적합)

2. **반찬 3개 선택** (각 90kcal 목표)
   - 반찬 1: 시금치나물 (85kcal) ✅
   - 반찬 2: 계란찜 (95kcal) ✅
   - 반찬 3: 오이무침 (80kcal) ✅

3. **국 선택** (90kcal 목표)
   - 후보: 미역국(70kcal), 계란국(90kcal)
   - 선택: 계란국 (칼로리 적합)

**최종 아침 식사:**
- 현미밥 + 시금치나물 + 계란찜 + 오이무침 + 계란국
- 총 칼로리: 약 600kcal ✅

---

## 5단계: 데이터베이스에 저장 💾

### 무엇을 하나요?
생성된 식단을 데이터베이스에 저장하여 나중에 볼 수 있도록 합니다.

### 저장되는 정보:
- 날짜
- 식사 종류 (아침/점심/저녁/간식)
- 선택된 레시피 ID
- 영양소 정보 (칼로리, 단백질, 탄수화물, 지방, 나트륨)
- 식사 구성 요약 (밥, 반찬, 국)

### 코드 위치:
```589:650:lib/diet/queries.ts
// 데이터베이스에 저장
const mealTypes: Array<"breakfast" | "lunch" | "dinner" | "snack"> = [
  "breakfast",
  "lunch",
  "dinner",
  "snack",
];

const plansToInsert = mealTypes.map((mealType) => {
  const recipe = recommendations[mealType];
  if (!recipe) return null;
  
  // 데이터베이스에 삽입할 데이터 구성
  return {
    user_id: userId,
    plan_date: date,
    meal_type: mealType,
    recipe_id: recipe.id,
    // ... 영양소 정보 ...
  };
});
```

---

## 🔄 전체 흐름 요약

```
[사용자가 식단 생성 요청]
         ↓
[1단계] 사용자 건강 정보 조회
         ↓
[2단계] 레시피 목록 가져오기
    - 데이터베이스 레시피
    - 식약처 API 레시피
    - 폴백 레시피 (필요시)
         ↓
[3단계] 필터링
    - 알레르기 제외
    - 질병별 제외 음식 제외
    - 영양소 제한 확인
    - 비선호 재료 제외
         ↓
[4단계] 식사별 레시피 선택
    - 아침: 밥 + 반찬 3개 + 국
    - 점심: 밥 + 반찬 3개 + 국
    - 저녁: 밥 + 반찬 3개 + 국
    - 간식: 간식 1개
         ↓
[5단계] 데이터베이스에 저장
         ↓
[완료] 사용자에게 식단 표시
```

---

## 💡 특별한 기능들

### 주간 컨텍스트 (중복 방지)
- 이번 주에 이미 먹은 음식은 제외하여 다양성 확보
- 예: 월요일에 현미밥을 먹었으면 → 화요일에는 다른 밥 종류 선택

### 매크로 목표 추적
- 단백질, 탄수화물, 지방의 목표량을 추적
- 각 식사가 목표에 가까워지도록 레시피 선택

### 일일 영양소 추적 (질병 환자용)
- 질병이 있는 경우, 하루 전체 영양소를 추적
- 예: 신장질환 → 칼륨, 인, 단백질을 하루 전체로 관리

### 프리미엄 기능
- 채식주의자 필터
- 특수 식단 지원

---

## 🎯 핵심 포인트

1. **사용자 맞춤**: 각 사용자의 건강 상태에 맞춰 식단 생성
2. **안전성 우선**: 알레르기와 질병을 최우선으로 고려
3. **영양 균형**: 칼로리와 영양소를 균형있게 배분
4. **다양성**: 주간 컨텍스트를 고려하여 반복 방지
5. **유연성**: 데이터베이스 레시피가 없어도 폴백 시스템으로 동작

---

## 📝 참고 파일

- **메인 진입점**: `lib/diet/queries.ts` - `generateAndSaveDietPlan()`
- **개인 식단 생성**: `lib/diet/personal-diet-generator.ts` - `generatePersonalDiet()`
- **레시피 조회**: `lib/diet/queries.ts` - `getRecipesWithNutrition()`
- **필터링**: `lib/diet/integrated-filter.ts` - `integratedFilterRecipes()`
- **식사 구성 선택**: `lib/diet/personal-diet-generator.ts` - `selectMealComposition()`













