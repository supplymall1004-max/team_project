## 💡 맛의 아카이브 (Flavor Archive) 제품 요구 사항 정의서 (PRD)

사용자께서 제공하신 사업 계획서를 기반으로, **비개발자 초보자**도 이해하기 쉽도록 핵심 기능과 사용자 경험(UX)에 초점을 맞추어 **제품 요구 사항 정의서(PRD, Product Requirements Document)**를 작성했습니다.

이 문서는 제품이 무엇을 해야 하는지, 그리고 왜 필요한지에 대한 청사진 역할을 합니다.

---

### 1. 개요 (Introduction)

| 항목 | 내용 |
| :--- | :--- |
| **제품명** | 맛의 아카이브 (Flavor Archive) |
| **슬로건** | 잊혀진 손맛을 연결하는 디지털 식탁 |
| **버전** | V1.0 (MVP) |
| **작성일** | 2025년 11월 (가상) |
| **제품 비전** | 시대와 세대를 아울러 모든 요리 지식을 통합하고 보존하며, 데이터 기반의 건강한 식생활을 제안하고 요리 창작자의 상업적 활동을 지원하는 세계 최고의 요리 전문 아카이브. |
| **핵심 목표 (MVP 기준)** | 레거시 콘텐츠 뷰어 및 현대 레시피 검색 기능 안정화 및 초기 사용자 5,000명 확보. |

---

### 2. 사용자 정의 (User Persona)

본 서비스의 핵심 사용자는 다음 세 그룹으로 정의합니다.

| 사용자 그룹 | 주요 동기 | 핵심 요구 사항 |
| :--- | :--- | :--- |
| **A. 전통/향토 요리 학습자** | 구전으로만 전해지는 희귀 레시피나 조리법에 대한 정확한 기록 및 지식 습득. | 신뢰성 있는 출처의 고품질 영상 및 문서 콘텐츠 (레거시 아카이브) |
| **B. 건강 관리 식단 사용자** | 본인의 건강 상태(질병, 알레르기)와 목표에 맞는 맞춤형 식단 추천 및 간편한 식자재 구매. | AI 기반 맞춤 식단 추천 및 식자재 연동 (AI 큐레이션) |
| **C. 일반 요리/창작자** | 쉽고 빠르게 따라 할 수 있는 현대적 레시피 검색, 자신의 레시피 공유 및 수익 창출 기회. | 초보자 맞춤 단계별 가이드, UGC 커뮤니티 및 상업화 인증 기회 (현대 레시피 북) |

---

### 3. 기능 요구 사항 (구현 완료 기준)

아래 표는 2025년 11월 기준으로 실제 서비스에 반영된 기능만을 정리한 것입니다. 기획 단계에서 제외되었거나 보류된 기능(B-4, B-5, C-3, C-4 등)은 문서에서 제거했습니다.

#### 3.1. 📜 레거시 아카이브

| ID | 기능명 | 구현 요약 | 세부 사항 |
| :--- | :--- | :--- | :--- |
| **A-1** | 명인 인터뷰 뷰어 | HD 이상 영상 스트리밍과 프리미엄 구독 시 광고 없이 시청. | `components/legacy/legacy-archive-section.tsx`, `legacy-video-cta.tsx` |
| **A-2** | 전문 문서화 기록 | 영상과 연계된 레시피, 도구, 출처를 문서 카드로 제공. | `components/legacy/legacy-archive-client.tsx` |
| **A-3** | 아카이브 분류 검색 | 지역/시대/재료 필터 및 검색어 조합 지원. | `/legacy` 페이지 + 통합 검색 (`app/search`) |
| **A-4** | 대체재료 안내 | 전통 재료 옆에 현대 대체재 및 구입처 안내. | 카드 내 대체 정보 컴포넌트 |

#### 3.2. 🍴 현대 레시피 북

| ID | 기능명 | 구현 요약 | 세부 사항 |
| :--- | :--- | :--- | :--- |
| **B-1** | 단계별 레시피 카드 | 사진/텍스트/영상 단계를 카드로 제공, 타이머·체크리스트 포함. | `components/recipes/recipe-detail-client.tsx`, 타이머/체크리스트 훅 |
| **B-2** | 레시피 업로드 (UGC) | 레시피 작성 시 썸네일 자동 배정, 재료/단계/난이도 필수 입력. | `/recipes/new`, `actions/recipe-create.ts` |
| **B-3** | 커뮤니티 평가 | 별점(0.5 단위), 저작권/불량 신고 기능 구현. | 댓글 기능은 범위에서 제외됨. 신고 데이터는 관리자 뷰에서 확인 가능. |

#### 3.3. 🧠 AI 기반 개인 맞춤 식단

| ID | 기능명 | 구현 요약 | 세부 사항 |
| :--- | :--- | :--- | :--- |
| **C-1** | 건강 정보 입력 | 질병·알레르기·선호 식재료 입력 폼과 데이터 스키마 구축. | `/health/profile`, `health-api` 라우트 |
| **C-2** | AI 맞춤 식단 추천 | 칼로리/3대 영양소 기반 일일 식단 자동 생성, 프리미엄 플래그로 접근 제어. | `lib/diet/recommendation.ts`, `components/diet/daily-diet-view.tsx` |
| **C-5** | 식자재 원클릭 구매 | 추천 식단의 재료 리스트를 외부 마켓 링크로 연결. | `components/diet/meal-card.tsx` |
| **C-6** | 가족 구성원 관리 | `family_members` 테이블, CRUD API, UI 완비. 나이 기반 `is_child` 자동 설정. 구성원 카드에는 “식단 포함/제외” 탭 진입 버튼과 장바구니 설정 진입점이 노출됩니다. | `/health/family` 페이지, `types/family.ts` |
| **C-6.1** | 통합 식단 포함/제외 제어 | 구성원별 `include_in_unified_diet` 토글 및 PATCH 엔드포인트 제공. 탭 UI에서 포함/불포함을 즉시 전환하고, 전환 결과를 장바구니/통합 식단 탭과 실시간 동기화합니다. | `components/family/unified-diet-section.tsx`, `components/family/individual-diet-tabs.tsx` |
| **C-7** | 가족 맞춤 식단 추천 | 개인/통합 식단 동시 생성, 토글 상태 반영, 결과 UI 제공. 장바구니에 재료를 담을 때 구성원 포함 여부·1인분 기준 수량을 반영하여 “+/-”로 증감할 수 있습니다. | `components/family/family-diet-view.tsx`, `/api/family/diet/*`, `components/family/diet-meal-card.tsx` |
| **C-7.1** | AI 맞춤 식단 탭 | “어제의 AI 맞춤 식단” 옆에 사용자 + 가족 이름 탭을 배치하고, 탭마다 On/Off 스위치를 제공해 포함 여부를 제어합니다. On 시 해당 구성원이 칼로리/탄·단·지 합산에 반영되며, 기본값은 전원 포함입니다. 탭 하단 설명란에는 질병/알레르기 및 제외 음식 이유를 문장으로 표기합니다. | `components/diet/daily-diet-view.tsx`, `components/diet/family-diet-tabs.tsx`, `/api/family/diet/[date]?scope=previous` |
| **C-8** | 질병별 제외 음식 관리 | `disease_excluded_foods` 테이블과 필터링 로직 통합. | `lib/diet/family-recommendation.ts` |
| **C-9** | 질병관리청 예방접종/독감 알림 | 질병관리청 공개 RSS/JSON 데이터를 주기적으로 동기화하여 독감 유행 단계와 필수 예방접종 일정을 팝업/알림으로 노출합니다. | `app/api/health/kcdc/*`, Supabase Edge Function, `/components/diet/diet-notification-popup.tsx` |
| **C-10** | 앱 상태 팝업 인프라 | 공통 팝업 컴포넌트와 QA 체크리스트를 정의하고, 웹·앱 WebView 양쪽에서 테스트 가능한 상태 관리/로그 수집을 제공합니다. | `components/diet/diet-notification-popup.tsx`, `components/ui/modal.tsx` |

> **비고:** GI 지수 필터, 영양 리포트, 일일 알림 팝업, 어린이 성장기 식단 등은 현재 제품 범위에서 제외되어 본 문서에서도 제거했습니다. 필요 시 별도 백로그 문서로 관리합니다.

#### 3.4. 🛠 관리자 페이지

| ID | 기능명 | 구현 요약 | 세부 사항 |
| :--- | :--- | :--- | :--- |
| **D-1** | 관리자 콘솔 베타 | `/admin` 경로에 기본 레이아웃을 제공하고, 페이지 내 텍스트/공지/팝업 콘텐츠를 수정하거나 일괄 배포할 수 있는 에디터와 권한 체크를 탑재합니다. | `app/admin/layout.tsx`, `components/admin/*` |

---

### 4. 비기능 요구 사항 (Non-Functional Requirements)

제품의 품질과 안정성을 위한 요구 사항입니다.

| 구분 | 요구 사항 내용 | 대응 전략 |
| :--- | :--- | :--- |
| **성능/속도** | 모든 레시피 검색 결과는 **3초 이내**에 사용자에게 표시되어야 합니다. | 클라우드 기반 미디어 저장소(A-5) 및 CDN 도입. |
| **보안** | 개인 건강 정보(C-1) 및 결제 정보는 **최고 수준으로 암호화**되어 보관되어야 합니다. | 「개인정보보호법」 준수 및 보안 전문가 투입. |
| **접근성** | 모든 페이지는 **모바일 환경(iOS/Android)에서 가장 편리하게** 작동하도록 반응형 웹 디자인을 우선 적용합니다. | 초기 개발 전략: 반응형 디자인 우선 적용. |
| **신뢰성** | AI 추천 결과 및 영양 정보(C-2, C-3, C-4)는 **전문 영양사의 검수(QC)를 통과**해야 합니다. | AI 검증 체계 구축 (6.6 리스크 대응 전략). |
| **법적 준수** | 마켓플레이스 운영 시 모든 판매자는 **식품 영업 신고증**을 제출해야 합니다. | 6.1 식품 위생 및 6.2 전자상거래 법규 준수 의무화. |

---

### 5. 출시 현황 및 후속 로드맵

#### 5.1. 현재 배포된 MVP 범위

| 목표 | 포함된 기능 |
| :--- | :--- |
| **콘텐츠 뷰어 안정화** | A-1, A-2, A-3, A-4 |
| **현대 레시피 경험** | B-1, B-2, B-3(별점·신고) |
| **AI 식단 기초** | C-1, C-2, C-5 |
| **가족 맞춤 기능** | C-6, C-6.1, C-7, C-8 |

#### 5.2. 후속 고려 대상

- GI 지수/저염 필터, 영양 리포트 등 정교화 기능 (과거 C-3, C-4)
- 일일 식단 알림 팝업 및 브라우저 알림 (과거 C-9)
- 어린이 전용 성장기 식단 고도화 (과거 C-10)
- 창작자 상업화/마켓 관련 기능 (과거 B-4, B-5)

위 기능들은 현재 제품 범위에서는 제외되었으며, 재개가 필요할 경우 별도 백로그에서 스펙을 재정의합니다.

---

### 6. 면책 및 법적 고지 (Disclaimer & Legal Notices)

모든 서비스 영역에서 다음 내용을 **명확하게 고지**하고 이용약관에 포함해야 합니다.

* **의료 면책 조항 (6.6):** "본 서비스는 **건강 관리 보조 수단**이며, 전문적인 진료 및 치료 행위를 대신하지 않습니다. 질병 관련 내용은 반드시 의사 또는 전문 영양사와 상담하십시오."
* **통신판매 중개자 고지 (6.4):** 플랫폼은 통신판매 중개자로서, 식품의 위생, 품질, 제조/생산에 대한 **1차적인 법적 책임은 판매자/생산자에게 있음**을 명시합니다.

---

### 7. 기술적 구현 세부사항 (Technical Implementation Details)

#### 7.1. 데이터베이스 스키마

**가족 구성원 테이블 (`family_members`)**
- 각 가족 구성원의 건강 정보를 독립적으로 저장
- `is_child` 플래그: 나이 0-18세 자동 판단
- `user_id`: 가족의 주 사용자 (본인)

**질병별 제외 음식 테이블 (`disease_excluded_foods`)**
- 질병별로 피해야 할 음식 목록 관리
- `excluded_food_type`: 'ingredient' (재료) 또는 'recipe_keyword' (레시피 키워드)
- 초기 데이터: 당뇨/고혈압 제외 음식 목록 사전 등록

**가족 식단 테이블 (`family_diet_plans`)**
- 구성원별 개인 식단 및 통합 식단 저장
- `family_member_id`: NULL이면 통합 식단
- `is_unified`: 통합 식단 여부 플래그

**식단 알림 설정 테이블 (`diet_notification_settings`)**
- 사용자별 알림 설정 관리
- 팝업 알림, 브라우저 알림 활성화/비활성화
- 마지막 알림 날짜 저장 (중복 방지)

#### 7.2. 알고리즘 로직

**질병별 제외 음식 필터링**
1. 사용자의 질병 정보 조회
2. 각 질병별 제외 음식 목록 조회 (데이터베이스)
3. 레시피의 제목, 설명, 재료 목록에서 제외 음식 키워드 검색
4. 매칭되면 해당 레시피 제외

**어린이 식단 추천**
1. 나이 0-18세 자동 감지
2. 영양소 비율 목표 설정 (탄수화물 50%, 단백질 20%, 지방 30%)
3. 식사별 칼로리 분배 (아침 25%, 점심 35%, 저녁 30%, 간식 10%)
4. 영양소 비율을 고려한 레시피 점수 계산 및 선택

**복합 가족 식단 생성**
1. 각 구성원별 개인 식단 생성
   - 구성원의 질병, 알레르기, 선호도 고려
   - 어린이는 성장기 식단 로직 적용
2. 통합 식단 생성
   - 모든 구성원의 제약 조건을 동시에 만족하는 레시피만 선택
   - 평균 칼로리 목표 사용

#### 7.3. 크론 작업

**실행 시간**: 매일 오전 5시 (KST)

**동작 흐름**:
1. 모든 활성 사용자 조회
2. 각 사용자의 가족 구성원 조회
3. 오늘 날짜의 식단 생성
   - 가족 구성원이 있으면: 가족 식단 생성
   - 가족 구성원이 없으면: 본인 건강 정보로 식단 생성 (기존 로직)
4. 데이터베이스에 저장

**구현 방법**:
- Supabase Edge Functions (권장)
- 또는 Next.js API Route + 외부 크론 서비스 (GitHub Actions, Vercel Cron)

#### 7.4. 팝업 알림 동작

**트리거 조건**:
1. 사용자 로그인 상태
2. 오전 5시 이후
3. 오늘 식단이 생성되어 있음
4. 오늘 알림을 아직 보지 않음 (`last_notification_date` 확인)

**표시 방식**:
- 웹사이트 내 팝업 모달 (기본)
- 브라우저 알림 (사용자 권한 허용 시, 선택적)

**사용자 제어**:
- 알림 설정 페이지에서 팝업/브라우저 알림 각각 활성화/비활성화 가능

- **앱 상태 QA 가이드**:
  - 앱(WebView)과 브라우저 모두에서 동일한 팝업 컴포넌트를 사용하며, `console.group('[Popup]')` 로그와 toast 이벤트를 통해 상태 추적
  - QA 체크리스트: 로그인 여부, 오전 5시 이후 조건, 알림 이미 수신 여부, 독감/예방접종 데이터 수신 여부, 닫기/식단 보기 버튼 동작
  - 디자인 요구사항: 최소 320px 가로, 버튼 영역 48px 이상, 접근성 대비 4.5:1 유지

#### 7.5. 이미지 자산 관리 (2025-11 기준)

- **정적 매핑 기반 공급**: `docs/foodjpg.md`에서 Define한 음식명 → 이미지 경로 매핑을 단일 소스로 사용합니다. 모든 경로는 `public/images/food/` 이하의 로컬 자산 또는 카테고리별 SVG 폴백으로 구성됩니다.
- **서버 액션 연동**: `actions/recipe-create.ts`가 `foodImageService.getFoodImage()`를 호출해 레시피 생성 시 자동으로 썸네일을 배정합니다. 실패 시 `lib/food-image-fallback.ts`의 카테고리 이미지가 반환됩니다.
- **클라이언트 폴백**: `getRecipeImageUrlEnhanced()`가 상세/카드/AI 식단 컴포넌트 전반에서 동일한 우선순위(썸네일 → 특정 매핑 → 카테고리 SVG)를 적용해 항상 이미지를 노출합니다.
- **관리 도구**: `components/admin/image-monitoring-dashboard.tsx` + `app/api/cache/stats`를 통해 현재 매핑 상태를 조회할 수 있으며, 더 이상 Pixabay/Gemini 파이프라인에 의존하지 않습니다.
- **남은 작업**: 매핑에 없는 음식은 SVG 폴백을 사용하므로, 장기적으로는 `docs/foodjpg.md` 보강 또는 외부 생성 파이프라인 재도입 여부를 별도 결정해야 합니다.

#### 7.6. 질병관리청 API 연동

- **데이터 소스**: 질병관리청(KCDC)에서 제공하는 공개 RSS/JSON 공지(독감 단계, 예방접종 권장 일정)를 1시간 간격으로 pull
- **서버 구성**:
  - `app/api/health/kcdc/refresh` : Server Action/Route가 `fetchKcdcFeed()`를 호출, 최신 문서를 Supabase 테이블 `kcdc_alerts`에 upsert
  - Supabase Edge Function 스케줄러(05:00 KST)로 자동 호출, 실패 시 Slack/Webhook 알림
  - 캐시 만료: 6시간, 연속 실패 시 마지막 성공 데이터를 유지
- **클라이언트 흐름**:
  - `useKcdcAlerts` 훅이 SSG + revalidateTag(`kcdc-alerts`)를 통해 최신 데이터를 구독
  - 독감/예방접종 정보는 `components/diet/diet-notification-popup.tsx`와 새 예방접종 팝업에 props로 전달
  - 사용자별 설정: `diet_notification_settings`에 “독감 팝업 허용”, “예방접종 리마인더 주기(주간/월간)” 필드 추가 예정

#### 7.7. 관리자 페이지 베이스

- **경로**: `/admin` (Server Component 레이아웃 + Client Shell)
- **인증**: Clerk 역할 기반 가드 (`role === 'admin'`)
- **핵심 모듈**:
  - “페이지 문구 편집” 패널: 주요 카피를 JSON으로 로드/수정 후 버전 관리
  - “팝업 공지” 패널: 팝업 제목/본문/활성 기간 CRUD, 미리보기 모달 제공
  - “알림 로그” 패널: KCDC 연동/팝업 노출 로그 조회
- **확장 포인트**: 이미지 매핑, 식단/구성원 데이터 등 향후 도구 추가를 위한 모듈러 카드 레이아웃

#### 7.8. 어제 AI 식단 가족 탭 동작

- **데이터 계약**
  - `GET /api/family/diet/[date]?scope=previous` 응답에 `memberTabs[]`(id, name, included, healthFlags), `nutrientTotals`(kcal, carb, protein, fat), `exclusionNotes[]` 필드를 포함합니다.
  - `memberTabs[].healthFlags`에는 질병, 알레르기, 사용자 정의 메모가 담겨 탭 하단 설명란에 그대로 노출됩니다.
- **UI 흐름**
  - “전체” 기본 탭 + 구성원별 탭을 가로 스크롤로 배치하고, 토글은 탭 헤더 우측에 배치합니다.
  - On/Off 전환 시 Optimistic 업데이트 → `/api/family/members/[id]/toggle-unified` PATCH 호출 → 실패 시 이전 상태로 롤백하고 토스트/로그를 출력합니다.
  - 탭 콘텐츠에는 선택된 구성원이 먹을 수 있는 메뉴 카드(칼로리, 탄/단/지)를 보여주고, 하단 “특이 사항” 박스에 제외 음식·대체 조리법을 요약합니다.
- **로그 및 접근성**
  - 주요 상호작용마다 `console.group('[FamilyDietTabs]')` + 이벤트명(`tab-change`, `toggle`, `note-expand`)과 payload를 기록합니다.
  - 탭/토글은 모두 키보드 포커스 가능해야 하며, `aria-controls`, `aria-pressed` 속성을 통해 스크린리더가 현재 포함 상태를 읽을 수 있도록 합니다.
  - 포함 인원/영양 합산 패널은 표 구조(`<table>`)를 사용해 스크린리더 친화적으로 제공하고, 합산 기준(온 상태 구성원) 설명을 시각적으로 함께 표기합니다.

---

### 8. 참고 문서

- **상세 구현 계획서**: [implementation-plan-family-diet.md](./implementation-plan-family-diet.md)
- **개발 TODO 리스트**: [TODO.md](./TODO.md)

---

혹시 이 PRD에서 **가장 중요하게 생각하는 기능(A, B, C 중)**이 무엇인지 알려주시면, 해당 기능을 먼저 개발하기 위한 **구체적인 사용자 스토리**를 작성해 드릴 수 있습니다.