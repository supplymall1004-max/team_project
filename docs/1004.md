# AI ë§ì¶¤ ì‹ë‹¨ êµ¬í˜„ ê°€ì´ë“œ

> ì´ ë¬¸ì„œëŠ” "ìš°ë¦¬ì§‘ ê±´ê°•ë°¥ìƒ" í”„ë¡œì íŠ¸ì˜ AI ë§ì¶¤ ì‹ë‹¨ ê¸°ëŠ¥ êµ¬í˜„ ë°©ë²•ì„ ìƒì„¸í•˜ê²Œ ì„¤ëª…í•©ë‹ˆë‹¤.
> ë‹¤ë¥¸ í”„ë¡œì íŠ¸ì—ì„œë„ ìœ ì‚¬í•œ ê¸°ëŠ¥ì„ êµ¬í˜„í•  ìˆ˜ ìˆë„ë¡ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¶€í„° ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê¹Œì§€ ë‹¨ê³„ë³„ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.

## ğŸ“‹ ëª©ì°¨

1. [ì‹œìŠ¤í…œ ê°œìš”](#ì‹œìŠ¤í…œ-ê°œìš”)
2. [ê¸°ìˆ  ìŠ¤íƒ](#ê¸°ìˆ -ìŠ¤íƒ)
3. [ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„](#ë°ì´í„°ë² ì´ìŠ¤-ì„¤ê³„)
4. [êµ¬í˜„ ìˆœì„œ](#êµ¬í˜„-ìˆœì„œ)
5. [í•µì‹¬ ê¸°ëŠ¥ êµ¬í˜„](#í•µì‹¬-ê¸°ëŠ¥-êµ¬í˜„)
6. [API êµ¬ì¡°](#api-êµ¬ì¡°)
7. [UI ì»´í¬ë„ŒíŠ¸](#ui-ì»´í¬ë„ŒíŠ¸)
8. [íŠ¸ëŸ¬ë¸”ìŠˆíŒ…](#íŠ¸ëŸ¬ë¸”ìŠˆíŒ…)

---

## ì‹œìŠ¤í…œ ê°œìš”

### í•µì‹¬ ê¸°ëŠ¥

AI ë§ì¶¤ ì‹ë‹¨ ì‹œìŠ¤í…œì€ ë‹¤ìŒ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤:

1. **ê°œì¸í™”ëœ ì‹ë‹¨ ìƒì„±**: ì‚¬ìš©ìì˜ ê±´ê°• ì •ë³´(ì§ˆë³‘, ì•Œë ˆë¥´ê¸°, í‚¤, ëª¸ë¬´ê²Œ ë“±)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë§ì¶¤ ì‹ë‹¨ ìƒì„±
2. **ê°€ì¡± í†µí•© ì‹ë‹¨**: ê°€ì¡± êµ¬ì„±ì› ëª¨ë‘ê°€ ë¨¹ì„ ìˆ˜ ìˆëŠ” í†µí•© ì‹ë‹¨ ì œê³µ
3. **ì˜ì–‘ ê³„ì‚°**: Harris-Benedict ê³µì‹ ê¸°ë°˜ ì¼ì¼ ê¶Œì¥ ì¹¼ë¡œë¦¬ ìë™ ê³„ì‚°
4. **ì§ˆë³‘ í•„í„°ë§**: ë‹¹ë‡¨, ê³ í˜ˆì••, í†µí’ ë“± ì§ˆë³‘ì— ë”°ë¼ ë¶€ì í•©í•œ ìŒì‹ ìë™ ì œì™¸
5. **ì•Œë ˆë¥´ê¸° ì²´í¬**: ì•Œë ˆë¥´ê¸° ìœ ë°œ ì„±ë¶„ í¬í•¨ ì—¬ë¶€ í™•ì¸ ë° ê²½ê³ 
6. **ë©”ë‰´ ì¤‘ë³µ ë°©ì§€**: í•œ ë‹¬ ê¸°ì¤€ ê°™ì€ ìŒì‹ ë°˜ë³µ ìµœì†Œí™”
7. **ì‹ë‹¨ êµ¬ì¡°í™”**: ë°¥ + ë°˜ì°¬ 3ê°œ + êµ­/ì°Œê°œ í˜•íƒœì˜ í•œì‹ êµ¬ì„±

### ì•„í‚¤í…ì²˜ ê°œìš”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        User Interface                        â”‚
â”‚  (React Components: DailyDietView, MealCompositionCard)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      API Routes                              â”‚
â”‚  /api/family/diet/generate, /api/diet/personal              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Business Logic Layer                        â”‚
â”‚  - FamilyDietGenerator   - PersonalDietGenerator            â”‚
â”‚  - CalorieCalculator     - FoodFiltering                    â”‚
â”‚  - RecipeHistory         - FeatureDescription               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Data Access Layer                           â”‚
â”‚  - Supabase Client (Clerk-authenticated)                    â”‚
â”‚  - External APIs (Edamam Recipe Search)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Database (Supabase)                       â”‚
â”‚  - users, family_members, user_health_profiles              â”‚
â”‚  - diet_plans, disease_excluded_foods                       â”‚
â”‚  - recipe_usage_history                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ê¸°ìˆ  ìŠ¤íƒ

### Frontend

- **Next.js 15.5.6**: React 19 ê¸°ë°˜ í’€ìŠ¤íƒ í”„ë ˆì„ì›Œí¬
- **TypeScript**: íƒ€ì… ì•ˆì •ì„± ë³´ì¥
- **Tailwind CSS v4**: ìŠ¤íƒ€ì¼ë§
- **shadcn/ui**: UI ì»´í¬ë„ŒíŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬
- **lucide-react**: ì•„ì´ì½˜

### Backend

- **Next.js API Routes**: ì„œë²„ ì‚¬ì´ë“œ API
- **Supabase**: PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ + Auth
- **Clerk**: ì‚¬ìš©ì ì¸ì¦ (Supabaseì™€ ë„¤ì´í‹°ë¸Œ í†µí•©)

### External APIs

- **Edamam Recipe Search API**: ë ˆì‹œí”¼ ê²€ìƒ‰ (í˜„ì¬ ì‚¬ìš© ì¤‘)
- **ì‹í’ˆì˜ì•½í’ˆì•ˆì „ì²˜ API**: í•œêµ­ ì‹í’ˆ ë°ì´í„° (LINK íƒ€ì…, ì§ì ‘ ì‹ ì²­ í•„ìš”)

### ì•Œê³ ë¦¬ì¦˜ & ê³„ì‚°

- **Harris-Benedict ê³µì‹**: ê¸°ì´ˆëŒ€ì‚¬ëŸ‰(BMR) ê³„ì‚°
- **í™œë™ ê³„ìˆ˜**: ì¼ì¼ ê¶Œì¥ ì¹¼ë¡œë¦¬ ê³„ì‚°
- **ì§ˆë³‘ ì¡°ì • ê³„ìˆ˜**: ì§ˆë³‘ë³„ ì¹¼ë¡œë¦¬ ì¡°ì • (ë‹¹ë‡¨ 85%, í†µí’ 90% ë“±)

---

## ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„

### 1. ì‚¬ìš©ì í…Œì´ë¸” (`users`)

**ëª©ì **: Clerk ì¸ì¦ê³¼ ì—°ë™ëœ ì‚¬ìš©ì ê¸°ë³¸ ì •ë³´ ì €ì¥

```sql
-- supabase/migrations/setup_schema.sql

CREATE TABLE IF NOT EXISTS public.users (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    clerk_id TEXT NOT NULL UNIQUE,
    name TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_users_clerk_id ON public.users(clerk_id);

-- RLS ë¹„í™œì„±í™” (ê°œë°œ í™˜ê²½)
ALTER TABLE public.users DISABLE ROW LEVEL SECURITY;

-- ê¶Œí•œ ë¶€ì—¬
GRANT ALL ON TABLE public.users TO anon, authenticated, service_role;
```

**í•„ë“œ ì„¤ëª…**:
- `id`: ë‚´ë¶€ ì‚¬ìš© UUID (Primary Key)
- `clerk_id`: Clerk ì¸ì¦ ì‚¬ìš©ì ID (Unique)
- `name`: ì‚¬ìš©ì ì´ë¦„
- `created_at`: ê°€ì… ë‚ ì§œ

---

### 2. ì‚¬ìš©ì ê±´ê°• í”„ë¡œí•„ (`user_health_profiles`)

**ëª©ì **: ì‚¬ìš©ì ë³¸ì¸ì˜ ìƒì„¸ ê±´ê°• ì •ë³´ ì €ì¥ (ê°€ì¡± êµ¬ì„±ì›ê³¼ ë³„ë„)

```sql
-- supabase/migrations/20250124000001_user_health_profile.sql

CREATE TABLE IF NOT EXISTS public.user_health_profiles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE UNIQUE,
  diseases TEXT[] DEFAULT '{}',           -- ['diabetes', 'hypertension', 'gout']
  allergies TEXT[] DEFAULT '{}',          -- ['peanuts', 'shellfish', 'dairy', 'eggs']
  preferred_ingredients TEXT[] DEFAULT '{}',  -- ì„ í˜¸ ì‹ì¬ë£Œ
  disliked_ingredients TEXT[] DEFAULT '{}',   -- ë¹„ì„ í˜¸ ì‹ì¬ë£Œ
  daily_calorie_goal INTEGER,            -- ì¼ì¼ ì¹¼ë¡œë¦¬ ëª©í‘œ (ìˆ˜ë™ ì„¤ì •)
  dietary_preferences TEXT[] DEFAULT '{}', -- ['vegetarian', 'vegan', 'low_carb']
  height_cm INTEGER,                      -- í‚¤ (cm)
  weight_kg DECIMAL(5,2),                 -- ëª¸ë¬´ê²Œ (kg)
  age INTEGER,                            -- ë‚˜ì´
  gender TEXT CHECK (gender IN ('male', 'female', 'other')),
  activity_level TEXT CHECK (activity_level IN 
    ('sedentary', 'light', 'moderate', 'active', 'very_active')),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_user_health_profiles_user_id 
  ON public.user_health_profiles(user_id);

-- updated_at ìë™ ì—…ë°ì´íŠ¸ íŠ¸ë¦¬ê±°
CREATE TRIGGER update_user_health_profiles_updated_at
  BEFORE UPDATE ON public.user_health_profiles
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- RLS ë¹„í™œì„±í™”
ALTER TABLE public.user_health_profiles DISABLE ROW LEVEL SECURITY;

-- ê¶Œí•œ ë¶€ì—¬
GRANT ALL ON TABLE public.user_health_profiles 
  TO anon, authenticated, service_role;
```

**í•„ë“œ ì„¤ëª…**:
- `diseases`: ì§ˆë³‘ ëª©ë¡ (ë°°ì—´) - ì‹ë‹¨ í•„í„°ë§ì— ì‚¬ìš©
- `allergies`: ì•Œë ˆë¥´ê¸° ëª©ë¡ (ë°°ì—´) - ìœ„í—˜ ì„±ë¶„ ì²´í¬ì— ì‚¬ìš©
- `height_cm`, `weight_kg`, `age`: BMR ê³„ì‚°ìš©
- `gender`: ì„±ë³„ë³„ BMR ê³„ì‚° ê³µì‹ ì ìš©
- `activity_level`: í™œë™ ìˆ˜ì¤€ (1.2 ~ 1.9 ê³„ìˆ˜ ì ìš©)
- `daily_calorie_goal`: ìˆ˜ë™ ì„¤ì • ì‹œ ìë™ ê³„ì‚° ë¬´ì‹œ

---

### 3. ê°€ì¡± êµ¬ì„±ì› í…Œì´ë¸” (`family_members`)

**ëª©ì **: ê°€ì¡± êµ¬ì„±ì›ë³„ ê±´ê°• ì •ë³´ ì €ì¥ (ê°€ì¡± í†µí•© ì‹ë‹¨ìš©)

```sql
-- supabase/migrations/20250122000000_family_health_section_a.sql

CREATE TABLE IF NOT EXISTS public.family_members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  birth_date DATE NOT NULL,                -- ìƒë…„ì›”ì¼ (ë‚˜ì´ ê³„ì‚°ìš©)
  gender TEXT CHECK (gender IN ('male', 'female', 'other')),
  relationship TEXT NOT NULL,              -- 'spouse', 'child', 'parent'
  diseases TEXT[] DEFAULT '{}',
  allergies TEXT[] DEFAULT '{}',
  height_cm INTEGER,
  weight_kg DECIMAL(5,2),
  activity_level TEXT CHECK (activity_level IN 
    ('sedentary', 'light', 'moderate', 'active', 'very_active')),
  dietary_preferences TEXT[] DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_family_members_user_id ON public.family_members(user_id);
CREATE INDEX idx_family_members_birth_date ON public.family_members(birth_date);

-- updated_at íŠ¸ë¦¬ê±°
CREATE TRIGGER update_family_members_updated_at
  BEFORE UPDATE ON public.family_members
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- RLS ë¹„í™œì„±í™”
ALTER TABLE public.family_members DISABLE ROW LEVEL SECURITY;

-- ê¶Œí•œ ë¶€ì—¬
GRANT ALL ON TABLE public.family_members TO anon, authenticated, service_role;
```

**í•„ë“œ ì„¤ëª…**:
- `birth_date`: ìƒë…„ì›”ì¼ â†’ ì–´ë¦°ì´ ì—¬ë¶€ íŒë‹¨ (18ì„¸ ë¯¸ë§Œ)
- `relationship`: ê°€ì¡± ê´€ê³„ (UI í‘œì‹œìš©)
- ë‚˜ë¨¸ì§€ í•„ë“œëŠ” `user_health_profiles`ì™€ ë™ì¼

---

### 4. ì§ˆë³‘ë³„ ì œì™¸ ìŒì‹ í…Œì´ë¸” (`disease_excluded_foods`)

**ëª©ì **: ì§ˆë³‘ë³„ë¡œ í”¼í•´ì•¼ í•  ì‹ì¬ë£Œ ë° ìŒì‹ í‚¤ì›Œë“œ ì €ì¥

```sql
-- supabase/migrations/20250122000000_family_health_section_a.sql

CREATE TABLE IF NOT EXISTS public.disease_excluded_foods (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  disease TEXT NOT NULL,                   -- 'diabetes', 'hypertension', 'gout'
  excluded_food_type TEXT NOT NULL CHECK 
    (excluded_food_type IN ('ingredient', 'recipe_keyword')),
  food_name TEXT NOT NULL,                 -- 'ì„¤íƒ•', 'ì†Œê¸ˆ', 'íŠ€ê¹€' ë“±
  reason TEXT,                             -- ì œì™¸ ì´ìœ 
  severity TEXT DEFAULT 'high' CHECK 
    (severity IN ('low', 'medium', 'high')),
  created_at TIMESTAMPTZ DEFAULT now()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_disease_excluded_foods_disease 
  ON public.disease_excluded_foods(disease);
CREATE INDEX idx_disease_excluded_foods_food_name 
  ON public.disease_excluded_foods(food_name);

-- RLS ë¹„í™œì„±í™”
ALTER TABLE public.disease_excluded_foods DISABLE ROW LEVEL SECURITY;

-- ê¶Œí•œ ë¶€ì—¬
GRANT ALL ON TABLE public.disease_excluded_foods 
  TO anon, authenticated, service_role;
```

**í•„ë“œ ì„¤ëª…**:
- `excluded_food_type`:
  - `ingredient`: ì¬ë£Œ ìˆ˜ì¤€ í•„í„°ë§ (ì˜ˆ: "ì„¤íƒ•", "ì†Œê¸ˆ")
  - `recipe_keyword`: ë ˆì‹œí”¼ ì œëª© í•„í„°ë§ (ì˜ˆ: "íŠ€ê¹€", "ë‹¬ë‹¬í•œ")
- `severity`: ì œì™¸ ê°•ë„ (high: ë°˜ë“œì‹œ ì œì™¸, medium: ê¶Œì¥ ì œì™¸, low: ì°¸ê³ )

**ì´ˆê¸° ë°ì´í„° ì˜ˆì‹œ**:

```sql
-- ë‹¹ë‡¨ë³‘ (diabetes)
INSERT INTO disease_excluded_foods 
  (disease, excluded_food_type, food_name, reason, severity)
VALUES
  ('diabetes', 'ingredient', 'ì„¤íƒ•', 'í˜ˆë‹¹ ìƒìŠ¹ì˜ ì£¼ìš” ì›ì¸', 'high'),
  ('diabetes', 'ingredient', 'ê¿€', 'ë‹¹ë¶„ í•¨ëŸ‰ ë†’ìŒ', 'high'),
  ('diabetes', 'ingredient', 'ë¹™ê³¼ë¥˜', 'ë‹¹ë¶„ê³¼ ì¹¼ë¡œë¦¬ ê³¼ë‹¤', 'high'),
  ('diabetes', 'recipe_keyword', 'íŠ€ê¹€', 'ê¸°ë¦„ ì‚¬ìš©ìœ¼ë¡œ ì¹¼ë¡œë¦¬ ë†’ìŒ', 'medium'),
  ('diabetes', 'recipe_keyword', 'ë‹¬ë‹¬í•œ', 'ë‹¹ë¶„ í•¨ëŸ‰ ë†’ìŒ', 'high');

-- ê³ í˜ˆì•• (hypertension)
INSERT INTO disease_excluded_foods 
  (disease, excluded_food_type, food_name, reason, severity)
VALUES
  ('hypertension', 'ingredient', 'ì†Œê¸ˆ', 'ë‚˜íŠ¸ë¥¨ ê³¼ë‹¤ ì„­ì·¨', 'high'),
  ('hypertension', 'ingredient', 'ê°„ì¥', 'ë‚˜íŠ¸ë¥¨ í•¨ëŸ‰ ë†’ìŒ', 'medium'),
  ('hypertension', 'recipe_keyword', 'ì§ ë§›', 'ë‚˜íŠ¸ë¥¨ ê³¼ë‹¤', 'high'),
  ('hypertension', 'ingredient', 'í–„', 'ê°€ê³µ ì‹í’ˆìœ¼ë¡œ ë‚˜íŠ¸ë¥¨ ë†’ìŒ', 'medium');

-- í†µí’ (gout)
INSERT INTO disease_excluded_foods 
  (disease, excluded_food_type, food_name, reason, severity)
VALUES
  ('gout', 'ingredient', 'ë“±í‘¸ë¥¸ìƒì„ ', 'í“¨ë¦° í•¨ëŸ‰ ë†’ìŒ', 'high'),
  ('gout', 'ingredient', 'ë‚´ì¥', 'í“¨ë¦° í•¨ëŸ‰ ë§¤ìš° ë†’ìŒ', 'high'),
  ('gout', 'ingredient', 'ìœ¡ë¥˜', 'í“¨ë¦° í•¨ëŸ‰ ë†’ìŒ', 'medium'),
  ('gout', 'recipe_keyword', 'ë§¥ì£¼', 'ì•Œì½”ì˜¬ ê¸ˆì§€', 'high');
```

> **ì°¸ê³ **: ì‹¤ì œ í”„ë¡œì íŠ¸ì—ëŠ” `20251124050242_expand_disease_excluded_foods.sql`ì— 100+ ê°œì˜ ì´ˆê¸° ë°ì´í„°ê°€ ì‚½ì…ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

---

### 5. ì‹ë‹¨ ê³„íš í…Œì´ë¸” (`diet_plans`)

**ëª©ì **: ìƒì„±ëœ ì‹ë‹¨ ì •ë³´ ì €ì¥ (ê°œì¸ë³„ + í†µí•©)

```sql
-- supabase/migrations/20250126000000_diet_plans.sql

CREATE TABLE IF NOT EXISTS public.diet_plans (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  family_member_id UUID REFERENCES public.family_members(id) ON DELETE CASCADE,
  plan_date DATE NOT NULL,                -- ì‹ë‹¨ ë‚ ì§œ
  meal_type TEXT NOT NULL CHECK 
    (meal_type IN ('breakfast', 'lunch', 'dinner', 'snack')),
  recipe_id UUID REFERENCES public.personal_recipes(id) ON DELETE SET NULL,
  recipe_title TEXT NOT NULL,
  recipe_description TEXT,
  ingredients JSONB,                      -- ì¬ë£Œ ëª©ë¡ (JSON ë°°ì—´)
  instructions TEXT,                      -- ì¡°ë¦¬ ë°©ë²•
  calories INTEGER,
  protein_g DECIMAL(5,2),
  carbs_g DECIMAL(5,2),
  fat_g DECIMAL(5,2),
  is_unified BOOLEAN DEFAULT false,       -- ê°€ì¡± í†µí•© ì‹ë‹¨ ì—¬ë¶€
  created_at TIMESTAMPTZ DEFAULT now()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_diet_plans_user_id ON public.diet_plans(user_id);
CREATE INDEX idx_diet_plans_family_member_id 
  ON public.diet_plans(family_member_id);
CREATE INDEX idx_diet_plans_plan_date ON public.diet_plans(plan_date);
CREATE INDEX idx_diet_plans_user_date ON public.diet_plans(user_id, plan_date);
CREATE INDEX idx_diet_plans_is_unified ON public.diet_plans(is_unified);

-- RLS ë¹„í™œì„±í™”
ALTER TABLE public.diet_plans DISABLE ROW LEVEL SECURITY;

-- ê¶Œí•œ ë¶€ì—¬
GRANT ALL ON TABLE public.diet_plans TO anon, authenticated, service_role;
```

**í•„ë“œ ì„¤ëª…**:
- `family_member_id`: NULLì´ë©´ ì‚¬ìš©ì ë³¸ì¸, ê°’ì´ ìˆìœ¼ë©´ ê°€ì¡± êµ¬ì„±ì› ì‹ë‹¨
- `is_unified`: `true`ì´ë©´ ê°€ì¡± í†µí•© ì‹ë‹¨ (ëª¨ë“  êµ¬ì„±ì›ì´ í•¨ê»˜ ë¨¹ì„ ìˆ˜ ìˆìŒ)
- `ingredients`: JSON ë°°ì—´ í˜•ì‹ `[{"name": "ê°ì", "amount": "200", "unit": "g"}, ...]`

---

### 6. ë ˆì‹œí”¼ ì‚¬ìš© ì´ë ¥ í…Œì´ë¸” (`recipe_usage_history`)

**ëª©ì **: ë©”ë‰´ ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•œ ì‚¬ìš© ì´ë ¥ ì¶”ì 

```sql
-- supabase/migrations/20251124051500_recipe_usage_history.sql

CREATE TABLE IF NOT EXISTS public.recipe_usage_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  family_member_id UUID REFERENCES public.family_members(id) ON DELETE CASCADE,
  recipe_title TEXT NOT NULL,
  recipe_url TEXT,
  meal_type TEXT CHECK (meal_type IN ('breakfast', 'lunch', 'dinner', 'snack')),
  used_date DATE NOT NULL DEFAULT CURRENT_DATE,
  created_at TIMESTAMPTZ DEFAULT now()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_recipe_usage_history_user_id 
  ON public.recipe_usage_history(user_id);
CREATE INDEX idx_recipe_usage_history_family_member_id 
  ON public.recipe_usage_history(family_member_id);
CREATE INDEX idx_recipe_usage_history_used_date 
  ON public.recipe_usage_history(used_date);
CREATE INDEX idx_recipe_usage_history_recipe_title 
  ON public.recipe_usage_history(recipe_title);

-- ë³µí•© ì¸ë±ìŠ¤: ì¤‘ë³µ ì²´í¬ ìµœì í™”
CREATE INDEX idx_recipe_usage_user_title_date 
  ON public.recipe_usage_history(user_id, recipe_title, used_date);

-- RLS ë¹„í™œì„±í™”
ALTER TABLE public.recipe_usage_history DISABLE ROW LEVEL SECURITY;

-- ê¶Œí•œ ë¶€ì—¬
GRANT ALL ON TABLE public.recipe_usage_history 
  TO anon, authenticated, service_role;
```

**ì‚¬ìš© ë°©ì‹**:
1. ë ˆì‹œí”¼ ì„ íƒ ì „: ìµœê·¼ 30ì¼ ë‚´ ì‚¬ìš© ì´ë ¥ ì¡°íšŒ
2. ì´ë¯¸ ì‚¬ìš©ëœ ë ˆì‹œí”¼ëŠ” ìš°ì„ ìˆœìœ„ ë‚®ì¶¤
3. ë ˆì‹œí”¼ ì„ íƒ í›„: ì‚¬ìš© ì´ë ¥ ê¸°ë¡

---

### 7. íŠ¸ë¦¬ê±° í•¨ìˆ˜ (ê³µí†µ)

**ëª©ì **: `updated_at` ìë™ ì—…ë°ì´íŠ¸

```sql
-- supabase/migrations/20250122000000_family_health_section_a.sql

CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END;
$$ language 'plpgsql';
```

**ì ìš© ì˜ˆì‹œ**:

```sql
CREATE TRIGGER update_user_health_profiles_updated_at
  BEFORE UPDATE ON public.user_health_profiles
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

---

## êµ¬í˜„ ìˆœì„œ

### Phase 1: ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • (Day 1)

1. **Supabase í”„ë¡œì íŠ¸ ìƒì„±**
   - [supabase.com](https://supabase.com) ê°€ì… ë° í”„ë¡œì íŠ¸ ìƒì„±
   - ë°ì´í„°ë² ì´ìŠ¤ URL ë° anon key í™•ì¸

2. **ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰**
   ```bash
   # Supabase CLI ì„¤ì¹˜
   npm install -g supabase
   
   # ë¡œê·¸ì¸
   supabase login
   
   # í”„ë¡œì íŠ¸ ì—°ê²°
   supabase link --project-ref <your-project-ref>
   
   # ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ (ìˆœì„œëŒ€ë¡œ)
   supabase db push
   ```

3. **ì´ˆê¸° ë°ì´í„° ì‚½ì…**
   - `disease_excluded_foods` í…Œì´ë¸”ì— ì§ˆë³‘ë³„ ì œì™¸ ìŒì‹ ë°ì´í„° ì‚½ì…
   - Supabase Dashboard â†’ SQL Editorì—ì„œ ì§ì ‘ ì‹¤í–‰ ê°€ëŠ¥

---

### Phase 2: í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (Day 1)

**`.env.local` íŒŒì¼ ìƒì„±**:

```bash
# Clerk Authentication
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
NEXT_PUBLIC_CLERK_SIGN_IN_FALLBACK_REDIRECT_URL=/
NEXT_PUBLIC_CLERK_SIGN_UP_FALLBACK_REDIRECT_URL=/

# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# External APIs
EDAMAM_APP_ID=your_edamam_app_id
EDAMAM_APP_KEY=your_edamam_app_key

# Optional: ì‹ì•½ì²˜ API (í˜„ì¬ ë¯¸ì‚¬ìš©)
# FOOD_SAFETY_RECIPE_API_KEY=your_food_safety_key
```

**API í‚¤ ë°œê¸‰ ë°©ë²•**:

1. **Clerk**: [clerk.com](https://clerk.com) â†’ Dashboard â†’ API Keys
2. **Supabase**: Supabase Dashboard â†’ Settings â†’ API
3. **Edamam**: [developer.edamam.com](https://developer.edamam.com) â†’ Recipe Search API ì‹ ì²­

---

### Phase 3: Supabase í´ë¼ì´ì–¸íŠ¸ ì„¤ì • (Day 1-2)

#### 1. Clerk + Supabase í†µí•© í´ë¼ì´ì–¸íŠ¸

**`lib/supabase/clerk-client.ts`** (Client Componentìš©):

```typescript
/**
 * @file lib/supabase/clerk-client.ts
 * @description Clerk ì¸ì¦ì„ ì‚¬ìš©í•˜ëŠ” Supabase í´ë¼ì´ì–¸íŠ¸ (Client Componentìš©)
 * 
 * Clerk ì„¸ì…˜ í† í°ì„ ì‚¬ìš©í•˜ì—¬ Supabaseì— ì ‘ê·¼í•©ë‹ˆë‹¤.
 * RLS ì •ì±…ì´ auth.jwt()->>'sub'ë¡œ Clerk user IDë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
 */

import { useAuth, useSession } from "@clerk/nextjs";
import { createClient } from "@supabase/supabase-js";
import { useMemo } from "react";

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;

export function useClerkSupabaseClient() {
  const { getToken } = useAuth();
  const { session } = useSession();

  return useMemo(() => {
    return createClient(supabaseUrl, supabaseAnonKey, {
      global: {
        fetch: async (url, options = {}) => {
          const clerkToken = await getToken({
            template: "supabase",
          });

          const headers = new Headers(options?.headers);
          headers.set("Authorization", `Bearer ${clerkToken}`);

          return fetch(url, {
            ...options,
            headers,
          });
        },
      },
    });
  }, [getToken, session]);
}
```

**`lib/supabase/server.ts`** (Server Component/Server Actionìš©):

```typescript
/**
 * @file lib/supabase/server.ts
 * @description Clerk ì¸ì¦ì„ ì‚¬ìš©í•˜ëŠ” Supabase ì„œë²„ í´ë¼ì´ì–¸íŠ¸
 */

import { auth } from "@clerk/nextjs/server";
import { createClient } from "@supabase/supabase-js";

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;

export async function createClerkSupabaseClient() {
  const { getToken } = await auth();
  
  const clerkToken = await getToken({
    template: "supabase",
  });

  return createClient(supabaseUrl, supabaseAnonKey, {
    global: {
      headers: {
        Authorization: `Bearer ${clerkToken}`,
      },
    },
  });
}
```

**`lib/supabase/service-role.ts`** (ê´€ë¦¬ì ê¶Œí•œ ì‘ì—…ìš©):

```typescript
/**
 * @file lib/supabase/service-role.ts
 * @description ê´€ë¦¬ì ê¶Œí•œ Supabase í´ë¼ì´ì–¸íŠ¸ (RLS ìš°íšŒ)
 * 
 * âš ï¸ ì£¼ì˜: ì„œë²„ ì‚¬ì´ë“œì—ì„œë§Œ ì‚¬ìš©, RLS ì •ì±… ìš°íšŒ
 */

import { createClient } from "@supabase/supabase-js";

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;

export const supabaseAdmin = createClient(
  supabaseUrl,
  supabaseServiceKey,
  {
    auth: {
      autoRefreshToken: false,
      persistSession: false,
    },
  }
);
```

---

### Phase 4: íƒ€ì… ì •ì˜ (Day 2)

**`types/family.ts`**:

```typescript
/**
 * @file types/family.ts
 * @description ê°€ì¡± êµ¬ì„±ì› ë° ê±´ê°• ì •ë³´ íƒ€ì… ì •ì˜
 */

export interface FamilyMember {
  id: string;
  user_id: string;
  name: string;
  birth_date: string;                    // 'YYYY-MM-DD' í˜•ì‹
  gender: "male" | "female" | "other";
  relationship: string;
  diseases?: string[];                   // ['diabetes', 'hypertension']
  allergies?: string[];                  // ['peanuts', 'shellfish']
  height_cm?: number;
  weight_kg?: number;
  activity_level?: "sedentary" | "light" | "moderate" | "active" | "very_active";
  dietary_preferences?: string[];
  created_at: string;
  updated_at: string;
}

export interface UserHealthProfile {
  id: string;
  user_id: string;
  diseases?: string[];
  allergies?: string[];
  preferred_ingredients?: string[];
  disliked_ingredients?: string[];
  daily_calorie_goal?: number;
  dietary_preferences?: string[];
  height_cm?: number;
  weight_kg?: number;
  age?: number;
  gender?: "male" | "female" | "other";
  activity_level?: "sedentary" | "light" | "moderate" | "active" | "very_active";
  created_at: string;
  updated_at: string;
}

export type Disease = "diabetes" | "hypertension" | "gout" | "kidney_disease" | "hyperlipidemia" | "obesity";

export interface DiseaseExcludedFood {
  id: string;
  disease: string;
  excluded_food_type: "ingredient" | "recipe_keyword";
  food_name: string;
  reason?: string;
  severity: "low" | "medium" | "high";
  created_at: string;
}
```

**`types/recipe.ts`**:

```typescript
/**
 * @file types/recipe.ts
 * @description ë ˆì‹œí”¼ ë° ì‹ë‹¨ ê´€ë ¨ íƒ€ì… ì •ì˜
 */

// ì¬ë£Œ ì •ë³´
export interface Ingredient {
  name: string;
  amount: string;
  unit: string;
}

// ì˜ì–‘ ì •ë³´
export interface RecipeNutrition {
  calories: number;
  protein: number;
  carbs: number;
  fat: number;
  sodium?: number;
  fiber?: number;
}

// ë ˆì‹œí”¼ ìƒì„¸ ì •ë³´
export interface RecipeDetail {
  id?: string;
  title: string;
  description?: string;
  image?: string;
  url?: string;
  source?: string;
  ingredients: Ingredient[];
  instructions?: string;
  nutrition: RecipeNutrition;
  cuisineType?: string[];
  mealType?: string[];
  dishType?: string[];
  tags?: string[];
}

// ì‹ì‚¬ êµ¬ì„± (ë°¥ + ë°˜ì°¬ 3ê°œ + êµ­/ì°Œê°œ)
export interface MealComposition {
  rice?: RecipeDetail;                   // ë°¥
  sides: RecipeDetail[];                 // ë°˜ì°¬ (3ê°œ)
  soup?: RecipeDetail;                   // êµ­ ë˜ëŠ” ì°Œê°œ
  totalNutrition: RecipeNutrition;       // ì´ ì˜ì–‘ ì •ë³´
}

// í•˜ë£¨ ì‹ë‹¨ ê³„íš
export interface DailyDietPlan {
  date: string;                          // 'YYYY-MM-DD'
  breakfast: MealComposition | RecipeDetail;
  lunch: MealComposition | RecipeDetail;
  dinner: MealComposition | RecipeDetail;
  snack?: RecipeDetail;
  totalNutrition: RecipeNutrition;
}

// ê°€ì¡± ì‹ë‹¨ ê³„íš (ê°œì¸ë³„ + í†µí•©)
export interface FamilyDietPlan {
  date: string;
  individualPlans: {
    [memberId: string]: DailyDietPlan;  // ê°€ì¡± êµ¬ì„±ì›ë³„ ì‹ë‹¨
  };
  unifiedPlan?: DailyDietPlan;          // ê°€ì¡± í†µí•© ì‹ë‹¨
}

// ì‹ì‚¬ íƒ€ì…
export type MealType = "breakfast" | "lunch" | "dinner" | "snack";
```

---

### Phase 5: ì¹¼ë¡œë¦¬ ê³„ì‚° ë¡œì§ (Day 3)

**`lib/diet/calorie-calculator.ts`**:

```typescript
/**
 * @file lib/diet/calorie-calculator.ts
 * @description Harris-Benedict ê³µì‹ ê¸°ë°˜ ì¼ì¼ ê¶Œì¥ ì¹¼ë¡œë¦¬ ê³„ì‚°
 * 
 * ê³µì‹:
 * - ë‚¨ì„± BMR = 88.362 + (13.397 Ã— ì²´ì¤‘kg) + (4.799 Ã— í‚¤cm) - (5.677 Ã— ë‚˜ì´)
 * - ì—¬ì„± BMR = 447.593 + (9.247 Ã— ì²´ì¤‘kg) + (3.098 Ã— í‚¤cm) - (4.330 Ã— ë‚˜ì´)
 * - ì¼ì¼ ì¹¼ë¡œë¦¬ = BMR Ã— í™œë™ ê³„ìˆ˜ Ã— ì§ˆë³‘ ì¡°ì • ê³„ìˆ˜
 */

import type { Disease } from "@/types/family";

// ì§ˆë³‘ë³„ ì¹¼ë¡œë¦¬ ì¡°ì • ê³„ìˆ˜
const DISEASE_CALORIE_MULTIPLIERS: Record<string, number> = {
  diabetes: 0.85,         // ë‹¹ë‡¨: ê¸°ë³¸ ì¹¼ë¡œë¦¬ì˜ 85% (ì €ì¹¼ë¡œë¦¬)
  hypertension: 1.0,      // ê³ í˜ˆì••: ìœ ì§€ (ë‚˜íŠ¸ë¥¨ë§Œ ì œí•œ)
  gout: 0.9,              // í†µí’: 90%
  kidney_disease: 0.9,    // ì‹ ì¥ì§ˆí™˜: 90%
  hyperlipidemia: 0.85,   // ê³ ì§€í˜ˆì¦: 85%
  obesity: 0.8,           // ë¹„ë§Œ: 80%
};

// í™œë™ ìˆ˜ì¤€ë³„ ì¹¼ë¡œë¦¬ ê³„ìˆ˜
const ACTIVITY_MULTIPLIERS = {
  sedentary: 1.2,         // ì£¼ë¡œ ì•‰ì•„ì„œ ìƒí™œ
  light: 1.375,           // ê°€ë²¼ìš´ ìš´ë™ (ì£¼ 1-3íšŒ)
  moderate: 1.55,         // ì¤‘ê°„ ê°•ë„ ìš´ë™ (ì£¼ 3-5íšŒ)
  active: 1.725,          // í™œë°œí•œ ìš´ë™ (ì£¼ 6-7íšŒ)
  very_active: 1.9,       // ë§¤ìš° í™œë°œí•œ ìš´ë™ (í•˜ë£¨ 2íšŒ)
};

/**
 * ê¸°ì´ˆëŒ€ì‚¬ëŸ‰(BMR) ê³„ì‚° - Harris-Benedict ê³µì‹
 */
function calculateBMR(
  gender: "male" | "female" | "other",
  weight_kg: number,
  height_cm: number,
  age: number
): number {
  if (gender === "male") {
    return 88.362 + 13.397 * weight_kg + 4.799 * height_cm - 5.677 * age;
  } else {
    // ì—¬ì„± ë° ê¸°íƒ€
    return 447.593 + 9.247 * weight_kg + 3.098 * height_cm - 4.33 * age;
  }
}

/**
 * ì¼ì¼ ê¶Œì¥ ì¹¼ë¡œë¦¬ ê³„ì‚°
 * 
 * @example
 * const calories = calculateDailyCalories({
 *   gender: "female",
 *   weight_kg: 60,
 *   height_cm: 160,
 *   age: 40,
 *   activity_level: "sedentary",
 *   diseases: ["diabetes"]
 * });
 * // ê²°ê³¼: ì•½ 1360 kcal (1600 Ã— 0.85)
 */
export function calculateDailyCalories(params: {
  gender: "male" | "female" | "other";
  weight_kg: number;
  height_cm: number;
  age: number;
  activity_level: keyof typeof ACTIVITY_MULTIPLIERS;
  diseases?: string[];
}): number {
  console.group("ğŸ”¢ ì¼ì¼ ê¶Œì¥ ì¹¼ë¡œë¦¬ ê³„ì‚°");

  // 1. ê¸°ì´ˆëŒ€ì‚¬ëŸ‰ ê³„ì‚°
  const bmr = calculateBMR(
    params.gender,
    params.weight_kg,
    params.height_cm,
    params.age
  );
  console.log(`ê¸°ì´ˆëŒ€ì‚¬ëŸ‰ (BMR): ${Math.round(bmr)}kcal`);

  // 2. í™œë™ ìˆ˜ì¤€ ë°˜ì˜
  const activityMultiplier = ACTIVITY_MULTIPLIERS[params.activity_level] || 1.2;
  let dailyCalories = bmr * activityMultiplier;
  console.log(`í™œë™ ìˆ˜ì¤€ (${params.activity_level}): Ã—${activityMultiplier} = ${Math.round(dailyCalories)}kcal`);

  // 3. ì§ˆë³‘ë³„ ì¡°ì • (ê°€ì¥ ë‚®ì€ ê³„ìˆ˜ ì ìš©)
  if (params.diseases && params.diseases.length > 0) {
    console.log(`ì§ˆë³‘ ì •ë³´: ${params.diseases.join(", ")}`);
    
    let lowestMultiplier = 1.0;
    let appliedDisease = "";
    
    for (const disease of params.diseases) {
      const multiplier = DISEASE_CALORIE_MULTIPLIERS[disease];
      if (multiplier && multiplier < lowestMultiplier) {
        lowestMultiplier = multiplier;
        appliedDisease = disease;
      }
    }
    
    if (appliedDisease) {
      console.log(`ì§ˆë³‘ ì¡°ì • (${appliedDisease}): Ã—${lowestMultiplier}`);
      dailyCalories *= lowestMultiplier;
    }
  }

  const result = Math.round(dailyCalories);
  console.log(`âœ… ìµœì¢… ê¶Œì¥ ì¹¼ë¡œë¦¬: ${result}kcal`);
  console.groupEnd();

  return result;
}

/**
 * ì§ˆë³‘ë³„ ë‚˜íŠ¸ë¥¨ ì œí•œ (mg/ì¼)
 */
export const DISEASE_SODIUM_LIMITS: Record<string, number> = {
  hypertension: 2000,      // ê³ í˜ˆì••: 2000mg ì´í•˜
  kidney_disease: 1500,    // ì‹ ì¥ì§ˆí™˜: 1500mg ì´í•˜
  heart_disease: 1500,     // ì‹¬ì¥ì§ˆí™˜: 1500mg ì´í•˜
};

/**
 * ì €ì—¼ì‹ ì—¬ë¶€ íŒë‹¨
 */
export function requiresLowSodiumDiet(diseases?: string[]): boolean {
  if (!diseases || diseases.length === 0) {
    return false;
  }

  const lowSodiumDiseases = ["hypertension", "kidney_disease", "heart_disease"];
  return diseases.some(d => lowSodiumDiseases.includes(d));
}
```

**ì‚¬ìš© ì˜ˆì‹œ**:

```typescript
// 40ì„¸ ì—¬ì„±, 160cm, 60kg, ì•‰ì•„ì„œ ìƒí™œ, ë‹¹ë‡¨ í™˜ì
const calories = calculateDailyCalories({
  gender: "female",
  weight_kg: 60,
  height_cm: 160,
  age: 40,
  activity_level: "sedentary",
  diseases: ["diabetes"]
});

console.log(calories);  // ì•½ 1360 kcal

// ê³„ì‚° ê³¼ì •:
// 1. BMR = 447.593 + (9.247 Ã— 60) + (3.098 Ã— 160) - (4.33 Ã— 40) = 1325 kcal
// 2. í™œë™ ê³„ìˆ˜ ì ìš© = 1325 Ã— 1.2 = 1590 kcal
// 3. ë‹¹ë‡¨ ì¡°ì • = 1590 Ã— 0.85 = 1352 kcal â‰ˆ 1360 kcal
```

---

### Phase 6: ìŒì‹ í•„í„°ë§ ë¡œì§ (Day 3-4)

**`lib/diet/food-filtering.ts`**:

```typescript
/**
 * @file lib/diet/food-filtering.ts
 * @description ì§ˆë³‘ ë° ì•Œë ˆë¥´ê¸° ê¸°ë°˜ ìŒì‹ í•„í„°ë§
 */

import { createClerkSupabaseClient } from "@/lib/supabase/server";
import type { DiseaseExcludedFood } from "@/types/family";
import type { RecipeDetail } from "@/types/recipe";

/**
 * ì§ˆë³‘ë³„ ì œì™¸ ìŒì‹ ì¡°íšŒ
 */
export async function getExcludedFoods(diseases: string[]): Promise<DiseaseExcludedFood[]> {
  if (diseases.length === 0) return [];

  const supabase = await createClerkSupabaseClient();
  
  const { data, error } = await supabase
    .from("disease_excluded_foods")
    .select("*")
    .in("disease", diseases);

  if (error) {
    console.error("ì œì™¸ ìŒì‹ ì¡°íšŒ ì‹¤íŒ¨:", error);
    return [];
  }

  return data || [];
}

/**
 * ë ˆì‹œí”¼ê°€ ì œì™¸ ìŒì‹ì„ í¬í•¨í•˜ëŠ”ì§€ í™•ì¸
 * 
 * @returns true: ë ˆì‹œí”¼ ì‚¬ìš© ê°€ëŠ¥, false: ì œì™¸í•´ì•¼ í•¨
 */
export function isRecipeCompatible(
  recipe: RecipeDetail,
  excludedFoods: DiseaseExcludedFood[]
): boolean {
  if (excludedFoods.length === 0) return true;

  console.group(`ğŸ” ë ˆì‹œí”¼ í˜¸í™˜ì„± ì²´í¬: ${recipe.title}`);

  // 1. ì¬ë£Œ ìˆ˜ì¤€ í•„í„°ë§
  const excludedIngredients = excludedFoods
    .filter(f => f.excluded_food_type === "ingredient")
    .map(f => f.food_name.toLowerCase());

  for (const ingredient of recipe.ingredients) {
    const ingredientName = ingredient.name.toLowerCase();
    
    for (const excluded of excludedIngredients) {
      if (ingredientName.includes(excluded)) {
        console.warn(`âŒ ì œì™¸ ì¬ë£Œ ë°œê²¬: ${ingredient.name} (ì œì™¸: ${excluded})`);
        console.groupEnd();
        return false;
      }
    }
  }

  // 2. ë ˆì‹œí”¼ ì œëª© í‚¤ì›Œë“œ í•„í„°ë§
  const excludedKeywords = excludedFoods
    .filter(f => f.excluded_food_type === "recipe_keyword")
    .map(f => f.food_name.toLowerCase());

  const recipeTitle = recipe.title.toLowerCase();
  
  for (const keyword of excludedKeywords) {
    if (recipeTitle.includes(keyword)) {
      console.warn(`âŒ ì œì™¸ í‚¤ì›Œë“œ ë°œê²¬: ${keyword} (ë ˆì‹œí”¼: ${recipe.title})`);
      console.groupEnd();
      return false;
    }
  }

  console.log(`âœ… í˜¸í™˜ ê°€ëŠ¥í•œ ë ˆì‹œí”¼`);
  console.groupEnd();
  return true;
}

/**
 * ë ˆì‹œí”¼ ëª©ë¡ì—ì„œ í˜¸í™˜ ê°€ëŠ¥í•œ ë ˆì‹œí”¼ë§Œ í•„í„°ë§
 */
export function filterCompatibleRecipes(
  recipes: RecipeDetail[],
  diseases: string[],
  excludedFoods: DiseaseExcludedFood[]
): RecipeDetail[] {
  console.group(`ğŸ” ë ˆì‹œí”¼ í•„í„°ë§: ì´ ${recipes.length}ê°œ`);
  
  const compatible = recipes.filter(recipe => 
    isRecipeCompatible(recipe, excludedFoods)
  );
  
  console.log(`âœ… í˜¸í™˜ ê°€ëŠ¥: ${compatible.length}ê°œ`);
  console.groupEnd();
  
  return compatible;
}

/**
 * ë‚˜íŠ¸ë¥¨ ì œí•œ í™•ì¸
 */
export function checkSodiumLimit(
  recipe: RecipeDetail,
  diseases?: string[]
): boolean {
  if (!diseases || diseases.length === 0) return true;
  if (!recipe.nutrition.sodium) return true;  // ë‚˜íŠ¸ë¥¨ ì •ë³´ ì—†ìœ¼ë©´ í†µê³¼

  const lowSodiumDiseases = ["hypertension", "kidney_disease", "heart_disease"];
  const hasLowSodiumRequirement = diseases.some(d => lowSodiumDiseases.includes(d));

  if (hasLowSodiumRequirement) {
    // ì‹ì‚¬ë‹¹ ë‚˜íŠ¸ë¥¨ ê¶Œì¥ëŸ‰: ì•½ 600-700mg (í•˜ë£¨ 2000mg Ã· 3ì‹)
    const MAX_SODIUM_PER_MEAL = 700;
    
    if (recipe.nutrition.sodium > MAX_SODIUM_PER_MEAL) {
      console.warn(`âš ï¸ ë‚˜íŠ¸ë¥¨ ê³¼ë‹¤: ${recipe.nutrition.sodium}mg (ê¶Œì¥: ${MAX_SODIUM_PER_MEAL}mg ì´í•˜)`);
      return false;
    }
  }

  return true;
}
```

---

### Phase 7: ë ˆì‹œí”¼ ê²€ìƒ‰ í†µí•© (Day 4-5)

**`lib/recipes/unified-recipe-service.ts`**:

```typescript
/**
 * @file lib/recipes/unified-recipe-service.ts
 * @description ì™¸ë¶€ APIë¥¼ í†µí•œ ë ˆì‹œí”¼ ê²€ìƒ‰
 * 
 * í˜„ì¬ Edamam API ì‚¬ìš© ì¤‘
 * í–¥í›„ ì‹ì•½ì²˜ API ì¶”ê°€ ì˜ˆì •
 */

import type { RecipeDetail, RecipeNutrition, Ingredient } from "@/types/recipe";

// Edamam API ì‘ë‹µ íƒ€ì…
interface EdamamRecipe {
  recipe: {
    label: string;
    image?: string;
    url?: string;
    source?: string;
    ingredientLines?: string[];
    ingredients?: Array<{
      text: string;
      quantity?: number;
      measure?: string;
      food?: string;
    }>;
    calories?: number;
    totalNutrients?: {
      ENERC_KCAL?: { quantity: number };
      PROCNT?: { quantity: number };
      CHOCDF?: { quantity: number };
      FAT?: { quantity: number };
      NA?: { quantity: number };
      FIBTG?: { quantity: number };
    };
    cuisineType?: string[];
    mealType?: string[];
    dishType?: string[];
  };
}

interface EdamamSearchResponse {
  hits?: EdamamRecipe[];
}

/**
 * Edamam APIë¡œ ë ˆì‹œí”¼ ê²€ìƒ‰
 */
export async function searchRecipes(options: {
  query?: string;
  mealType?: string;
  cuisineType?: string;
  dishType?: string;
  diet?: string[];
  health?: string[];
  excludedIngredients?: string[];
  calories?: string;
  maxResults?: number;
}): Promise<{ recipes: RecipeDetail[]; source: string }> {
  const {
    query,
    mealType,
    cuisineType,
    dishType,
    diet,
    health,
    excludedIngredients,
    calories,
    maxResults = 20,
  } = options;

  console.group("ğŸ” Edamam ë ˆì‹œí”¼ ê²€ìƒ‰");
  console.log("ê²€ìƒ‰ ì˜µì…˜:", options);

  // API í‚¤ í™•ì¸
  const appId = process.env.EDAMAM_APP_ID;
  const appKey = process.env.EDAMAM_APP_KEY;

  if (!appId || !appKey) {
    console.error("âŒ Edamam API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    console.groupEnd();
    return { recipes: [], source: "edamam" };
  }

  // URL íŒŒë¼ë¯¸í„° êµ¬ì„±
  const params = new URLSearchParams({
    type: "public",
    app_id: appId,
    app_key: appKey,
    to: maxResults.toString(),
  });

  // ì¿¼ë¦¬
  if (query) {
    params.append("q", query);
  }

  // ì‹ì‚¬ íƒ€ì…
  if (mealType) {
    params.append("mealType", mealType);
  }

  // ìš”ë¦¬ ìœ í˜•
  if (cuisineType) {
    params.append("cuisineType", cuisineType);
  }

  // ìš”ë¦¬ ë¶„ë¥˜
  if (dishType) {
    params.append("dishType", dishType);
  }

  // ì‹ë‹¨ íƒ€ì… (ì±„ì‹, ì €íƒ„ìˆ˜í™”ë¬¼ ë“±)
  if (diet && diet.length > 0) {
    diet.forEach(d => params.append("diet", d));
  }

  // ê±´ê°• ë¼ë²¨ (ì €ì—¼, ì €ë‹¹ ë“±)
  if (health && health.length > 0) {
    health.forEach(h => params.append("health", h));
  }

  // ì œì™¸ ì¬ë£Œ
  if (excludedIngredients && excludedIngredients.length > 0) {
    excludedIngredients.forEach(ingredient => {
      params.append("excluded", ingredient);
    });
  }

  // ì¹¼ë¡œë¦¬ ë²”ìœ„
  if (calories) {
    params.append("calories", calories);
  }

  // API ìš”ì²­
  const url = `https://api.edamam.com/api/recipes/v2?${params.toString()}`;
  
  try {
    const response = await fetch(url);
    
    if (!response.ok) {
      console.error(`âŒ Edamam API ì˜¤ë¥˜: ${response.status} ${response.statusText}`);
      console.groupEnd();
      return { recipes: [], source: "edamam" };
    }

    const data: EdamamSearchResponse = await response.json();
    
    if (!data.hits || data.hits.length === 0) {
      console.warn("âš ï¸ ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ");
      console.groupEnd();
      return { recipes: [], source: "edamam" };
    }

    // RecipeDetail í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    const recipes: RecipeDetail[] = data.hits.map(hit => 
      convertEdamamToRecipeDetail(hit)
    );

    console.log(`âœ… ${recipes.length}ê°œ ë ˆì‹œí”¼ ê²€ìƒ‰ ì™„ë£Œ`);
    console.groupEnd();

    return { recipes, source: "edamam" };
  } catch (error) {
    console.error("âŒ Edamam API ìš”ì²­ ì‹¤íŒ¨:", error);
    console.groupEnd();
    return { recipes: [], source: "edamam" };
  }
}

/**
 * Edamam ë ˆì‹œí”¼ë¥¼ RecipeDetailë¡œ ë³€í™˜
 */
function convertEdamamToRecipeDetail(hit: EdamamRecipe): RecipeDetail {
  const recipe = hit.recipe;

  // ì¬ë£Œ íŒŒì‹±
  const ingredients: Ingredient[] = (recipe.ingredients || []).map(ing => ({
    name: ing.food || ing.text || "",
    amount: ing.quantity?.toString() || "",
    unit: ing.measure || "",
  }));

  // ì˜ì–‘ ì •ë³´ ì¶”ì¶œ
  const nutrition: RecipeNutrition = {
    calories: Math.round(recipe.totalNutrients?.ENERC_KCAL?.quantity || recipe.calories || 0),
    protein: Math.round(recipe.totalNutrients?.PROCNT?.quantity || 0),
    carbs: Math.round(recipe.totalNutrients?.CHOCDF?.quantity || 0),
    fat: Math.round(recipe.totalNutrients?.FAT?.quantity || 0),
    sodium: Math.round(recipe.totalNutrients?.NA?.quantity || 0),
    fiber: Math.round(recipe.totalNutrients?.FIBTG?.quantity || 0),
  };

  return {
    title: recipe.label,
    description: recipe.ingredientLines?.join(", ").substring(0, 100),
    image: recipe.image,
    url: recipe.url,
    source: recipe.source,
    ingredients,
    nutrition,
    cuisineType: recipe.cuisineType,
    mealType: recipe.mealType,
    dishType: recipe.dishType,
  };
}
```

---

### Phase 8: í´ë°± ë ˆì‹œí”¼ (Day 5)

ì™¸ë¶€ APIê°€ ì‹¤íŒ¨í•˜ê±°ë‚˜ ê²°ê³¼ê°€ ì—†ì„ ë•Œ ì‚¬ìš©í•  í•œì‹ ê¸°ë³¸ ë ˆì‹œí”¼ë¥¼ ì¤€ë¹„í•©ë‹ˆë‹¤.

**`lib/recipes/fallback-recipes.ts`**:

```typescript
/**
 * @file lib/recipes/fallback-recipes.ts
 * @description API ì‹¤íŒ¨ ì‹œ ì‚¬ìš©í•  í•œì‹ ê¸°ë³¸ ë ˆì‹œí”¼
 */

import type { RecipeDetail, RecipeNutrition } from "@/types/recipe";

interface FallbackRecipe {
  name: string;
  calories: number;
  protein: number;
  carbs: number;
  fat: number;
  sodium: number;
  description: string;
}

// í´ë°± ë ˆì‹œí”¼ ë°ì´í„°
export const FALLBACK_RECIPES = {
  breakfast: {
    rice: [
      { name: "í°ë°¥", calories: 300, protein: 5, carbs: 65, fat: 1, sodium: 0, description: "ë°¥ 1ê³µê¸°" },
      { name: "ì¡ê³¡ë°¥", calories: 280, protein: 6, carbs: 60, fat: 2, sodium: 0, description: "ì¡ê³¡ ì„ì€ ë°¥" },
      { name: "í˜„ë¯¸ë°¥", calories: 260, protein: 6, carbs: 58, fat: 2, sodium: 0, description: "í˜„ë¯¸ 100% ë°¥" },
    ],
    side: [
      { name: "ê¹€ì¹˜", calories: 20, protein: 1, carbs: 3, fat: 0, sodium: 500, description: "ë°°ì¶”ê¹€ì¹˜" },
      { name: "ê¹ë‘ê¸°", calories: 25, protein: 1, carbs: 4, fat: 0, sodium: 450, description: "ë¬´ ê¹ë‘ê¸°" },
      { name: "ê³„ë€ì°œ", calories: 80, protein: 7, carbs: 2, fat: 5, sodium: 200, description: "ë¶€ë“œëŸ¬ìš´ ê³„ë€ì°œ" },
      { name: "ë‚˜ë¬¼ë¬´ì¹¨", calories: 40, protein: 2, carbs: 5, fat: 1, sodium: 300, description: "ì‹œê¸ˆì¹˜ë‚˜ë¬¼" },
    ],
    soup: [
      { name: "ëœì¥êµ­", calories: 60, protein: 4, carbs: 6, fat: 2, sodium: 900, description: "ë‘ë¶€ ëœì¥êµ­" },
      { name: "ë¯¸ì—­êµ­", calories: 50, protein: 3, carbs: 5, fat: 2, sodium: 800, description: "ë§‘ì€ ë¯¸ì—­êµ­" },
      { name: "ì½©ë‚˜ë¬¼êµ­", calories: 45, protein: 4, carbs: 4, fat: 1, sodium: 700, description: "ì‹œì›í•œ ì½©ë‚˜ë¬¼êµ­" },
    ],
  },
  lunch: {
    rice: [
      { name: "í°ë°¥", calories: 300, protein: 5, carbs: 65, fat: 1, sodium: 0, description: "ë°¥ 1ê³µê¸°" },
      { name: "ì¡ê³¡ë°¥", calories: 280, protein: 6, carbs: 60, fat: 2, sodium: 0, description: "ì¡ê³¡ ì„ì€ ë°¥" },
      { name: "í˜„ë¯¸ë°¥", calories: 260, protein: 6, carbs: 58, fat: 2, sodium: 0, description: "í˜„ë¯¸ 100% ë°¥" },
      { name: "ë³´ë¦¬ë°¥", calories: 270, protein: 6, carbs: 59, fat: 1, sodium: 0, description: "ë³´ë¦¬ ì„ì€ ë°¥" },
    ],
    side: [
      { name: "ì‹œê¸ˆì¹˜ë‚˜ë¬¼", calories: 45, protein: 3, carbs: 5, fat: 1, sodium: 350, description: "ì‹œê¸ˆì¹˜ ë¬´ì¹¨" },
      { name: "ì½©ë‚˜ë¬¼ë¬´ì¹¨", calories: 35, protein: 3, carbs: 4, fat: 1, sodium: 300, description: "ì½©ë‚˜ë¬¼ ë¬´ì¹¨" },
      { name: "ë©¸ì¹˜ë³¶ìŒ", calories: 120, protein: 10, carbs: 8, fat: 6, sodium: 600, description: "ë©¸ì¹˜ ì¡°ë¦¼" },
      { name: "ê¹€êµ¬ì´", calories: 15, protein: 2, carbs: 1, fat: 0, sodium: 200, description: "êµ¬ìš´ ê¹€" },
    ],
    soup: [
      { name: "ê°ˆë¹„íƒ•", calories: 250, protein: 20, carbs: 10, fat: 15, sodium: 1000, description: "ì†Œê°ˆë¹„íƒ•" },
      { name: "ìœ¡ê°œì¥", calories: 200, protein: 15, carbs: 12, fat: 10, sodium: 1200, description: "ë§¤ìš´ ìœ¡ê°œì¥" },
    ],
    stew: [
      { name: "ê¹€ì¹˜ì°Œê°œ", calories: 200, protein: 15, carbs: 12, fat: 10, sodium: 1300, description: "ë¼ì§€ê³ ê¸° ê¹€ì¹˜ì°Œê°œ" },
      { name: "ìˆœë‘ë¶€ì°Œê°œ", calories: 180, protein: 12, carbs: 10, fat: 10, sodium: 1100, description: "ìˆœë‘ë¶€ì°Œê°œ" },
      { name: "ëœì¥ì°Œê°œ", calories: 150, protein: 10, carbs: 12, fat: 8, sodium: 1200, description: "ì±„ì†Œ ëœì¥ì°Œê°œ" },
    ],
  },
  dinner: {
    rice: [
      { name: "í°ë°¥", calories: 300, protein: 5, carbs: 65, fat: 1, sodium: 0, description: "ë°¥ 1ê³µê¸°" },
      { name: "ì¡ê³¡ë°¥", calories: 280, protein: 6, carbs: 60, fat: 2, sodium: 0, description: "ì¡ê³¡ ì„ì€ ë°¥" },
      { name: "í˜„ë¯¸ë°¥", calories: 260, protein: 6, carbs: 58, fat: 2, sodium: 0, description: "í˜„ë¯¸ 100% ë°¥" },
      { name: "ë³´ë¦¬ë°¥", calories: 270, protein: 6, carbs: 59, fat: 1, sodium: 0, description: "ë³´ë¦¬ ì„ì€ ë°¥" },
      { name: "ê·€ë¦¬ë°¥", calories: 265, protein: 7, carbs: 57, fat: 2, sodium: 0, description: "ê·€ë¦¬ ì„ì€ ë°¥" },
    ],
    side: [
      { name: "ë¬´ìƒì±„", calories: 25, protein: 1, carbs: 4, fat: 0, sodium: 350, description: "ë¬´ë¥¼ ì±„ ì°ì–´ ë¬´ì¹œ ë°˜ì°¬" },
      { name: "ì˜¤ì´ë¬´ì¹¨", calories: 20, protein: 1, carbs: 3, fat: 0, sodium: 300, description: "ì˜¤ì´ë¥¼ ë¬´ì¹œ ë°˜ì°¬" },
      { name: "íŒŒê¹€ì¹˜", calories: 30, protein: 1, carbs: 5, fat: 0, sodium: 500, description: "íŒŒë¡œ ë§Œë“  ê¹€ì¹˜" },
      { name: "ë‘ë¶€ê¹€ì¹˜", calories: 150, protein: 12, carbs: 8, fat: 8, sodium: 800, description: "ë‘ë¶€ì™€ ê¹€ì¹˜" },
      { name: "ë¬´ë§ë­ì´ë¬´ì¹¨", calories: 40, protein: 2, carbs: 6, fat: 1, sodium: 400, description: "ë§ë¦° ë¬´ ë¬´ì¹¨" },
    ],
    soup: [
      { name: "ë¶ì–´êµ­", calories: 80, protein: 12, carbs: 5, fat: 2, sodium: 900, description: "ë¶ì–´ ë„£ì€ êµ­" },
      { name: "ì‹œë˜ê¸°êµ­", calories: 70, protein: 5, carbs: 8, fat: 2, sodium: 800, description: "ì‹œë˜ê¸° êµ­" },
      { name: "ì½©ë‚˜ë¬¼êµ­", calories: 45, protein: 4, carbs: 4, fat: 1, sodium: 700, description: "ì‹œì›í•œ ì½©ë‚˜ë¬¼êµ­" },
      { name: "ë¬´êµ­", calories: 40, protein: 2, carbs: 6, fat: 1, sodium: 650, description: "ë§‘ì€ ë¬´êµ­" },
    ],
    stew: [
      { name: "ë¶€ëŒ€ì°Œê°œ", calories: 350, protein: 20, carbs: 30, fat: 15, sodium: 1500, description: "í–„ê³¼ ì†Œì‹œì§€ ì°Œê°œ" },
      { name: "ì²­êµ­ì¥ì°Œê°œ", calories: 200, protein: 15, carbs: 15, fat: 10, sodium: 1400, description: "ì²­êµ­ì¥ ì°Œê°œ" },
      { name: "ê¹€ì¹˜ì°Œê°œ", calories: 200, protein: 15, carbs: 12, fat: 10, sodium: 1300, description: "ê¹€ì¹˜ì°Œê°œ" },
    ],
  },
} as const;

/**
 * í´ë°± ë ˆì‹œí”¼ë¥¼ RecipeDetailë¡œ ë³€í™˜
 * 
 * @param excludeNames - ì œì™¸í•  ë ˆì‹œí”¼ ì´ë¦„ ëª©ë¡ (ì¤‘ë³µ ë°©ì§€ìš©)
 */
export function generateFallbackRecipe(
  mealType: "breakfast" | "lunch" | "dinner",
  dishType: "rice" | "side" | "soup" | "stew",
  targetCalories: number,
  excludeNames: string[] = []
): RecipeDetail {
  // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ë ˆì‹œí”¼ ëª©ë¡
  let recipes = FALLBACK_RECIPES[mealType]?.[dishType] || [];
  
  if (recipes.length === 0) {
    return createDefaultFallbackRecipe(mealType, dishType, targetCalories);
  }

  // ì œì™¸ ëª©ë¡ í•„í„°ë§
  if (excludeNames.length > 0) {
    const filtered = recipes.filter(r => !excludeNames.includes(r.name));
    if (filtered.length > 0) {
      recipes = filtered;
    }
  }

  // ëª©í‘œ ì¹¼ë¡œë¦¬ì— ê°€ì¥ ê°€ê¹Œìš´ ë ˆì‹œí”¼ ì„ íƒ
  const selected = recipes.reduce((closest, current) => {
    const closestDiff = Math.abs(closest.calories - targetCalories);
    const currentDiff = Math.abs(current.calories - targetCalories);
    return currentDiff < closestDiff ? current : closest;
  });

  return convertToRecipeDetail(selected, mealType, dishType);
}

/**
 * FallbackRecipe â†’ RecipeDetail ë³€í™˜
 */
function convertToRecipeDetail(
  recipe: FallbackRecipe,
  mealType: string,
  dishType: string
): RecipeDetail {
  return {
    title: recipe.name,
    description: recipe.description,
    ingredients: [
      {
        name: recipe.name,
        amount: "1",
        unit: "ì¸ë¶„",
      },
    ],
    nutrition: {
      calories: recipe.calories,
      protein: recipe.protein,
      carbs: recipe.carbs,
      fat: recipe.fat,
      sodium: recipe.sodium,
    },
    mealType: [mealType],
    dishType: [dishType],
    tags: ["í•œì‹", "ê¸°ë³¸"],
  };
}

/**
 * ê¸°ë³¸ í´ë°± ë ˆì‹œí”¼ ìƒì„± (ë°ì´í„°ê°€ ì—†ì„ ë•Œ)
 */
function createDefaultFallbackRecipe(
  mealType: string,
  dishType: string,
  targetCalories: number
): RecipeDetail {
  const defaultName = dishType === "rice" ? "í°ë°¥" :
                     dishType === "side" ? "ë‚˜ë¬¼" :
                     dishType === "soup" ? "ë§‘ì€ êµ­" : "ì°Œê°œ";
  
  return {
    title: defaultName,
    description: `ê¸°ë³¸ ${defaultName}`,
    ingredients: [
      { name: defaultName, amount: "1", unit: "ì¸ë¶„" },
    ],
    nutrition: {
      calories: targetCalories,
      protein: Math.round(targetCalories * 0.15 / 4),
      carbs: Math.round(targetCalories * 0.55 / 4),
      fat: Math.round(targetCalories * 0.30 / 9),
      sodium: 500,
    },
    mealType: [mealType],
    dishType: [dishType],
  };
}
```

---

## í•µì‹¬ ê¸°ëŠ¥ êµ¬í˜„

ì´ì œ ì‹¤ì œ ì‹ë‹¨ ìƒì„± ë¡œì§ì„ êµ¬í˜„í•©ë‹ˆë‹¤.

### 1. ê°œì¸ ì‹ë‹¨ ìƒì„±ê¸°

**`lib/diet/personal-diet-generator.ts`** (í•µì‹¬ íŒŒì¼):

```typescript
/**
 * @file lib/diet/personal-diet-generator.ts
 * @description ê°œì¸ ë§ì¶¤ ì‹ë‹¨ ìƒì„± (ê°€ì¡± êµ¬ì„±ì› ì—†ëŠ” ê²½ìš°)
 * 
 * ì£¼ìš” ê¸°ëŠ¥:
 * 1. ì¹¼ë¡œë¦¬ ê³„ì‚° (Harris-Benedict ê³µì‹)
 * 2. ì§ˆë³‘/ì•Œë ˆë¥´ê¸° í•„í„°ë§
 * 3. ì‹ì‚¬ êµ¬ì„± (ë°¥ + ë°˜ì°¬ 3ê°œ + êµ­/ì°Œê°œ)
 * 4. ë©”ë‰´ ì¤‘ë³µ ë°©ì§€
 */

import { calculateDailyCalories } from "./calorie-calculator";
import { getExcludedFoods, filterCompatibleRecipes, checkSodiumLimit } from "./food-filtering";
import { searchRecipes } from "@/lib/recipes/unified-recipe-service";
import { generateFallbackRecipe } from "@/lib/recipes/fallback-recipes";
import { checkRecentlyUsed, trackRecipeUsage } from "./recipe-history";
import type { UserHealthProfile } from "@/types/family";
import type { DailyDietPlan, MealComposition, RecipeDetail, MealType } from "@/types/recipe";

/**
 * ê°œì¸ ì‹ë‹¨ ìƒì„± ë©”ì¸ í•¨ìˆ˜
 */
export async function generatePersonalDiet(
  healthProfile: UserHealthProfile,
  date: string
): Promise<DailyDietPlan> {
  console.group("ğŸ½ï¸ ê°œì¸ ì‹ë‹¨ ìƒì„± ì‹œì‘");
  console.log("ë‚ ì§œ:", date);
  console.log("ê±´ê°• í”„ë¡œí•„:", healthProfile);

  // 1. ì¼ì¼ ì¹¼ë¡œë¦¬ ëª©í‘œ ê³„ì‚°
  const dailyCalories = healthProfile.daily_calorie_goal || 
    calculateDailyCalories({
      gender: healthProfile.gender || "other",
      weight_kg: healthProfile.weight_kg || 65,
      height_cm: healthProfile.height_cm || 170,
      age: healthProfile.age || 30,
      activity_level: healthProfile.activity_level || "sedentary",
      diseases: healthProfile.diseases,
    });

  console.log(`âœ… ì¼ì¼ ì¹¼ë¡œë¦¬: ${dailyCalories}kcal`);

  // 2. ì‹ì‚¬ë³„ ì¹¼ë¡œë¦¬ ë¶„ë°°
  const mealCalories = {
    breakfast: Math.round(dailyCalories * 0.30),  // 30%
    lunch: Math.round(dailyCalories * 0.35),      // 35%
    dinner: Math.round(dailyCalories * 0.30),     // 30%
    snack: Math.round(dailyCalories * 0.05),      // 5%
  };

  console.log("ì‹ì‚¬ë³„ ì¹¼ë¡œë¦¬:", mealCalories);

  // 3. ê° ì‹ì‚¬ êµ¬ì„± ìƒì„±
  const breakfast = await selectMealComposition(
    "breakfast",
    healthProfile,
    mealCalories.breakfast
  );

  const lunch = await selectMealComposition(
    "lunch",
    healthProfile,
    mealCalories.lunch
  );

  const dinner = await selectMealComposition(
    "dinner",
    healthProfile,
    mealCalories.dinner
  );

  const snack = await selectRecipeForMeal(
    "snack",
    healthProfile,
    mealCalories.snack
  );

  // 4. ì´ ì˜ì–‘ ì •ë³´ ê³„ì‚°
  const totalNutrition = calculateTotalNutrition({
    breakfast,
    lunch,
    dinner,
    snack,
  });

  console.log("âœ… ì‹ë‹¨ ìƒì„± ì™„ë£Œ");
  console.log("ì´ ì˜ì–‘ ì •ë³´:", totalNutrition);
  console.groupEnd();

  return {
    date,
    breakfast,
    lunch,
    dinner,
    snack,
    totalNutrition,
  };
}

/**
 * ì‹ì‚¬ êµ¬ì„± ìƒì„± (ë°¥ + ë°˜ì°¬ 3ê°œ + êµ­/ì°Œê°œ)
 * 
 * ì¹¼ë¡œë¦¬ ë¶„ë°°:
 * - ë°¥: 35%
 * - ë°˜ì°¬: 45% (3ê°œ, ê° 15%)
 * - êµ­/ì°Œê°œ: 20%
 */
async function selectMealComposition(
  mealType: MealType,
  healthProfile: UserHealthProfile,
  targetCalories: number
): Promise<MealComposition> {
  console.group(`ğŸ“Š ${mealType} êµ¬ì„± ìƒì„± (ëª©í‘œ: ${targetCalories}kcal)`);

  const sideCount = 3;
  const riceCalories = Math.round(targetCalories * 0.35);
  const sideCalories = Math.round(targetCalories * 0.45);
  const soupCalories = Math.round(targetCalories * 0.20);
  const sideCaloriesPerDish = Math.round(sideCalories / sideCount);

  console.log(`ì¹¼ë¡œë¦¬ ë¶„ë°°: ë°¥ ${riceCalories} + ë°˜ì°¬ ${sideCalories} (${sideCount}ê°œ) + êµ­/ì°Œê°œ ${soupCalories}`);

  // 1. ë°¥ ì„ íƒ
  const rice = await selectDishForMeal(
    mealType,
    "rice",
    healthProfile,
    riceCalories
  );

  // 2. ë°˜ì°¬ ì„ íƒ (3ê°œ, ì¤‘ë³µ ë°©ì§€)
  const sides: RecipeDetail[] = [];
  const usedSideNames: string[] = [];
  
  for (let i = 0; i < sideCount; i++) {
    const side = await selectDishForMeal(
      mealType,
      "side",
      healthProfile,
      sideCaloriesPerDish,
      usedSideNames
    );
    if (side) {
      sides.push(side);
      usedSideNames.push(side.title);
    }
  }

  // 3. êµ­/ì°Œê°œ ì„ íƒ
  const soup = await selectDishForMeal(
    mealType,
    "soup",
    healthProfile,
    soupCalories
  ) || await selectDishForMeal(
    mealType,
    "stew",
    healthProfile,
    soupCalories
  );

  // 4. ì´ ì˜ì–‘ ì •ë³´ ê³„ì‚°
  const totalNutrition = calculateMealNutrition({ rice, sides, soup });

  console.log(`âœ… ${mealType} êµ¬ì„± ì™„ë£Œ (ì´ ${totalNutrition.calories}kcal)`);
  console.groupEnd();

  return {
    rice,
    sides,
    soup,
    totalNutrition,
  };
}

/**
 * íŠ¹ì • ìš”ë¦¬ ì¢…ë¥˜ ì„ íƒ (ë°¥/ë°˜ì°¬/êµ­/ì°Œê°œ)
 */
async function selectDishForMeal(
  mealType: MealType,
  dishType: "rice" | "side" | "soup" | "stew",
  healthProfile: UserHealthProfile,
  targetCalories: number,
  excludeNames: string[] = []
): Promise<RecipeDetail | undefined> {
  console.group(`ğŸ” ${dishType} ì„ íƒ (${targetCalories}kcal)`);

  // ë°¥ì€ API ê²€ìƒ‰ ì—†ì´ í´ë°± ë ˆì‹œí”¼ ì‚¬ìš©
  if (dishType === "rice") {
    console.log("ğŸš ë°¥ì€ í´ë°± ë ˆì‹œí”¼ ì‚¬ìš©");
    const fallback = generateFallbackRecipe(
      mealType === "breakfast" ? "breakfast" :
      mealType === "lunch" ? "lunch" : "dinner",
      dishType,
      targetCalories,
      excludeNames
    );
    console.groupEnd();
    return fallback;
  }

  // 1. ì§ˆë³‘ë³„ ì œì™¸ ìŒì‹ ì¡°íšŒ
  const excludedFoods = await getExcludedFoods(healthProfile.diseases || []);

  // 2. ë ˆì‹œí”¼ ê²€ìƒ‰ (Edamam API)
  const searchOptions: any = {
    mealType,
    dishType,
    cuisineType: "korean",  // í•œì‹ ìš°ì„ 
    calories: `${targetCalories * 0.7}-${targetCalories * 1.3}`,  // Â±30%
    maxResults: 20,
  };

  // ì œì™¸ ì¬ë£Œ (ê³ ì‹¬ë„ ì œì™¸ ìŒì‹ë§Œ)
  const highSeverityExclusions = excludedFoods
    .filter(f => f.severity === "high" && f.excluded_food_type === "ingredient")
    .map(f => f.food_name);
  
  if (highSeverityExclusions.length > 0) {
    searchOptions.excludedIngredients = highSeverityExclusions;
  }

  const result = await searchRecipes(searchOptions);

  // 3. ê²€ìƒ‰ ì‹¤íŒ¨ ì‹œ í´ë°± ì‚¬ìš©
  if (!result.recipes || result.recipes.length === 0) {
    console.warn(`âš ï¸ ë ˆì‹œí”¼ ê²€ìƒ‰ ì‹¤íŒ¨ - í´ë°± ì‚¬ìš©`);
    const fallback = generateFallbackRecipe(
      mealType === "breakfast" ? "breakfast" :
      mealType === "lunch" ? "lunch" : "dinner",
      dishType,
      targetCalories,
      excludeNames
    );
    console.groupEnd();
    return fallback;
  }

  // 4. í˜¸í™˜ ê°€ëŠ¥í•œ ë ˆì‹œí”¼ í•„í„°ë§
  let compatibleRecipes = filterCompatibleRecipes(
    result.recipes,
    healthProfile.diseases || [],
    excludedFoods
  );

  // ë‚˜íŠ¸ë¥¨ ì œí•œ í•„í„°ë§
  compatibleRecipes = compatibleRecipes.filter(recipe =>
    checkSodiumLimit(recipe, healthProfile.diseases)
  );

  // ìµœê·¼ ì‚¬ìš© ì´ë ¥ ì œì™¸
  for (const recipe of compatibleRecipes) {
    const recentlyUsed = await checkRecentlyUsed(
      healthProfile.user_id,
      recipe.title,
      30  // 30ì¼ ì´ë‚´
    );
    
    if (recentlyUsed) {
      console.log(`â° ìµœê·¼ ì‚¬ìš©ëœ ë ˆì‹œí”¼: ${recipe.title}`);
      // ìš°ì„ ìˆœìœ„ë§Œ ë‚®ì¶”ê³  ì™„ì „íˆ ì œì™¸í•˜ì§€ëŠ” ì•ŠìŒ
    }
  }

  // 5. í˜¸í™˜ ë ˆì‹œí”¼ ì—†ìœ¼ë©´ í´ë°± ì‚¬ìš©
  if (compatibleRecipes.length === 0) {
    console.warn(`âš ï¸ í˜¸í™˜ ë ˆì‹œí”¼ ì—†ìŒ - í´ë°± ì‚¬ìš©`);
    const fallback = generateFallbackRecipe(
      mealType === "breakfast" ? "breakfast" :
      mealType === "lunch" ? "lunch" : "dinner",
      dishType,
      targetCalories,
      excludeNames
    );
    console.groupEnd();
    return fallback;
  }

  // 6. ëª©í‘œ ì¹¼ë¡œë¦¬ì— ê°€ì¥ ê°€ê¹Œìš´ ë ˆì‹œí”¼ ì„ íƒ
  const selected = compatibleRecipes.reduce((closest, current) => {
    const closestDiff = Math.abs(closest.nutrition.calories - targetCalories);
    const currentDiff = Math.abs(current.nutrition.calories - targetCalories);
    return currentDiff < closestDiff ? current : closest;
  });

  console.log(`âœ… ì„ íƒ: ${selected.title} (${selected.nutrition.calories}kcal)`);
  
  // 7. ì‚¬ìš© ì´ë ¥ ê¸°ë¡
  await trackRecipeUsage(healthProfile.user_id, selected.title, mealType);
  
  console.groupEnd();
  return selected;
}

/**
 * ê°„ì‹ ì„ íƒ (ë‹¨ì¼ ë ˆì‹œí”¼)
 */
async function selectRecipeForMeal(
  mealType: MealType,
  healthProfile: UserHealthProfile,
  targetCalories: number
): Promise<RecipeDetail | undefined> {
  // ê°„ì‹ì€ ì„ íƒ ì‚¬í•­
  if (targetCalories < 50) {
    return undefined;
  }

  // ê°„ì‹ ë ˆì‹œí”¼ ê²€ìƒ‰ (ê³¼ì¼, ê²¬ê³¼ë¥˜ ë“±)
  const result = await searchRecipes({
    mealType: "snack",
    dishType: "dessert",
    calories: `${targetCalories * 0.7}-${targetCalories * 1.3}`,
    maxResults: 10,
  });

  if (!result.recipes || result.recipes.length === 0) {
    return undefined;
  }

  // ì•Œë ˆë¥´ê¸° ì²´í¬
  const excludedFoods = await getExcludedFoods(healthProfile.diseases || []);
  const compatible = filterCompatibleRecipes(
    result.recipes,
    healthProfile.diseases || [],
    excludedFoods
  );

  if (compatible.length === 0) {
    return undefined;
  }

  return compatible[0];
}

/**
 * ì‹ì‚¬ ì˜ì–‘ ì •ë³´ ê³„ì‚°
 */
function calculateMealNutrition(meal: {
  rice?: RecipeDetail;
  sides: RecipeDetail[];
  soup?: RecipeDetail;
}): RecipeNutrition {
  let totalCalories = 0;
  let totalProtein = 0;
  let totalCarbs = 0;
  let totalFat = 0;
  let totalSodium = 0;

  if (meal.rice) {
    totalCalories += meal.rice.nutrition.calories;
    totalProtein += meal.rice.nutrition.protein;
    totalCarbs += meal.rice.nutrition.carbs;
    totalFat += meal.rice.nutrition.fat;
    totalSodium += meal.rice.nutrition.sodium || 0;
  }

  for (const side of meal.sides) {
    totalCalories += side.nutrition.calories;
    totalProtein += side.nutrition.protein;
    totalCarbs += side.nutrition.carbs;
    totalFat += side.nutrition.fat;
    totalSodium += side.nutrition.sodium || 0;
  }

  if (meal.soup) {
    totalCalories += meal.soup.nutrition.calories;
    totalProtein += meal.soup.nutrition.protein;
    totalCarbs += meal.soup.nutrition.carbs;
    totalFat += meal.soup.nutrition.fat;
    totalSodium += meal.soup.nutrition.sodium || 0;
  }

  return {
    calories: Math.round(totalCalories),
    protein: Math.round(totalProtein),
    carbs: Math.round(totalCarbs),
    fat: Math.round(totalFat),
    sodium: Math.round(totalSodium),
  };
}

/**
 * í•˜ë£¨ ì´ ì˜ì–‘ ì •ë³´ ê³„ì‚°
 */
function calculateTotalNutrition(meals: {
  breakfast?: MealComposition;
  lunch?: MealComposition;
  dinner?: MealComposition;
  snack?: RecipeDetail;
}): RecipeNutrition {
  let total = {
    calories: 0,
    protein: 0,
    carbs: 0,
    fat: 0,
    sodium: 0,
  };

  if (meals.breakfast) {
    total.calories += meals.breakfast.totalNutrition.calories;
    total.protein += meals.breakfast.totalNutrition.protein;
    total.carbs += meals.breakfast.totalNutrition.carbs;
    total.fat += meals.breakfast.totalNutrition.fat;
    total.sodium += meals.breakfast.totalNutrition.sodium || 0;
  }

  if (meals.lunch) {
    total.calories += meals.lunch.totalNutrition.calories;
    total.protein += meals.lunch.totalNutrition.protein;
    total.carbs += meals.lunch.totalNutrition.carbs;
    total.fat += meals.lunch.totalNutrition.fat;
    total.sodium += meals.lunch.totalNutrition.sodium || 0;
  }

  if (meals.dinner) {
    total.calories += meals.dinner.totalNutrition.calories;
    total.protein += meals.dinner.totalNutrition.protein;
    total.carbs += meals.dinner.totalNutrition.carbs;
    total.fat += meals.dinner.totalNutrition.fat;
    total.sodium += meals.dinner.totalNutrition.sodium || 0;
  }

  if (meals.snack) {
    total.calories += meals.snack.nutrition.calories;
    total.protein += meals.snack.nutrition.protein;
    total.carbs += meals.snack.nutrition.carbs;
    total.fat += meals.snack.nutrition.fat;
    total.sodium += meals.snack.nutrition.sodium || 0;
  }

  return total;
}
```

---

---

### 2. ë ˆì‹œí”¼ ì‚¬ìš© ì´ë ¥ ê´€ë¦¬

ë©”ë‰´ ì¤‘ë³µì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ì‚¬ìš© ì´ë ¥ì„ ì¶”ì í•©ë‹ˆë‹¤.

**`lib/diet/recipe-history.ts`**:

```typescript
/**
 * @file lib/diet/recipe-history.ts
 * @description ë ˆì‹œí”¼ ì‚¬ìš© ì´ë ¥ ê´€ë¦¬ (ë©”ë‰´ ì¤‘ë³µ ë°©ì§€)
 */

import { createClerkSupabaseClient } from "@/lib/supabase/server";

/**
 * ìµœê·¼ ì‚¬ìš© ì´ë ¥ í™•ì¸
 * 
 * @param userId - ì‚¬ìš©ì ID
 * @param recipeTitle - ë ˆì‹œí”¼ ì œëª©
 * @param withinDays - í™•ì¸í•  ê¸°ê°„ (ì¼ ìˆ˜)
 * @returns true: ìµœê·¼ì— ì‚¬ìš©ë¨, false: ì‚¬ìš© ì•ˆ ë¨
 */
export async function checkRecentlyUsed(
  userId: string,
  recipeTitle: string,
  withinDays: number = 30
): Promise<boolean> {
  const supabase = await createClerkSupabaseClient();
  
  const cutoffDate = new Date();
  cutoffDate.setDate(cutoffDate.getDate() - withinDays);
  
  const { data, error } = await supabase
    .from("recipe_usage_history")
    .select("id")
    .eq("user_id", userId)
    .eq("recipe_title", recipeTitle)
    .gte("used_date", cutoffDate.toISOString().split("T")[0])
    .limit(1);

  if (error) {
    console.error("ë ˆì‹œí”¼ ì´ë ¥ í™•ì¸ ì‹¤íŒ¨:", error);
    return false;
  }

  return (data && data.length > 0);
}

/**
 * ë ˆì‹œí”¼ ì‚¬ìš© ì´ë ¥ ê¸°ë¡
 */
export async function trackRecipeUsage(
  userId: string,
  recipeTitle: string,
  mealType: string,
  recipUrl?: string,
  familyMemberId?: string
): Promise<void> {
  const supabase = await createClerkSupabaseClient();
  
  const { error } = await supabase
    .from("recipe_usage_history")
    .insert({
      user_id: userId,
      family_member_id: familyMemberId,
      recipe_title: recipeTitle,
      recipe_url: recipeUrl,
      meal_type: mealType,
      used_date: new Date().toISOString().split("T")[0],
    });

  if (error) {
    console.error("ë ˆì‹œí”¼ ì´ë ¥ ê¸°ë¡ ì‹¤íŒ¨:", error);
  }
}

/**
 * ì˜¤ë˜ëœ ì´ë ¥ ì •ë¦¬ (90ì¼ ì´ìƒ)
 */
export async function cleanOldHistory(days: number = 90): Promise<void> {
  const supabase = await createClerkSupabaseClient();
  
  const cutoffDate = new Date();
  cutoffDate.setDate(cutoffDate.getDate() - days);
  
  const { error } = await supabase
    .from("recipe_usage_history")
    .delete()
    .lt("used_date", cutoffDate.toISOString().split("T")[0]);

  if (error) {
    console.error("ì´ë ¥ ì •ë¦¬ ì‹¤íŒ¨:", error);
  } else {
    console.log(`âœ… ${days}ì¼ ì´ìƒ ëœ ì´ë ¥ ì •ë¦¬ ì™„ë£Œ`);
  }
}
```

---

### 3. ê°€ì¡± í†µí•© ì‹ë‹¨ ìƒì„±ê¸°

**`lib/diet/family-diet-generator.ts`** (ì¼ë¶€):

```typescript
/**
 * @file lib/diet/family-diet-generator.ts
 * @description ê°€ì¡± í†µí•© ì‹ë‹¨ ìƒì„± (ëª¨ë“  êµ¬ì„±ì›ì´ í•¨ê»˜ ë¨¹ì„ ìˆ˜ ìˆëŠ” ì‹ë‹¨)
 * 
 * ê°œì¸ ì‹ë‹¨ê³¼ì˜ ì°¨ì´ì :
 * - ëª¨ë“  ê°€ì¡± êµ¬ì„±ì›ì˜ ì§ˆë³‘/ì•Œë ˆë¥´ê¸°ë¥¼ í†µí•©í•˜ì—¬ í•„í„°ë§
 * - í‰ê·  ì¹¼ë¡œë¦¬ ëª©í‘œ ì‚¬ìš©
 * - ì–´ë¦°ì´ í¬í•¨ ì—¬ë¶€ì— ë”°ë¼ ì¡°ì •
 */

import type { FamilyMember } from "@/types/family";
import type { FamilyDietPlan, DailyDietPlan } from "@/types/recipe";
import { calculateAge } from "@/lib/utils/age-calculator";

/**
 * í†µí•© ì‹ë‹¨ ìƒì„±
 */
export async function generateUnifiedDiet(
  members: FamilyMember[],
  date: string
): Promise<DailyDietPlan> {
  console.group("ğŸ½ï¸ í†µí•© ì‹ë‹¨ ìƒì„±");
  console.log(`ê°€ì¡± êµ¬ì„±ì›: ${members.length}ëª…`);

  // 1. ëª¨ë“  êµ¬ì„±ì›ì˜ ì œì•½ ì¡°ê±´ í†µí•©
  const allDiseases = new Set<string>();
  const allAllergies = new Set<string>();

  for (const member of members) {
    member.diseases?.forEach((d) => allDiseases.add(d));
    member.allergies?.forEach((a) => allAllergies.add(a));
  }

  console.log("í†µí•© ì§ˆë³‘:", Array.from(allDiseases));
  console.log("í†µí•© ì•Œë ˆë¥´ê¸°:", Array.from(allAllergies));

  // 2. í‰ê·  ì¹¼ë¡œë¦¬ ê³„ì‚°
  const totalCalories = members.reduce((sum, member) => {
    const ageInfo = calculateAge(member.birth_date);
    const memberCalories = calculateDailyCalories(member, ageInfo.isChild);
    return sum + memberCalories;
  }, 0);
  
  const avgCalories = Math.round(totalCalories / members.length);
  console.log(`í‰ê·  ì¹¼ë¡œë¦¬: ${avgCalories}kcal`);

  // 3. ì‹ì‚¬ë³„ ì¹¼ë¡œë¦¬ ë¶„ë°°
  const mealCalories = {
    breakfast: Math.round(avgCalories * 0.30),
    lunch: Math.round(avgCalories * 0.35),
    dinner: Math.round(avgCalories * 0.30),
    snack: Math.round(avgCalories * 0.05),
  };

  // 4. í†µí•© ì œì•½ ì¡°ê±´ìœ¼ë¡œ ì‹ì‚¬ êµ¬ì„± ìƒì„±
  const breakfast = await selectUnifiedMealComposition(
    "breakfast",
    Array.from(allDiseases),
    Array.from(allAllergies),
    mealCalories.breakfast,
    members
  );

  const lunch = await selectUnifiedMealComposition(
    "lunch",
    Array.from(allDiseases),
    Array.from(allAllergies),
    mealCalories.lunch,
    members
  );

  const dinner = await selectUnifiedMealComposition(
    "dinner",
    Array.from(allDiseases),
    Array.from(allAllergies),
    mealCalories.dinner,
    members
  );

  // 5. ì´ ì˜ì–‘ ì •ë³´ ê³„ì‚°
  const totalNutrition = calculateTotalNutrition({
    breakfast,
    lunch,
    dinner,
  });

  console.log("âœ… í†µí•© ì‹ë‹¨ ìƒì„± ì™„ë£Œ");
  console.groupEnd();

  return {
    date,
    breakfast,
    lunch,
    dinner,
    totalNutrition,
  };
}

/**
 * í†µí•© ì‹ì‚¬ êµ¬ì„± ì„ íƒ
 * (ê°œì¸ ì‹ë‹¨ê³¼ ìœ ì‚¬í•˜ì§€ë§Œ ëª¨ë“  êµ¬ì„±ì›ì˜ ì œì•½ ì¡°ê±´ ê³ ë ¤)
 */
async function selectUnifiedMealComposition(
  mealType: MealType,
  diseases: string[],
  allergies: string[],
  targetCalories: number,
  members: FamilyMember[]
): Promise<MealComposition> {
  // êµ¬í˜„ ë¡œì§ì€ personal-diet-generatorì™€ ìœ ì‚¬
  // ë‹¨, ì§ˆë³‘/ì•Œë ˆë¥´ê¸°ê°€ í†µí•©ëœ ë°°ì—´ë¡œ ì „ë‹¬ë¨
  
  // ... (ìƒëµ, ì‹¤ì œ íŒŒì¼ ì°¸ì¡°)
}

/**
 * ê°€ì¡± ì‹ë‹¨ ìƒì„± (ê°œì¸ë³„ + í†µí•©)
 */
export async function generateFamilyDiet(
  userId: string,
  date: string,
  options: { generateUnified?: boolean } = { generateUnified: true }
): Promise<FamilyDietPlan> {
  console.group("ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ê°€ì¡± ì‹ë‹¨ ìƒì„±");
  
  // 1. ê°€ì¡± êµ¬ì„±ì› ì¡°íšŒ
  const supabase = await createClerkSupabaseClient();
  const { data: members } = await supabase
    .from("family_members")
    .select("*")
    .eq("user_id", userId);

  if (!members || members.length === 0) {
    throw new Error("ê°€ì¡± êµ¬ì„±ì›ì´ ì—†ìŠµë‹ˆë‹¤.");
  }

  // 2. ê°œì¸ë³„ ì‹ë‹¨ ìƒì„±
  const individualPlans: { [memberId: string]: DailyDietPlan } = {};
  
  for (const member of members) {
    individualPlans[member.id] = await generateIndividualDiet(member, date);
  }

  // 3. í†µí•© ì‹ë‹¨ ìƒì„± (ì˜µì…˜)
  let unifiedPlan: DailyDietPlan | undefined;
  
  if (options.generateUnified) {
    unifiedPlan = await generateUnifiedDiet(members, date);
  }

  console.log("âœ… ê°€ì¡± ì‹ë‹¨ ìƒì„± ì™„ë£Œ");
  console.groupEnd();

  return {
    date,
    individualPlans,
    unifiedPlan,
  };
}
```

---

## API êµ¬ì¡°

### API ë¼ìš°íŠ¸ ëª©ë¡

```
/api/diet/personal              POST    ê°œì¸ ì‹ë‹¨ ìƒì„±
/api/family/diet/generate       POST    ê°€ì¡± ì‹ë‹¨ ìƒì„±
/api/family/diet/[date]         GET     íŠ¹ì • ë‚ ì§œ ì‹ë‹¨ ì¡°íšŒ
/api/family/members             GET     ê°€ì¡± êµ¬ì„±ì› ì¡°íšŒ
/api/family/members             POST    ê°€ì¡± êµ¬ì„±ì› ì¶”ê°€
/api/family/members/[id]        PUT     ê°€ì¡± êµ¬ì„±ì› ìˆ˜ì •
/api/health/profile             GET     ê±´ê°• í”„ë¡œí•„ ì¡°íšŒ
/api/health/profile             PUT     ê±´ê°• í”„ë¡œí•„ ìˆ˜ì •
/api/cron/generate-daily-diets  GET     ìë™ ì‹ë‹¨ ìƒì„± (Cron)
```

---

### 1. ê°œì¸ ì‹ë‹¨ ìƒì„± API

**`app/api/diet/personal/route.ts`**:

```typescript
/**
 * @file app/api/diet/personal/route.ts
 * @description ê°œì¸ ë§ì¶¤ ì‹ë‹¨ ìƒì„± API
 */

import { NextRequest, NextResponse } from "next/server";
import { auth } from "@clerk/nextjs/server";
import { createClerkSupabaseClient } from "@/lib/supabase/server";
import { generatePersonalDiet } from "@/lib/diet/personal-diet-generator";

export async function POST(request: NextRequest) {
  try {
    console.group("ğŸ“‹ API: ê°œì¸ ì‹ë‹¨ ìƒì„±");
    
    // 1. ì¸ì¦ í™•ì¸
    const { userId: clerkUserId } = await auth();
    if (!clerkUserId) {
      return NextResponse.json(
        { success: false, error: "Unauthorized" },
        { status: 401 }
      );
    }

    // 2. ìš”ì²­ ë°ì´í„° íŒŒì‹±
    const body = await request.json();
    const { date } = body;

    if (!date) {
      return NextResponse.json(
        { success: false, error: "ë‚ ì§œê°€ í•„ìš”í•©ë‹ˆë‹¤." },
        { status: 400 }
      );
    }

    console.log("ìš”ì²­ ë‚ ì§œ:", date);

    // 3. Supabaseì—ì„œ ì‚¬ìš©ì ì¡°íšŒ
    const supabase = await createClerkSupabaseClient();
    const { data: userData } = await supabase
      .from("users")
      .select("id")
      .eq("clerk_id", clerkUserId)
      .single();

    if (!userData) {
      return NextResponse.json(
        { success: false, error: "ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." },
        { status: 404 }
      );
    }

    // 4. ê±´ê°• í”„ë¡œí•„ ì¡°íšŒ
    const { data: healthProfile } = await supabase
      .from("user_health_profiles")
      .select("*")
      .eq("user_id", userData.id)
      .single();

    if (!healthProfile) {
      return NextResponse.json(
        { success: false, error: "ê±´ê°• í”„ë¡œí•„ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ê±´ê°• ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." },
        { status: 400 }
      );
    }

    // 5. ì‹ë‹¨ ìƒì„±
    const dietPlan = await generatePersonalDiet(healthProfile, date);

    // 6. ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
    await saveDietPlanToDatabase(supabase, userData.id, null, dietPlan, false);

    console.log("âœ… ì‹ë‹¨ ìƒì„± ë° ì €ì¥ ì™„ë£Œ");
    console.groupEnd();

    return NextResponse.json({
      success: true,
      data: dietPlan,
    });
  } catch (error) {
    console.error("âŒ ì‹ë‹¨ ìƒì„± ì‹¤íŒ¨:", error);
    console.groupEnd();
    
    return NextResponse.json(
      {
        success: false,
        error: error instanceof Error ? error.message : "ì‹ë‹¨ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
      },
      { status: 500 }
    );
  }
}

/**
 * ì‹ë‹¨ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
 */
async function saveDietPlanToDatabase(
  supabase: any,
  userId: string,
  familyMemberId: string | null,
  dietPlan: any,
  isUnified: boolean
) {
  const meals = [
    { type: "breakfast", data: dietPlan.breakfast },
    { type: "lunch", data: dietPlan.lunch },
    { type: "dinner", data: dietPlan.dinner },
    { type: "snack", data: dietPlan.snack },
  ];

  for (const meal of meals) {
    if (!meal.data) continue;

    // MealComposition ë˜ëŠ” RecipeDetail ì²˜ë¦¬
    const recipeTitle = "rice" in meal.data 
      ? `${meal.data.rice?.title || "ë°¥"} + ë°˜ì°¬ ${meal.data.sides.length}ê°œ`
      : meal.data.title;

    const nutrition = "totalNutrition" in meal.data
      ? meal.data.totalNutrition
      : meal.data.nutrition;

    await supabase.from("diet_plans").insert({
      user_id: userId,
      family_member_id: familyMemberId,
      plan_date: dietPlan.date,
      meal_type: meal.type,
      recipe_title: recipeTitle,
      calories: nutrition.calories,
      protein_g: nutrition.protein,
      carbs_g: nutrition.carbs,
      fat_g: nutrition.fat,
      is_unified: isUnified,
    });
  }
}
```

---

### 2. ê°€ì¡± ì‹ë‹¨ ìƒì„± API

**`app/api/family/diet/generate/route.ts`**:

```typescript
/**
 * @file app/api/family/diet/generate/route.ts
 * @description ê°€ì¡± ì‹ë‹¨ ìƒì„± API
 */

import { NextRequest, NextResponse } from "next/server";
import { auth } from "@clerk/nextjs/server";
import { createClerkSupabaseClient } from "@/lib/supabase/server";
import { generateFamilyDiet } from "@/lib/diet/family-diet-generator";

export async function POST(request: NextRequest) {
  try {
    console.group("ğŸ“‹ API: ê°€ì¡± ì‹ë‹¨ ìƒì„±");
    
    const { userId: clerkUserId } = await auth();
    if (!clerkUserId) {
      return NextResponse.json(
        { success: false, error: "Unauthorized" },
        { status: 401 }
      );
    }

    const body = await request.json();
    const { date, generateUnified = true } = body;

    if (!date) {
      return NextResponse.json(
        { success: false, error: "ë‚ ì§œê°€ í•„ìš”í•©ë‹ˆë‹¤." },
        { status: 400 }
      );
    }

    const supabase = await createClerkSupabaseClient();
    const { data: userData } = await supabase
      .from("users")
      .select("id")
      .eq("clerk_id", clerkUserId)
      .single();

    if (!userData) {
      return NextResponse.json(
        { success: false, error: "ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." },
        { status: 404 }
      );
    }

    // ê°€ì¡± ì‹ë‹¨ ìƒì„±
    const familyDiet = await generateFamilyDiet(
      userData.id,
      date,
      { generateUnified }
    );

    // ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
    // (ê°œì¸ë³„ ì‹ë‹¨ + í†µí•© ì‹ë‹¨ ëª¨ë‘ ì €ì¥)
    // ... ì €ì¥ ë¡œì§ ìƒëµ

    console.log("âœ… ê°€ì¡± ì‹ë‹¨ ìƒì„± ì™„ë£Œ");
    console.groupEnd();

    return NextResponse.json({
      success: true,
      data: familyDiet,
    });
  } catch (error) {
    console.error("âŒ ê°€ì¡± ì‹ë‹¨ ìƒì„± ì‹¤íŒ¨:", error);
    console.groupEnd();
    
    return NextResponse.json(
      {
        success: false,
        error: error instanceof Error ? error.message : "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
      },
      { status: 500 }
    );
  }
}
```

---

### 3. ì‹ë‹¨ ì¡°íšŒ API

**`app/api/family/diet/[date]/route.ts`**:

```typescript
/**
 * @file app/api/family/diet/[date]/route.ts
 * @description íŠ¹ì • ë‚ ì§œ ì‹ë‹¨ ì¡°íšŒ API
 */

import { NextRequest, NextResponse } from "next/server";
import { auth } from "@clerk/nextjs/server";
import { createClerkSupabaseClient } from "@/lib/supabase/server";

export async function GET(
  request: NextRequest,
  props: { params: Promise<{ date: string }> }
) {
  try {
    const params = await props.params;
    const { date } = params;
    const { userId: clerkUserId } = await auth();

    if (!clerkUserId) {
      return NextResponse.json(
        { success: false, error: "Unauthorized" },
        { status: 401 }
      );
    }

    const supabase = await createClerkSupabaseClient();
    const { data: userData } = await supabase
      .from("users")
      .select("id")
      .eq("clerk_id", clerkUserId)
      .single();

    if (!userData) {
      return NextResponse.json(
        { success: false, error: "ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." },
        { status: 404 }
      );
    }

    // í•´ë‹¹ ë‚ ì§œì˜ ì‹ë‹¨ ì¡°íšŒ
    const { data: dietPlans } = await supabase
      .from("diet_plans")
      .select("*")
      .eq("user_id", userData.id)
      .eq("plan_date", date);

    if (!dietPlans || dietPlans.length === 0) {
      return NextResponse.json({
        success: true,
        data: null,
        message: "í•´ë‹¹ ë‚ ì§œì˜ ì‹ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.",
      });
    }

    // ì‹ë‹¨ ë°ì´í„° ê·¸ë£¹í•‘
    const groupedDiet = {
      date,
      individualPlans: {},
      unifiedPlan: null,
    };

    // ... ê·¸ë£¹í•‘ ë¡œì§ (ìƒëµ)

    return NextResponse.json({
      success: true,
      data: groupedDiet,
    });
  } catch (error) {
    console.error("ì‹ë‹¨ ì¡°íšŒ ì‹¤íŒ¨:", error);
    return NextResponse.json(
      { success: false, error: "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." },
      { status: 500 }
    );
  }
}
```

---

## UI ì»´í¬ë„ŒíŠ¸

### 1. ì‹ë‹¨ í‘œì‹œ ì»´í¬ë„ŒíŠ¸

**`components/diet/daily-diet-view.tsx`**:

```typescript
/**
 * @file components/diet/daily-diet-view.tsx
 * @description í•˜ë£¨ ì‹ë‹¨ í‘œì‹œ ì»´í¬ë„ŒíŠ¸
 */

"use client";

import { MealCompositionCard } from "./meal-composition-card";
import { MealCard } from "./meal-card";
import type { DailyDietPlan, MealComposition, RecipeDetail } from "@/types/recipe";

interface DailyDietViewProps {
  dietPlan: DailyDietPlan;
  memberName?: string;
}

export function DailyDietView({ dietPlan, memberName }: DailyDietViewProps) {
  const meals = [
    { key: "breakfast", label: "ì•„ì¹¨", icon: "ğŸŒ…", data: dietPlan.breakfast },
    { key: "lunch", label: "ì ì‹¬", icon: "â˜€ï¸", data: dietPlan.lunch },
    { key: "dinner", label: "ì €ë…", icon: "ğŸŒ™", data: dietPlan.dinner },
    { key: "snack", label: "ê°„ì‹", icon: "ğŸ", data: dietPlan.snack },
  ];

  return (
    <div className="space-y-4">
      {/* êµ¬ì„±ì› ì´ë¦„ */}
      {memberName && (
        <h3 className="text-xl font-semibold">{memberName}ì˜ ì‹ë‹¨</h3>
      )}

      {/* ì‹ì‚¬ë³„ ì¹´ë“œ */}
      <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
        {meals.map((meal) => {
          if (!meal.data) return null;

          // MealComposition íƒ€ì… ì²´í¬
          if ("rice" in meal.data && "sides" in meal.data) {
            return (
              <MealCompositionCard
                key={meal.key}
                mealType={meal.key as any}
                mealLabel={meal.label}
                mealIcon={meal.icon}
                composition={meal.data as MealComposition}
              />
            );
          }

          // RecipeDetail (ê°„ì‹ ë“±)
          return (
            <MealCard
              key={meal.key}
              mealType={meal.key as any}
              mealLabel={meal.label}
              mealIcon={meal.icon}
              recipe={meal.data as RecipeDetail}
            />
          );
        })}
      </div>

      {/* ì´ ì˜ì–‘ ì •ë³´ */}
      <div className="rounded-lg border bg-white p-4 shadow-sm dark:bg-gray-800">
        <h4 className="mb-3 font-semibold">ì´ ì˜ì–‘ ì •ë³´</h4>
        <div className="grid grid-cols-4 gap-4 text-sm">
          <div>
            <p className="text-gray-500 dark:text-gray-400">ì¹¼ë¡œë¦¬</p>
            <p className="text-lg font-semibold">
              {dietPlan.totalNutrition.calories}kcal
            </p>
          </div>
          <div>
            <p className="text-gray-500 dark:text-gray-400">ë‹¨ë°±ì§ˆ</p>
            <p className="text-lg font-semibold">
              {dietPlan.totalNutrition.protein}g
            </p>
          </div>
          <div>
            <p className="text-gray-500 dark:text-gray-400">íƒ„ìˆ˜í™”ë¬¼</p>
            <p className="text-lg font-semibold">
              {dietPlan.totalNutrition.carbs}g
            </p>
          </div>
          <div>
            <p className="text-gray-500 dark:text-gray-400">ì§€ë°©</p>
            <p className="text-lg font-semibold">
              {dietPlan.totalNutrition.fat}g
            </p>
          </div>
        </div>
      </div>
    </div>
  );
}
```

---

### 2. ì‹ì‚¬ êµ¬ì„± ì¹´ë“œ

**`components/diet/meal-composition-card.tsx`**:

```typescript
/**
 * @file components/diet/meal-composition-card.tsx
 * @description ì‹ì‚¬ êµ¬ì„± ì¹´ë“œ (ë°¥ + ë°˜ì°¬ 3ê°œ + êµ­/ì°Œê°œ)
 */

"use client";

import { useState } from "react";
import { UtensilsCrossed, ChevronRight } from "lucide-react";
import type { MealComposition } from "@/types/recipe";
import { MealCompositionDetailModal } from "./meal-composition-detail-modal";

interface MealCompositionCardProps {
  mealType: string;
  mealLabel: string;
  mealIcon: string;
  composition: MealComposition;
}

export function MealCompositionCard({
  mealType,
  mealLabel,
  mealIcon,
  composition,
}: MealCompositionCardProps) {
  const [detailOpen, setDetailOpen] = useState(false);

  return (
    <>
      <div
        onClick={() => setDetailOpen(true)}
        className="cursor-pointer rounded-lg border bg-white p-4 shadow-sm transition-shadow hover:shadow-md dark:bg-gray-800"
      >
        {/* í—¤ë” */}
        <div className="mb-3 flex items-center justify-between">
          <div className="flex items-center gap-2">
            <span className="text-2xl">{mealIcon}</span>
            <span className="font-semibold">{mealLabel}</span>
          </div>
          <UtensilsCrossed className="h-5 w-5 text-gray-400" />
        </div>

        {/* ì‹ì‚¬ êµ¬ì„± ìš”ì•½ */}
        <div className="space-y-2 text-sm">
          {composition.rice && (
            <div className="flex items-center gap-2">
              <span className="text-gray-500">ğŸš</span>
              <span className="truncate">{composition.rice.title}</span>
            </div>
          )}
          
          <div className="flex items-center gap-2">
            <span className="text-gray-500">ğŸ¥¬</span>
            <span className="truncate">
              ë°˜ì°¬ {composition.sides.length}ê°œ
            </span>
          </div>
          
          {composition.soup && (
            <div className="flex items-center gap-2">
              <span className="text-gray-500">ğŸ²</span>
              <span className="truncate">{composition.soup.title}</span>
            </div>
          )}
        </div>

        {/* ì˜ì–‘ ì •ë³´ */}
        <div className="mt-3 border-t pt-3 text-xs text-gray-600 dark:text-gray-400">
          <p className="font-semibold">
            {composition.totalNutrition.calories}kcal
          </p>
          <p>
            P: {composition.totalNutrition.protein}g |
            C: {composition.totalNutrition.carbs}g |
            F: {composition.totalNutrition.fat}g
          </p>
        </div>

        {/* ë”ë³´ê¸° ì•„ì´ì½˜ */}
        <div className="mt-3 flex items-center justify-end text-primary">
          <span className="text-xs">ìì„¸íˆ ë³´ê¸°</span>
          <ChevronRight className="h-4 w-4" />
        </div>
      </div>

      {/* ìƒì„¸ ëª¨ë‹¬ */}
      <MealCompositionDetailModal
        open={detailOpen}
        onClose={() => setDetailOpen(false)}
        mealLabel={mealLabel}
        composition={composition}
      />
    </>
  );
}
```

---

## ìë™ ì‹ë‹¨ ìƒì„± (Cron Job)

### Vercel Cron ì„¤ì •

**`vercel.json`**:

```json
{
  "crons": [
    {
      "path": "/api/cron/generate-daily-diets",
      "schedule": "0 20 * * *"
    }
  ]
}
```

**ì„¤ëª…**:
- ë§¤ì¼ ì €ë… 8ì‹œ(20:00)ì— ìë™ ì‹¤í–‰
- Cron í‘œí˜„ì‹: `ë¶„ ì‹œ ì¼ ì›” ìš”ì¼`
- `0 20 * * *`: ë§¤ì¼ 20ì‹œ 0ë¶„

---

### Cron Job API

**`app/api/cron/generate-daily-diets/route.ts`**:

```typescript
/**
 * @file app/api/cron/generate-daily-diets/route.ts
 * @description ìë™ ì‹ë‹¨ ìƒì„± Cron Job
 * 
 * ë§¤ì¼ ì €ë… 8ì‹œì— ì‹¤í–‰ë˜ì–´ ë‹¤ìŒ ë‚  ì‹ë‹¨ì„ ë¯¸ë¦¬ ìƒì„±í•©ë‹ˆë‹¤.
 */

import { NextRequest, NextResponse } from "next/server";
import { supabaseAdmin } from "@/lib/supabase/service-role";
import { generateFamilyDiet } from "@/lib/diet/family-diet-generator";
import { generatePersonalDiet } from "@/lib/diet/personal-diet-generator";

export async function GET(request: NextRequest) {
  try {
    console.group("â° Cron: ìë™ ì‹ë‹¨ ìƒì„±");
    
    // Vercel Cron Secret ê²€ì¦
    const authHeader = request.headers.get("authorization");
    if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
      return NextResponse.json(
        { success: false, error: "Unauthorized" },
        { status: 401 }
      );
    }

    // ë‹¤ìŒ ë‚  ë‚ ì§œ
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const targetDate = tomorrow.toISOString().split("T")[0];

    console.log(`ìƒì„± ë‚ ì§œ: ${targetDate}`);

    // 1. ëª¨ë“  ì‚¬ìš©ì ì¡°íšŒ
    const { data: users } = await supabaseAdmin
      .from("users")
      .select("id, name");

    if (!users || users.length === 0) {
      console.log("ìƒì„±í•  ì‚¬ìš©ì ì—†ìŒ");
      console.groupEnd();
      return NextResponse.json({
        success: true,
        message: "ìƒì„±í•  ì‚¬ìš©ì ì—†ìŒ",
      });
    }

    console.log(`ì´ ${users.length}ëª…ì˜ ì‹ë‹¨ ìƒì„±`);

    // 2. ê° ì‚¬ìš©ìë³„ë¡œ ì‹ë‹¨ ìƒì„±
    let successCount = 0;
    let errorCount = 0;

    for (const user of users) {
      try {
        // ê°€ì¡± êµ¬ì„±ì› í™•ì¸
        const { data: members } = await supabaseAdmin
          .from("family_members")
          .select("id")
          .eq("user_id", user.id);

        if (members && members.length > 0) {
          // ê°€ì¡± ì‹ë‹¨ ìƒì„±
          await generateFamilyDiet(user.id, targetDate);
        } else {
          // ê°œì¸ ì‹ë‹¨ ìƒì„±
          const { data: healthProfile } = await supabaseAdmin
            .from("user_health_profiles")
            .select("*")
            .eq("user_id", user.id)
            .single();

          if (healthProfile) {
            await generatePersonalDiet(healthProfile, targetDate);
          }
        }

        successCount++;
        console.log(`âœ… ${user.name} ì‹ë‹¨ ìƒì„± ì™„ë£Œ`);
      } catch (error) {
        errorCount++;
        console.error(`âŒ ${user.name} ì‹ë‹¨ ìƒì„± ì‹¤íŒ¨:`, error);
      }
    }

    console.log(`\nğŸ“Š ê²°ê³¼: ì„±ê³µ ${successCount}, ì‹¤íŒ¨ ${errorCount}`);
    console.groupEnd();

    return NextResponse.json({
      success: true,
      stats: {
        total: users.length,
        success: successCount,
        error: errorCount,
      },
    });
  } catch (error) {
    console.error("âŒ Cron ì‹¤í–‰ ì‹¤íŒ¨:", error);
    console.groupEnd();
    
    return NextResponse.json(
      {
        success: false,
        error: error instanceof Error ? error.message : "ì˜¤ë¥˜ ë°œìƒ",
      },
      { status: 500 }
    );
  }
}
```

**í™˜ê²½ ë³€ìˆ˜ ì¶”ê°€ (`.env.local`)**:

```bash
CRON_SECRET=your_random_secret_key_here
```

---

## ì œì²  ê³¼ì¼ ê°„ì‹ ì¶”ì²œ ì‹œìŠ¤í…œ

### ê°œìš”

ëª¨ë“  ê°€ì¡± êµ¬ì„±ì›ì—ê²Œ ì œì²  ê³¼ì¼ì„ ìë™ìœ¼ë¡œ ì¶”ì²œí•˜ëŠ” ì‹œìŠ¤í…œì…ë‹ˆë‹¤. ì§ˆë³‘ ì •ë³´ë¥¼ ê³ ë ¤í•˜ì—¬ ì•ˆì „í•œ ê³¼ì¼ë§Œ ì¶”ì²œí•˜ë©°, ì„±ì¥ê¸° ì–´ë¦°ì´ì—ê²ŒëŠ” íŠ¹íˆ ì¢‹ì€ ê³¼ì¼ì„ ìš°ì„ ì ìœ¼ë¡œ ì œê³µí•©ë‹ˆë‹¤.

### ë°ì´í„° êµ¬ì¡°

**`lib/diet/seasonal-fruits.ts`**:

```typescript
/**
 * @file lib/diet/seasonal-fruits.ts
 * @description ì œì²  ê³¼ì¼ ë°ì´í„°ë² ì´ìŠ¤ ë° ì¶”ì²œ ë¡œì§
 */

export interface FruitNutrition {
  servingSize: string;        // "100g (ì¤‘ê°„ í¬ê¸° 7ê°œ)"
  calories: number;
  protein: number;
  carbs: number;
  fat: number;
  fiber: number;
  vitaminC?: number;
  calcium?: number;
  iron?: number;
  potassium?: number;
}

export interface Fruit {
  id: string;                  // "strawberry", "banana"
  name: string;                // "ë”¸ê¸°", "ë°”ë‚˜ë‚˜"
  season: number[];            // [3, 4, 5] = 3ì›”, 4ì›”, 5ì›”
  nutrition: FruitNutrition;
  benefits: string[];          // ["ë¹„íƒ€ë¯¼C í’ë¶€", "í•­ì‚°í™” íš¨ê³¼"]
  goodForKids: boolean;        // ì„±ì¥ê¸° ì–´ë¦°ì´ ì¶”ì²œ ì—¬ë¶€
  kidsBenefits?: string;       // ì–´ë¦°ì´ì—ê²Œ ì¢‹ì€ êµ¬ì²´ì  ì´ìœ 
  availability: "high" | "medium" | "low";  // ì‹œì¤‘ êµ¬ë§¤ ìš©ì´ì„±
  avoidForDiseases?: string[]; // ["diabetes", "gout"]
  coupangUrl?: string;         // ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ ë§í¬ (ì¶”í›„)
  imageUrl?: string;           // ê³¼ì¼ ì´ë¯¸ì§€ URL
  emoji: string;               // "ğŸ“", "ğŸŒ"
}

// ì œì²  ê³¼ì¼ ë°ì´í„°
export const SEASONAL_FRUITS: Fruit[] = [
  {
    id: "strawberry",
    name: "ë”¸ê¸°",
    season: [3, 4, 5],
    nutrition: {
      servingSize: "100g (ì¤‘ê°„ í¬ê¸° 7ê°œ)",
      calories: 32,
      protein: 0.7,
      carbs: 7.7,
      fat: 0.3,
      fiber: 2.0,
      vitaminC: 58.8,
      calcium: 16,
      iron: 0.4,
    },
    benefits: ["ë¹„íƒ€ë¯¼C í’ë¶€", "í•­ì‚°í™” íš¨ê³¼", "ë©´ì—­ë ¥ ê°•í™”"],
    goodForKids: true,
    kidsBenefits: "ë¹„íƒ€ë¯¼Cê°€ í’ë¶€í•˜ì—¬ ë©´ì—­ë ¥ ê°•í™”ì™€ í”¼ë¶€ ê±´ê°•ì— ì¢‹ê³ , ì² ë¶„ í¡ìˆ˜ë¥¼ ë„ì™€ ì„±ì¥ê¸° ì–´ë¦°ì´ì—ê²Œ ì´ìƒì ì…ë‹ˆë‹¤.",
    availability: "high",
    avoidForDiseases: [],
    emoji: "ğŸ“",
  },
  {
    id: "watermelon",
    name: "ìˆ˜ë°•",
    season: [6, 7, 8],
    nutrition: {
      servingSize: "100g (í•œ ì»µ)",
      calories: 30,
      protein: 0.6,
      carbs: 7.6,
      fat: 0.2,
      fiber: 0.4,
      vitaminC: 8.1,
      calcium: 7,
    },
    benefits: ["ìˆ˜ë¶„ ë³´ì¶©", "ì „í•´ì§ˆ ê· í˜•", "ë”ìœ„ í•´ì†Œ"],
    goodForKids: true,
    kidsBenefits: "92%ê°€ ìˆ˜ë¶„ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ë”ìš´ ì—¬ë¦„ì²  íƒˆìˆ˜ ì˜ˆë°©ì— íƒì›”í•˜ë©°, ë¦¬ì½”íœì´ í’ë¶€í•´ ì„±ì¥ê¸° ë©´ì—­ë ¥ ê°•í™”ì— ë„ì›€ì„ ì¤ë‹ˆë‹¤.",
    availability: "high",
    avoidForDiseases: ["diabetes"], // ë‹¹ë‡¨ í™˜ìëŠ” ì„­ì·¨ëŸ‰ ì¡°ì ˆ í•„ìš”
    emoji: "ğŸ‰",
  },
  {
    id: "banana",
    name: "ë°”ë‚˜ë‚˜",
    season: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12], // ì—°ì¤‘
    nutrition: {
      servingSize: "1ê°œ (ì¤‘ê°„ í¬ê¸° 120g)",
      calories: 105,
      protein: 1.3,
      carbs: 27.0,
      fat: 0.4,
      fiber: 3.1,
      vitaminC: 10.3,
      potassium: 422,
    },
    benefits: ["ì—ë„ˆì§€ ê³µê¸‰", "ì†Œí™” ê°œì„ ", "í˜ˆì•• ì¡°ì ˆ"],
    goodForKids: true,
    kidsBenefits: "íƒ„ìˆ˜í™”ë¬¼ì´ í’ë¶€í•˜ì—¬ ì„±ì¥ê¸° ì–´ë¦°ì´ì˜ ì—ë„ˆì§€ì›ìœ¼ë¡œ ì¢‹ê³ , ì¹¼ë¥¨ì´ í’ë¶€í•´ ë‚˜íŠ¸ë¥¨ ë°°ì¶œì— ë„ì›€ì„ ì¤ë‹ˆë‹¤.",
    availability: "high",
    avoidForDiseases: ["diabetes"],
    emoji: "ğŸŒ",
  },
  // ... ì´ 11ì¢… ê³¼ì¼ (ë”¸ê¸°, ì²´ë¦¬, ìˆ˜ë°•, ë³µìˆ­ì•„, ë©œë¡ , í¬ë„, ë°°, ì‚¬ê³¼, ê°, í‚¤ìœ„, ë°”ë‚˜ë‚˜)
];

/**
 * ì œì²  ê³¼ì¼ í•„í„°ë§
 */
export function getSeasonalFruits(month: number): Fruit[] {
  const seasonal = SEASONAL_FRUITS.filter((fruit) =>
    fruit.season.includes(month)
  );

  // ì •ë ¬: ì–´ë¦°ì´ ì¶”ì²œ > êµ¬ë§¤ ìš©ì´ì„±
  return seasonal.sort((a, b) => {
    if (a.goodForKids && !b.goodForKids) return -1;
    if (!a.goodForKids && b.goodForKids) return 1;
    
    const availabilityOrder = { high: 0, medium: 1, low: 2 };
    return availabilityOrder[a.availability] - availabilityOrder[b.availability];
  });
}

/**
 * ê³¼ì¼ ê°„ì‹ ì¶”ì²œ
 * 
 * @param targetCalories - ëª©í‘œ ì¹¼ë¡œë¦¬ (ì‚¬ìš©í•˜ì§€ ì•ŠìŒ, í•­ìƒ 1íšŒë¶„ ì¶”ì²œ)
 * @param currentMonth - í˜„ì¬ ì›” (1-12)
 * @param isChild - ì–´ë¦°ì´ ì—¬ë¶€
 * @param diseases - ì§ˆë³‘ ëª©ë¡
 */
export function recommendFruitSnack(
  targetCalories: number,
  currentMonth: number,
  isChild: boolean,
  diseases: string[] = []
): {
  fruit: Fruit;
  servings: number;
  totalCalories: number;
  reason: string;
} {
  console.group("ğŸ ê³¼ì¼ ê°„ì‹ ì¶”ì²œ");
  console.log(`í˜„ì¬ ì›”: ${currentMonth}ì›”, ì–´ë¦°ì´: ${isChild}, ì§ˆë³‘: ${diseases.join(", ")}`);

  // 1. ì œì²  ê³¼ì¼ í•„í„°ë§
  let candidateFruits = getSeasonalFruits(currentMonth);
  console.log(`ì œì²  ê³¼ì¼: ${candidateFruits.map(f => f.name).join(", ")}`);

  // 2. ì§ˆë³‘ ê¸°ë°˜ í•„í„°ë§
  if (diseases.length > 0) {
    candidateFruits = candidateFruits.filter((fruit) => {
      const shouldAvoid = fruit.avoidForDiseases?.some((disease) =>
        diseases.includes(disease)
      );
      return !shouldAvoid;
    });
    console.log(`ì§ˆë³‘ í•„í„°ë§ í›„: ${candidateFruits.map(f => f.name).join(", ")}`);
  }

  // 3. í´ë°±: ì œì²  ê³¼ì¼ì´ ì—†ìœ¼ë©´ ë°”ë‚˜ë‚˜ (ì—°ì¤‘ ê°€ëŠ¥)
  if (candidateFruits.length === 0) {
    console.warn("âš ï¸ ì œì²  ê³¼ì¼ ì—†ìŒ - ë°”ë‚˜ë‚˜ë¡œ í´ë°±");
    const banana = SEASONAL_FRUITS.find((f) => f.id === "banana");
    
    // ë°”ë‚˜ë‚˜ë„ ì§ˆë³‘ìœ¼ë¡œ ì œì™¸ë˜ë©´ ë”¸ê¸°ë¡œ ìµœì¢… í´ë°±
    if (banana && banana.avoidForDiseases?.some((d) => diseases.includes(d))) {
      const strawberry = SEASONAL_FRUITS.find((f) => f.id === "strawberry");
      candidateFruits = strawberry ? [strawberry] : [banana];
    } else {
      candidateFruits = banana ? [banana] : [];
    }
  }

  // ìµœì¢… ì„ íƒ
  const selectedFruit = candidateFruits[0];

  // í•­ìƒ 1íšŒë¶„ ì¶”ì²œ (ì¹¼ë¡œë¦¬ ë¬´ê´€)
  const servings = 1;
  const totalCalories = selectedFruit.nutrition.calories * servings;

  let reason = `${currentMonth}ì›” ì œì²  ê³¼ì¼`;
  if (isChild && selectedFruit.goodForKids) {
    reason += " (ì„±ì¥ê¸° ì–´ë¦°ì´ì—ê²Œ ì¢‹ìŒ)";
  }
  if (diseases.length > 0) {
    reason += ` (${diseases.join(", ")} ê³ ë ¤)`;
  }

  console.log(`âœ… ì„ íƒ: ${selectedFruit.name} ${servings}íšŒë¶„ (${totalCalories}kcal)`);
  console.groupEnd();

  return {
    fruit: selectedFruit,
    servings,
    totalCalories,
    reason,
  };
}
```

### ì‹ë‹¨ ìƒì„± ë¡œì§ í†µí•©

**`lib/diet/family-diet-generator.ts` ìˆ˜ì •**:

```typescript
// selectRecipeForMeal í•¨ìˆ˜ ë‚´ ê°„ì‹ ì²˜ë¦¬ ë¶€ë¶„

async function selectRecipeForMeal(
  mealType: MealType,
  member: FamilyMember,
  targetCalories: number,
  isChild: boolean
): Promise<RecipeDetail | undefined> {
  // ê°„ì‹ì¸ ê²½ìš° ì œì²  ê³¼ì¼ ì¶”ì²œ
  if (mealType === "snack") {
    const currentMonth = new Date().getMonth() + 1; // 1-12
    const recommendation = recommendFruitSnack(
      targetCalories,
      currentMonth,
      isChild,
      member.diseases || [] // ì§ˆë³‘ ì •ë³´ ì „ë‹¬
    );

    console.log(
      `ğŸ ê°„ì‹ ì¶”ì²œ: ${recommendation.fruit.name} ${recommendation.servings}íšŒë¶„ ` +
      `(${recommendation.totalCalories}kcal) - ${recommendation.reason}`
    );

    // RecipeDetail í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    const fruitRecipe: RecipeDetail = {
      id: `fruit-${recommendation.fruit.id}-${Date.now()}`,
      source: "seasonal" as const,
      title: recommendation.fruit.name, // ê³¼ì¼ëª…ë§Œ í‘œì‹œ
      description: `${recommendation.fruit.nutrition.servingSize}, ${recommendation.totalCalories}kcal`, // ìˆ˜ëŸ‰, ì¹¼ë¡œë¦¬
      ingredients: [
        {
          name: recommendation.fruit.name,
          amount: recommendation.fruit.nutrition.servingSize,
          unit: "",
        },
      ],
      instructions: [
        `ì‹ ì„ í•œ ${recommendation.fruit.name}ì„ ê¹¨ë—ì´ ì”»ì–´ ì¤€ë¹„í•©ë‹ˆë‹¤.`,
        `${recommendation.fruit.nutrition.servingSize}ë§Œí¼ ì„­ì·¨í•©ë‹ˆë‹¤.`,
      ],
      nutrition: {
        calories: recommendation.totalCalories,
        protein: recommendation.fruit.nutrition.protein * recommendation.servings,
        carbs: recommendation.fruit.nutrition.carbs * recommendation.servings,
        fat: recommendation.fruit.nutrition.fat * recommendation.servings,
        fiber: recommendation.fruit.nutrition.fiber * recommendation.servings,
        sodium: 0,
      },
      mealType: "snack",
      featureDescription: isChild && recommendation.fruit.kidsBenefits
        ? `ì„±ì¥ê¸° ì–´ë¦°ì´ì—ê²Œ ì¢‹ì€ ${recommendation.fruit.name}: ${recommendation.fruit.kidsBenefits}`
        : `${currentMonth}ì›” ì œì²  ê³¼ì¼ ${recommendation.fruit.name}: ${recommendation.fruit.benefits.join(", ")}`,
      emoji: recommendation.fruit.emoji,
      imageUrl: recommendation.fruit.imageUrl,
    };

    return fruitRecipe;
  }

  // ê°„ì‹ì´ ì•„ë‹Œ ê²½ìš° ê¸°ì¡´ ë ˆì‹œí”¼ ê²€ìƒ‰ ë¡œì§
  // ...
}

// ì´ ì˜ì–‘ ì •ë³´ ê³„ì‚° ì‹œ ê°„ì‹ ì œì™¸
const totalNutrition = calculateTotalNutrition({
  breakfast,
  lunch,
  dinner,
  // snack, // ê°„ì‹ì€ ì´ ì¹¼ë¡œë¦¬ ê³„ì‚°ì—ì„œ ì œì™¸
});
```

### UI ì»´í¬ë„ŒíŠ¸

**`components/diet/meal-card.tsx`** (ê°„ì‹ìš© ì¹´ë“œ):

```typescript
/**
 * @file components/diet/meal-card.tsx
 * @description ë‹¨ì¼ ì‹ì‚¬/ê°„ì‹ ì¹´ë“œ ì»´í¬ë„ŒíŠ¸
 */

"use client";

import { useState } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { MealDetailModal } from "./meal-detail-modal";
import type { RecipeDetail, MealType } from "@/types/recipe";

interface MealCardProps {
  meal: RecipeDetail;
  mealType: MealType;
  date: string;
}

const mealLabels: Record<MealType, string> = {
  breakfast: "ì•„ì¹¨",
  lunch: "ì ì‹¬",
  dinner: "ì €ë…",
  snack: "ê°„ì‹",
};

export function MealCard({ meal, mealType, date }: MealCardProps) {
  const [isModalOpen, setIsModalOpen] = useState(false);

  const isSnack = mealType === "snack";

  return (
    <>
      <Card
        className="cursor-pointer transition-all hover:shadow-md hover:scale-105"
        onClick={() => setIsModalOpen(true)}
      >
        <CardContent className="p-4">
          <div className="flex items-center justify-between">
            <div className="flex-1">
              <div className="text-sm text-gray-500 mb-1">
                {mealLabels[mealType]}
              </div>
              {isSnack && meal.emoji ? (
                <div className="text-center text-7xl mb-2">{meal.emoji}</div>
              ) : null}
              <h3 className="font-semibold text-lg mb-2 line-clamp-2 text-center">
                {meal.title}
              </h3>
              <div className="text-sm font-medium text-primary text-center">
                {meal.description}
              </div>
            </div>
          </div>
        </CardContent>
      </Card>
      <MealDetailModal
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
        meal={meal}
        date={date}
      />
    </>
  );
}
```

---

## ì •ë°€ ì¹¼ë¡œë¦¬ ê³„ì‚° ì‹œìŠ¤í…œ (ê°œì„  ë²„ì „)

### ê°œìš”

í•œêµ­ì˜ì–‘í•™íšŒ ê¶Œì¥ ê¸°ì¤€ì„ ë°”íƒ•ìœ¼ë¡œ ì—°ë ¹ë³„, ì„±ë³„, ì§ˆë³‘ë³„ë¡œ ì •ë°€í•œ ì¹¼ë¡œë¦¬ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤. íŠ¹íˆ 18ì„¸ ë¯¸ë§Œ ì–´ë¦°ì´/ì²­ì†Œë…„ì— ëŒ€í•´ ìƒì„¸í•œ ì—°ë ¹ êµ¬ë¶„ì„ ì ìš©í•©ë‹ˆë‹¤.

### ì—°ë ¹ë³„ ê¶Œì¥ ì¹¼ë¡œë¦¬ (í•œêµ­ì˜ì–‘í•™íšŒ ê¸°ì¤€)

**`lib/diet/calorie-calculator.ts` (ê°œì„  ë²„ì „)**:

```typescript
/**
 * @file lib/diet/calorie-calculator.ts
 * @description ì •ë°€ ì¹¼ë¡œë¦¬ ê³„ì‚° ì‹œìŠ¤í…œ
 */

import type { Disease, FamilyMember, UserHealthProfile } from "@/types/family";

// ì§ˆë³‘ë³„ ì¹¼ë¡œë¦¬ ì¡°ì • ê³„ìˆ˜
const DISEASE_CALORIE_MULTIPLIERS: Record<string, number> = {
  diabetes: 0.85,         // ë‹¹ë‡¨: 85%
  hypertension: 1.0,      // ê³ í˜ˆì••: ìœ ì§€ (ë‚˜íŠ¸ë¥¨ë§Œ ì œí•œ)
  gout: 0.9,              // í†µí’: 90%
  kidney_disease: 0.9,    // ì‹ ì¥ì§ˆí™˜: 90%
  hyperlipidemia: 0.85,   // ê³ ì§€í˜ˆì¦: 85%
  obesity: 0.8,           // ë¹„ë§Œ: 80%
  heart_disease: 0.9,     // ì‹¬ì¥ë³‘: 90%
};

// í™œë™ ìˆ˜ì¤€ë³„ ì¹¼ë¡œë¦¬ ê³„ìˆ˜
const ACTIVITY_MULTIPLIERS = {
  sedentary: 1.2,         // ì£¼ë¡œ ì•‰ì•„ì„œ ìƒí™œ
  light: 1.375,           // ê°€ë²¼ìš´ ìš´ë™ (ì£¼ 1-3íšŒ)
  moderate: 1.55,         // ì¤‘ê°„ ê°•ë„ ìš´ë™ (ì£¼ 3-5íšŒ)
  active: 1.725,          // í™œë°œí•œ ìš´ë™ (ì£¼ 6-7íšŒ)
  very_active: 1.9,       // ë§¤ìš° í™œë°œí•œ ìš´ë™ (í•˜ë£¨ 2íšŒ)
};

/**
 * ì—°ë ¹ë³„ ê¶Œì¥ ì¹¼ë¡œë¦¬ (í•œêµ­ì˜ì–‘í•™íšŒ)
 * í‚¤/ëª¸ë¬´ê²Œ ì •ë³´ê°€ ì—†ëŠ” ê²½ìš° ì‚¬ìš©
 */
const AGE_BASED_CALORIES = {
  // 1-2ì„¸
  "1-2": { male: 1000, female: 1000 },
  // 3-5ì„¸
  "3-5": { male: 1400, female: 1400 },
  // 6-8ì„¸
  "6-8": { male: 1700, female: 1500 },
  // 9-11ì„¸
  "9-11": { male: 2100, female: 1800 },
  // 12-14ì„¸ (ì‚¬ì¶˜ê¸° ì‹œì‘)
  "12-14": { male: 2500, female: 2000 },
  // 15-18ì„¸ (ì²­ì†Œë…„ê¸°)
  "15-18": { male: 2700, female: 2000 },
  // 19-29ì„¸ (ì„±ì¸)
  "19-29": { male: 2600, female: 2100 },
  // 30-49ì„¸
  "30-49": { male: 2400, female: 1900 },
  // 50-64ì„¸
  "50-64": { male: 2200, female: 1800 },
  // 65ì„¸ ì´ìƒ
  "65+": { male: 2000, female: 1600 },
} as const;

/**
 * ë‚˜ì´ì— ë”°ë¥¸ ê¶Œì¥ ì¹¼ë¡œë¦¬ ë²”ìœ„ ê²°ì •
 */
function getAgeRangeKey(age: number): keyof typeof AGE_BASED_CALORIES {
  if (age >= 1 && age <= 2) return "1-2";
  if (age >= 3 && age <= 5) return "3-5";
  if (age >= 6 && age <= 8) return "6-8";
  if (age >= 9 && age <= 11) return "9-11";
  if (age >= 12 && age <= 14) return "12-14";
  if (age >= 15 && age <= 18) return "15-18";
  if (age >= 19 && age <= 29) return "19-29";
  if (age >= 30 && age <= 49) return "30-49";
  if (age >= 50 && age <= 64) return "50-64";
  return "65+";
}

/**
 * ê¸°ì´ˆëŒ€ì‚¬ëŸ‰(BMR) ê³„ì‚° - Harris-Benedict ê³µì‹
 */
function calculateBMR(
  gender: "male" | "female" | "other",
  weight_kg: number,
  height_cm: number,
  age: number
): number {
  if (gender === "male") {
    return 88.362 + 13.397 * weight_kg + 4.799 * height_cm - 5.677 * age;
  } else {
    return 447.593 + 9.247 * weight_kg + 3.098 * height_cm - 4.33 * age;
  }
}

/**
 * ì¼ì¼ ê¶Œì¥ ì¹¼ë¡œë¦¬ ê³„ì‚° (ê°œì„  ë²„ì „)
 */
export function calculateDailyCalories(params: {
  gender: "male" | "female" | "other";
  weight_kg?: number;
  height_cm?: number;
  age: number;
  activity_level: keyof typeof ACTIVITY_MULTIPLIERS;
  diseases?: string[];
}): number {
  console.group("ğŸ”¢ ì¼ì¼ ê¶Œì¥ ì¹¼ë¡œë¦¬ ê³„ì‚°");
  console.log("ì…ë ¥ ì •ë³´:", params);

  let dailyCalories: number;

  // 12ì„¸ ì´ìƒ + í‚¤/ëª¸ë¬´ê²Œ ìˆìŒ â†’ Harris-Benedict ê³µì‹ ì‚¬ìš©
  if (params.age >= 12 && params.weight_kg && params.height_cm) {
    console.log("ğŸ“ Harris-Benedict ê³µì‹ ì‚¬ìš© (12ì„¸ ì´ìƒ + í‚¤/ëª¸ë¬´ê²Œ ìˆìŒ)");
    
    const bmr = calculateBMR(
      params.gender,
      params.weight_kg,
      params.height_cm,
      params.age
    );
    console.log(`ê¸°ì´ˆëŒ€ì‚¬ëŸ‰ (BMR): ${Math.round(bmr)}kcal`);

    const activityMultiplier = ACTIVITY_MULTIPLIERS[params.activity_level] || 1.2;
    dailyCalories = bmr * activityMultiplier;
    console.log(`í™œë™ ìˆ˜ì¤€ (${params.activity_level}): Ã—${activityMultiplier} = ${Math.round(dailyCalories)}kcal`);
  }
  // 12ì„¸ ë¯¸ë§Œ ë˜ëŠ” í‚¤/ëª¸ë¬´ê²Œ ì—†ìŒ â†’ ì—°ë ¹ë³„ ê¶Œì¥ ì¹¼ë¡œë¦¬
  else {
    console.log("ğŸ“Š í•œêµ­ì˜ì–‘í•™íšŒ ê¶Œì¥ ì¹¼ë¡œë¦¬ ì‚¬ìš©");
    
    const ageRangeKey = getAgeRangeKey(params.age);
    const genderKey = params.gender === "male" ? "male" : "female";
    const baseCalories = AGE_BASED_CALORIES[ageRangeKey][genderKey];
    
    console.log(`ì—°ë ¹ëŒ€: ${ageRangeKey}, ì„±ë³„: ${genderKey}`);
    console.log(`ê¸°ë³¸ ê¶Œì¥ ì¹¼ë¡œë¦¬: ${baseCalories}kcal`);

    // í™œë™ ìˆ˜ì¤€ ë°˜ì˜ (ê²½ë¯¸í•˜ê²Œ, Â±15%)
    const activityMultiplier = ACTIVITY_MULTIPLIERS[params.activity_level] || 1.2;
    const activityAdjustment = (activityMultiplier - 1.2) * 0.15 + 1; // 0.85 ~ 1.15
    dailyCalories = baseCalories * activityAdjustment;
    
    console.log(`í™œë™ ì¡°ì •: Ã—${activityAdjustment.toFixed(2)} = ${Math.round(dailyCalories)}kcal`);
  }

  // ì§ˆë³‘ë³„ ì¡°ì • (ê°€ì¥ ë‚®ì€ ê³„ìˆ˜ ì ìš©)
  if (params.diseases && params.diseases.length > 0) {
    console.log(`ì§ˆë³‘ ì •ë³´: ${params.diseases.join(", ")}`);
    
    let lowestMultiplier = 1.0;
    let appliedDisease = "";
    
    for (const disease of params.diseases) {
      const multiplier = DISEASE_CALORIE_MULTIPLIERS[disease];
      if (multiplier && multiplier < lowestMultiplier) {
        lowestMultiplier = multiplier;
        appliedDisease = disease;
      }
    }
    
    if (appliedDisease) {
      console.log(`ì§ˆë³‘ ì¡°ì • (${appliedDisease}): Ã—${lowestMultiplier}`);
      dailyCalories *= lowestMultiplier;
    }
  }

  const result = Math.round(dailyCalories);
  console.log(`âœ… ìµœì¢… ê¶Œì¥ ì¹¼ë¡œë¦¬: ${result}kcal`);
  console.groupEnd();

  return result;
}

/**
 * ê°€ì¡± êµ¬ì„±ì›ì˜ ëª©í‘œ ì¹¼ë¡œë¦¬ ê³„ì‚°
 */
export function calculateMemberGoalCalories(
  member: FamilyMember,
  isChild: boolean
): number {
  const age = calculateAge(member.birth_date).years;

  return calculateDailyCalories({
    gender: member.gender || "other",
    weight_kg: member.weight_kg,
    height_cm: member.height_cm,
    age,
    activity_level: member.activity_level || "sedentary",
    diseases: member.diseases,
  });
}

/**
 * ì‚¬ìš©ì ë³¸ì¸ì˜ ëª©í‘œ ì¹¼ë¡œë¦¬ ê³„ì‚°
 */
export function calculateUserGoalCalories(
  profile: UserHealthProfile
): number {
  return calculateDailyCalories({
    gender: profile.gender || "other",
    weight_kg: profile.weight_kg,
    height_cm: profile.height_cm,
    age: profile.age || 30,
    activity_level: profile.activity_level || "sedentary",
    diseases: profile.diseases,
  });
}
```

### ê³„ì‚° ì˜ˆì‹œ

**ì˜ˆì‹œ 1: 18ì„¸ ë‚¨ì„± (ì€ì˜ˆì„±)**

```typescript
// ì…ë ¥ ì •ë³´
const params = {
  gender: "male",
  weight_kg: 65,
  height_cm: 175,
  age: 18,
  activity_level: "sedentary",
  diseases: ["heart_disease"],
};

// ê³„ì‚° ê³¼ì •
// 1. BMR = 88.362 + (13.397 Ã— 65) + (4.799 Ã— 175) - (5.677 Ã— 18)
//        = 88.362 + 870.805 + 839.825 - 102.186
//        = 1696.8 kcal

// 2. í™œë™ ê³„ìˆ˜ ì ìš© = 1696.8 Ã— 1.2 = 2036 kcal

// 3. ì§ˆë³‘ ì¡°ì • (ì‹¬ì¥ë³‘) = 2036 Ã— 0.9 = 1832 kcal

// ìµœì¢… ê²°ê³¼: ì•½ 1832 kcal
```

**ì˜ˆì‹œ 2: 7ì„¸ ì—¬ì•„ (í‚¤/ëª¸ë¬´ê²Œ ì •ë³´ ì—†ìŒ)**

```typescript
const params = {
  gender: "female",
  age: 7,
  activity_level: "moderate",
  diseases: [],
};

// ê³„ì‚° ê³¼ì •
// 1. ì—°ë ¹ëŒ€: 6-8ì„¸ â†’ ê¸°ë³¸ 1500 kcal
// 2. í™œë™ ì¡°ì •: moderate (1.55) â†’ (1.55 - 1.2) Ã— 0.15 + 1 = 1.0525
// 3. ìµœì¢…: 1500 Ã— 1.0525 = 1579 kcal
```

---

## ê°€ì¡± ì‹ë‹¨ íƒ­ ì¸í„°í˜ì´ìŠ¤

### ê°œìš”

í™ˆí˜ì´ì§€ì—ì„œ ì‚¬ìš©ì ë³¸ì¸ê³¼ ê°€ì¡± êµ¬ì„±ì›ì˜ ì‹ë‹¨ì„ íƒ­ìœ¼ë¡œ ì „í™˜í•˜ë©°, í† ê¸€ ìŠ¤ìœ„ì¹˜ë¡œ í†µí•© ì‹ë‹¨ì— í¬í•¨/ì œì™¸í•  ìˆ˜ ìˆëŠ” ì¸í„°í˜ì´ìŠ¤ì…ë‹ˆë‹¤.

### UI êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI ë§ì¶¤ ì‹ë‹¨                                                â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚ ë‚˜  â”‚ ì€ì˜ˆì„±  â”‚ ì€ì§€ì›  â”‚ ì€ìˆ˜ì—°  â”‚  (íƒ­)               â”‚
â”‚  â”‚  âœ“  â”‚   âœ“     â”‚   âœ“     â”‚   âœ“     â”‚  (í† ê¸€)             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                               â”‚
â”‚  í†µí•© ì¹¼ë¡œë¦¬: 6500 kcal  (í† ê¸€ì´ ONì¸ êµ¬ì„±ì› í•©ì‚°)        â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ ì•„ì¹¨ â”‚ â”‚ ì ì‹¬ â”‚ â”‚ ì €ë… â”‚ â”‚ ê°„ì‹ â”‚  (ì‹ì‚¬ ì¹´ë“œ)         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì»´í¬ë„ŒíŠ¸ êµ¬ì¡°

**`components/diet/family-diet-tabs.tsx`**:

```typescript
/**
 * @file components/diet/family-diet-tabs.tsx
 * @description ê°€ì¡± ì‹ë‹¨ íƒ­ ì¸í„°í˜ì´ìŠ¤
 */

"use client";

import { useMemo, useState } from "react";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Switch } from "@/components/ui/switch";
import { DailyDietView } from "./daily-diet-view";
import { getHealthLabels, getHealthSummary } from "@/lib/utils/health-labels";
import type { FamilyMember, UserHealthProfile } from "@/types/family";
import type { FamilyDietPlan, DailyDietPlan } from "@/types/recipe";

interface FamilyDietTabsProps {
  familyMembers: FamilyMember[];
  goalCaloriesMap: Record<string, number>;
  familyDietPlan?: FamilyDietPlan;
  userProfile?: UserHealthProfile;
  userGoalCalories?: number;
  userDietPlan?: DailyDietPlan;
  userName?: string;
}

export function FamilyDietTabs({
  familyMembers,
  goalCaloriesMap,
  familyDietPlan,
  userProfile,
  userGoalCalories,
  userDietPlan,
  userName = "ë‚˜",
}: FamilyDietTabsProps) {
  // í†µí•© ì‹ë‹¨ì— í¬í•¨í•  êµ¬ì„±ì› (í† ê¸€ ìƒíƒœ)
  const [includedMembers, setIncludedMembers] = useState<Record<string, boolean>>(() => {
    const initial: Record<string, boolean> = {};
    
    // ì‚¬ìš©ì ë³¸ì¸ í¬í•¨
    if (userProfile) {
      initial["user"] = true;
    }
    
    // ê°€ì¡± êµ¬ì„±ì› í¬í•¨
    familyMembers.forEach((member) => {
      initial[member.id] = true;
    });
    
    return initial;
  });

  // í†µí•© ì¹¼ë¡œë¦¬ ê³„ì‚°
  const combinedDiet = useMemo(() => {
    if (!familyDietPlan?.unifiedPlan) {
      return null;
    }

    let totalCombinedCalories = 0;

    // ì‚¬ìš©ì ë³¸ì¸ ì¹¼ë¡œë¦¬
    if (includedMembers["user"] && userGoalCalories) {
      totalCombinedCalories += userGoalCalories;
    }

    // ê°€ì¡± êµ¬ì„±ì› ì¹¼ë¡œë¦¬
    familyMembers.forEach((member) => {
      if (includedMembers[member.id]) {
        totalCombinedCalories += goalCaloriesMap[member.id] || 0;
      }
    });

    // í†µí•© ì‹ë‹¨ì˜ ì˜ì–‘ ì •ë³´ë¥¼ ë³µì‚¬í•˜ê³  ì¹¼ë¡œë¦¬ë§Œ êµì²´
    return {
      ...familyDietPlan.unifiedPlan,
      totalNutrition: {
        ...familyDietPlan.unifiedPlan.totalNutrition,
        calories: totalCombinedCalories,
      },
    };
  }, [
    familyDietPlan,
    includedMembers,
    familyMembers,
    goalCaloriesMap,
    userGoalCalories,
  ]);

  return (
    <Tabs defaultValue={userProfile ? "user" : familyMembers[0]?.id} className="w-full">
      <TabsList className="grid w-full" style={{ gridTemplateColumns: `repeat(${(userProfile ? 1 : 0) + familyMembers.length + 1}, 1fr)` }}>
        {/* ì‚¬ìš©ì ë³¸ì¸ íƒ­ */}
        {userProfile && (
          <TabsTrigger value="user" className="relative">
            <div className="flex flex-col items-center gap-1 w-full">
              <div className="flex items-center gap-2">
                <span>{userName}</span>
              </div>
              <div className="text-xs text-muted-foreground">
                {getHealthSummary(userProfile.diseases || [])}
              </div>
              <div className="text-xs font-semibold">
                ëª©í‘œ: {userGoalCalories}kcal
              </div>
              <Switch
                checked={includedMembers["user"] || false}
                onCheckedChange={(checked) =>
                  setIncludedMembers((prev) => ({ ...prev, user: checked }))
                }
                aria-label={`${userName} í†µí•© ì‹ë‹¨ í¬í•¨ ì—¬ë¶€`}
                onClick={(e) => e.stopPropagation()}
              />
            </div>
          </TabsTrigger>
        )}

        {/* ê°€ì¡± êµ¬ì„±ì› íƒ­ */}
        {familyMembers.map((member) => {
          const healthSummary = getHealthSummary(member.diseases || []);
          const goalCalories = goalCaloriesMap[member.id] || 0;

          return (
            <TabsTrigger key={member.id} value={member.id} className="relative">
              <div className="flex flex-col items-center gap-1 w-full">
                <div className="flex items-center gap-2">
                  <span>{member.name}</span>
                </div>
                <div className="text-xs text-muted-foreground">
                  {healthSummary}
                </div>
                <div className="text-xs font-semibold">
                  ëª©í‘œ: {goalCalories}kcal
                </div>
                <Switch
                  checked={includedMembers[member.id] || false}
                  onCheckedChange={(checked) =>
                    setIncludedMembers((prev) => ({ ...prev, [member.id]: checked }))
                  }
                  aria-label={`${member.name} í†µí•© ì‹ë‹¨ í¬í•¨ ì—¬ë¶€`}
                  onClick={(e) => e.stopPropagation()}
                />
              </div>
            </TabsTrigger>
          );
        })}

        {/* í†µí•© ì‹ë‹¨ íƒ­ */}
        <TabsTrigger value="unified">
          <div className="flex flex-col items-center gap-1">
            <span>í†µí•© ì‹ë‹¨</span>
            <div className="text-xs font-semibold">
              {combinedDiet?.totalNutrition.calories || 0}kcal
            </div>
          </div>
        </TabsTrigger>
      </TabsList>

      {/* ì‚¬ìš©ì ë³¸ì¸ ì‹ë‹¨ */}
      {userProfile && userDietPlan && (
        <TabsContent value="user">
          <DailyDietView dietPlan={userDietPlan} memberName={userName} />
        </TabsContent>
      )}

      {/* ê°€ì¡± êµ¬ì„±ì›ë³„ ì‹ë‹¨ */}
      {familyMembers.map((member) => {
        const memberDiet = familyDietPlan?.individualPlans[member.id];
        if (!memberDiet) return null;

        return (
          <TabsContent key={member.id} value={member.id}>
            <DailyDietView dietPlan={memberDiet} memberName={member.name} />
          </TabsContent>
        );
      })}

      {/* í†µí•© ì‹ë‹¨ */}
      <TabsContent value="unified">
        {combinedDiet ? (
          <DailyDietView dietPlan={combinedDiet} memberName="ê°€ì¡± í†µí•©" />
        ) : (
          <div className="text-center py-8 text-muted-foreground">
            í†µí•© ì‹ë‹¨ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
          </div>
        )}
      </TabsContent>
    </Tabs>
  );
}
```

### í™ˆí˜ì´ì§€ í†µí•©

**`components/home/ai-diet-section.tsx`**:

```typescript
"use client";

import { useEffect, useState } from "react";
import { useUser } from "@clerk/nextjs";
import { FamilyDietTabs } from "@/components/diet/family-diet-tabs";
import type { FamilyMember, UserHealthProfile } from "@/types/family";
import type { FamilyDietPlan, DailyDietPlan } from "@/types/recipe";
import { calculateMemberGoalCalories, calculateUserGoalCalories } from "@/lib/diet/calorie-calculator";
import { calculateAge } from "@/lib/utils/age-calculator";

export function AIDietSection() {
  const { user } = useUser();
  const [familyMembers, setFamilyMembers] = useState<FamilyMember[]>([]);
  const [goalCaloriesMap, setGoalCaloriesMap] = useState<Record<string, number>>({});
  const [userProfile, setUserProfile] = useState<UserHealthProfile | null>(null);
  const [userGoalCalories, setUserGoalCalories] = useState<number | undefined>();
  const [dietPlan, setDietPlan] = useState<FamilyDietPlan | DailyDietPlan | null>(null);
  const [hasFamily, setHasFamily] = useState(false);

  useEffect(() => {
    checkUserStatus();
    fetchTodayDiet();
  }, []);

  async function checkUserStatus() {
    try {
      // 1. ê°€ì¡± êµ¬ì„±ì› ì¡°íšŒ
      const membersRes = await fetch("/api/family/members");
      if (membersRes.ok) {
        const membersData = await membersRes.json();
        const members = membersData.data || [];
        setFamilyMembers(members);
        setHasFamily(members.length > 0);

        // 2. ê° êµ¬ì„±ì›ì˜ ëª©í‘œ ì¹¼ë¡œë¦¬ ê³„ì‚°
        const caloriesMap: Record<string, number> = {};
        members.forEach((member: FamilyMember) => {
          const ageInfo = calculateAge(member.birth_date);
          const goalCalories = calculateMemberGoalCalories(member, ageInfo.isChild);
          caloriesMap[member.id] = goalCalories;
        });
        setGoalCaloriesMap(caloriesMap);
      }

      // 3. ì‚¬ìš©ì ë³¸ì¸ ê±´ê°• í”„ë¡œí•„ ì¡°íšŒ
      const profileRes = await fetch("/api/health/profile");
      if (profileRes.ok) {
        const profileData = await profileRes.json();
        if (profileData.data) {
          setUserProfile(profileData.data);
          const userCalories = calculateUserGoalCalories(profileData.data);
          setUserGoalCalories(userCalories);
        }
      }
    } catch (error) {
      console.error("ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:", error);
    }
  }

  async function fetchTodayDiet() {
    try {
      const today = new Date().toISOString().split("T")[0];
      
      if (hasFamily) {
        // ê°€ì¡± ì‹ë‹¨ ì¡°íšŒ
        const res = await fetch(`/api/family/diet/${today}`);
        if (res.ok) {
          const data = await res.json();
          setDietPlan(data.data);
        }
      } else {
        // ê°œì¸ ì‹ë‹¨ ì¡°íšŒ
        const res = await fetch(`/api/diet/personal?date=${today}`);
        if (res.ok) {
          const data = await res.json();
          setDietPlan(data.data);
        }
      }
    } catch (error) {
      console.error("ì‹ë‹¨ ì¡°íšŒ ì‹¤íŒ¨:", error);
    }
  }

  return (
    <section className="py-8">
      <h2 className="text-2xl font-bold mb-4">ì˜¤ëŠ˜ì˜ ì¶”ì²œ ì‹ë‹¨</h2>
      
      {hasFamily ? (
        <FamilyDietTabs
          familyMembers={familyMembers}
          goalCaloriesMap={goalCaloriesMap}
          familyDietPlan={dietPlan as FamilyDietPlan}
          userProfile={userProfile || undefined}
          userGoalCalories={userGoalCalories}
          userDietPlan={(dietPlan as FamilyDietPlan)?.individualPlans?.["user"]}
          userName={user?.firstName || "ë‚˜"}
        />
      ) : (
        <DailyDietView
          dietPlan={dietPlan as DailyDietPlan}
          memberName={user?.firstName || "ë‚˜"}
        />
      )}
    </section>
  );
}
```

---

## íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### 1. ë°˜ì°¬ì´ 3ê°œì”© ì¤‘ë³µë˜ëŠ” ë¬¸ì œ

**ì¦ìƒ**: ê°™ì€ ë°˜ì°¬ì´ ë°˜ì°¬ 1, ë°˜ì°¬ 2, ë°˜ì°¬ 3ì— ëª¨ë‘ í‘œì‹œë¨

**ì›ì¸**: í´ë°± ë ˆì‹œí”¼ ì„ íƒ ì‹œ ì¤‘ë³µ ë°©ì§€ ë¡œì§ì´ ì—†ìŒ

**í•´ê²°**:
```typescript
// generateFallbackRecipe í•¨ìˆ˜ì— excludeNames íŒŒë¼ë¯¸í„° ì¶”ê°€
export function generateFallbackRecipe(
  mealType: "breakfast" | "lunch" | "dinner",
  dishType: "rice" | "side" | "soup" | "stew",
  targetCalories: number,
  excludeNames: string[] = []  // ì¤‘ë³µ ë°©ì§€ìš©
): RecipeDetail {
  let recipes = FALLBACK_RECIPES[mealType]?.[dishType] || [];
  
  // ì œì™¸ ëª©ë¡ í•„í„°ë§
  if (excludeNames.length > 0) {
    const filtered = recipes.filter(r => !excludeNames.includes(r.name));
    if (filtered.length > 0) {
      recipes = filtered;
    }
  }
  
  // ë‚˜ë¨¸ì§€ ë¡œì§...
}
```

---

### 2. ì¹¼ë¡œë¦¬ê°€ ì˜ˆìƒë³´ë‹¤ ë†’ê±°ë‚˜ ë‚®ê²Œ ê³„ì‚°ë¨

**ì¦ìƒ**: ì‚¬ìš©ìê°€ 1940kcalë¡œ ê³„ì‚°ë˜ëŠ” ì´ìœ ë¥¼ ëª¨ë¥´ê² ìŒ

**ì›ì¸**: Harris-Benedict ê³µì‹ì˜ ì´í•´ ë¶€ì¡±

**ì„¤ëª…**:
```typescript
// ì˜ˆì‹œ: 40ì„¸ ì—¬ì„±, 160cm, 60kg, ì•‰ì•„ì„œ ìƒí™œ, ë‹¹ë‡¨
const bmr = 447.593 + (9.247 Ã— 60) + (3.098 Ã— 160) - (4.33 Ã— 40)
         = 1325 kcal

const activityCalories = bmr Ã— 1.2 (sedentary)
                       = 1590 kcal

const finalCalories = activityCalories Ã— 0.85 (ë‹¹ë‡¨ ì¡°ì •)
                    = 1352 kcal â‰ˆ 1360 kcal
```

**í™•ì¸ ë°©ë²•**:
- ì½˜ì†” ë¡œê·¸ì—ì„œ BMR, í™œë™ ê³„ìˆ˜, ì§ˆë³‘ ì¡°ì • ê³„ìˆ˜ í™•ì¸
- `calculateDailyCalories` í•¨ìˆ˜ì— `console.group` ì¶”ê°€ë¨

---

### 3. ì‹ì•½ì²˜ API ì—°ê²° ì‹¤íŒ¨

**ì¦ìƒ**: `HTTP Status: 500 Internal Server Error`

**ì›ì¸**: ì‹ì•½ì²˜ APIëŠ” "LINK" íƒ€ì…ì´ë©°, ì§ì ‘ ì‹ ì²­ í•„ìš”

**í•´ê²°**:
1. [ì‹í’ˆì•ˆì „ë‚˜ë¼](https://www.foodsafetykorea.go.kr/api/) ì ‘ì†
2. íšŒì› ê°€ì… í›„ API ì‹ ì²­
3. ìŠ¹ì¸ í›„ API í‚¤ ë°œê¸‰
4. í˜„ì¬ëŠ” Edamam API ì‚¬ìš© ì¤‘, ì‹ì•½ì²˜ APIëŠ” í–¥í›„ í†µí•© ì˜ˆì •

---

### 4. RLS ê¶Œí•œ ì˜¤ë¥˜

**ì¦ìƒ**: `new row violates row-level security policy`

**ì›ì¸**: RLSê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë‚˜ ì •ì±…ì´ ì—†ìŒ

**í•´ê²°**:
```sql
-- ê°œë°œ í™˜ê²½: RLS ë¹„í™œì„±í™”
ALTER TABLE public.diet_plans DISABLE ROW LEVEL SECURITY;

-- í”„ë¡œë•ì…˜: ì ì ˆí•œ RLS ì •ì±… ì„¤ì •
ALTER TABLE public.diet_plans ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own diet plans"
  ON public.diet_plans FOR SELECT
  USING (auth.jwt() ->> 'sub' = user_id);

CREATE POLICY "Users can insert own diet plans"
  ON public.diet_plans FOR INSERT
  WITH CHECK (auth.jwt() ->> 'sub' = user_id);
```

---

### 5. ë©”ë‰´ê°€ ë§¤ì¼ ë°˜ë³µë¨

**ì¦ìƒ**: ê°™ì€ ë©”ë‰´ê°€ ê³„ì† ë‚˜ì˜´

**ì›ì¸**: ë ˆì‹œí”¼ ì‚¬ìš© ì´ë ¥ ì¶”ì ì´ ì œëŒ€ë¡œ ì‘ë™í•˜ì§€ ì•ŠìŒ

**í•´ê²°**:
```typescript
// ë ˆì‹œí”¼ ì„ íƒ í›„ ë°˜ë“œì‹œ ì´ë ¥ ê¸°ë¡
await trackRecipeUsage(userId, recipe.title, mealType);

// ì„ íƒ ì „ ìµœê·¼ ì‚¬ìš© ì—¬ë¶€ í™•ì¸
const recentlyUsed = await checkRecentlyUsed(userId, recipe.title, 30);
if (recentlyUsed) {
  // ìš°ì„ ìˆœìœ„ ë‚®ì¶¤ (ì™„ì „ ì œì™¸ëŠ” ì•„ë‹˜)
}
```

---

## ë°°í¬

### Vercel ë°°í¬

```bash
# Vercel CLI ì„¤ì¹˜
npm install -g vercel

# ë¡œê·¸ì¸
vercel login

# í”„ë¡œì íŠ¸ ë°°í¬
vercel

# í”„ë¡œë•ì…˜ ë°°í¬
vercel --prod
```

### í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

Vercel Dashboard â†’ Project â†’ Settings â†’ Environment Variablesì—ì„œ ëª¨ë“  í™˜ê²½ ë³€ìˆ˜ ì¶”ê°€

---

## ì„±ëŠ¥ ìµœì í™” íŒ

1. **ë ˆì‹œí”¼ ê²€ìƒ‰ ìºì‹±**: Redis ë˜ëŠ” Next.js ìºì‹± ì‚¬ìš©
2. **ë³‘ë ¬ ì²˜ë¦¬**: ê°€ì¡± êµ¬ì„±ì›ë³„ ì‹ë‹¨ ìƒì„± ì‹œ `Promise.all` í™œìš©
3. **í´ë°± ìš°ì„ **: API ì‹¤íŒ¨ ì‹œ ë¹ ë¥´ê²Œ í´ë°± ë ˆì‹œí”¼ ì œê³µ
4. **ì¸ë±ìŠ¤ ìµœì í™”**: ìì£¼ ì¡°íšŒí•˜ëŠ” ì»¬ëŸ¼ì— ì¸ë±ìŠ¤ ìƒì„±
5. **ì´ë ¥ ì •ë¦¬**: 90ì¼ ì´ìƒ ëœ ë ˆì‹œí”¼ ì´ë ¥ ì£¼ê¸°ì ìœ¼ë¡œ ì‚­ì œ

---

## êµ¬ë… ê¸°ë°˜ ê°€ì¡± êµ¬ì„±ì› ì œí•œ

### ê°œìš”

êµ¬ë… ë“±ê¸‰ì— ë”°ë¼ ì¶”ê°€ ê°€ëŠ¥í•œ ê°€ì¡± êµ¬ì„±ì› ìˆ˜ë¥¼ ì œí•œí•©ë‹ˆë‹¤.

### íƒ€ì… ì •ì˜

**`types/subscription.ts`** (ì‹ ê·œ íŒŒì¼):

```typescript
/**
 * @file types/subscription.ts
 * @description êµ¬ë… ê´€ë ¨ íƒ€ì… ì •ì˜
 */

export type SubscriptionPlan = "free" | "single" | "premium" | "enterprise";

export interface SubscriptionLimits {
  maxFamilyMembers: number;
  features: string[];
}

export const SUBSCRIPTION_LIMITS: Record<SubscriptionPlan, SubscriptionLimits> = {
  free: {
    maxFamilyMembers: 1,
    features: ["ê¸°ë³¸ ì‹ë‹¨ ì¶”ì²œ", "ê°œì¸ ê±´ê°• í”„ë¡œí•„"],
  },
  single: {
    maxFamilyMembers: 1,
    features: ["ê¸°ë³¸ ì‹ë‹¨ ì¶”ì²œ", "ê°œì¸ ê±´ê°• í”„ë¡œí•„", "ì œì²  ê³¼ì¼ ê°„ì‹"],
  },
  premium: {
    maxFamilyMembers: 8,
    features: [
      "ê°€ì¡± í†µí•© ì‹ë‹¨",
      "ê°œì¸ë³„ ë§ì¶¤ ì‹ë‹¨",
      "ì œì²  ê³¼ì¼ ê°„ì‹",
      "ì‹ë‹¨ íˆìŠ¤í† ë¦¬",
      "ì˜ì–‘ ë¶„ì„ ë¦¬í¬íŠ¸",
    ],
  },
  enterprise: {
    maxFamilyMembers: 20,
    features: [
      "ëª¨ë“  premium ê¸°ëŠ¥",
      "ìš°ì„  ê³ ê° ì§€ì›",
      "ë§ì¶¤í˜• ë ˆì‹œí”¼ ì¶”ê°€",
      "API ì ‘ê·¼",
    ],
  },
};

/**
 * ê°€ì¡± êµ¬ì„±ì› ì¶”ê°€ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
 */
export function canAddFamilyMember(
  currentMemberCount: number,
  subscriptionPlan: SubscriptionPlan
): boolean {
  const limit = SUBSCRIPTION_LIMITS[subscriptionPlan].maxFamilyMembers;
  return currentMemberCount < limit;
}

/**
 * ë‚¨ì€ ì¶”ê°€ ê°€ëŠ¥ ìŠ¬ë¡¯ ìˆ˜
 */
export function getRemainingSlots(
  currentMemberCount: number,
  subscriptionPlan: SubscriptionPlan
): number {
  const limit = SUBSCRIPTION_LIMITS[subscriptionPlan].maxFamilyMembers;
  return Math.max(0, limit - currentMemberCount);
}
```

### ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

**`supabase/migrations/20251124060000_user_subscriptions.sql`**:

```sql
-- ì‚¬ìš©ì êµ¬ë… ì •ë³´ í…Œì´ë¸”
CREATE TABLE IF NOT EXISTS public.user_subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE UNIQUE,
  subscription_plan TEXT NOT NULL DEFAULT 'free' 
    CHECK (subscription_plan IN ('free', 'single', 'premium', 'enterprise')),
  started_at TIMESTAMPTZ DEFAULT now(),
  expires_at TIMESTAMPTZ,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_user_subscriptions_user_id ON public.user_subscriptions(user_id);
CREATE INDEX idx_user_subscriptions_plan ON public.user_subscriptions(subscription_plan);
CREATE INDEX idx_user_subscriptions_active ON public.user_subscriptions(is_active);

-- updated_at íŠ¸ë¦¬ê±°
CREATE TRIGGER update_user_subscriptions_updated_at
  BEFORE UPDATE ON public.user_subscriptions
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- RLS ë¹„í™œì„±í™”
ALTER TABLE public.user_subscriptions DISABLE ROW LEVEL SECURITY;

-- ê¶Œí•œ ë¶€ì—¬
GRANT ALL ON TABLE public.user_subscriptions TO anon, authenticated, service_role;

-- ê¸°ë³¸ êµ¬ë… ìƒì„± íŠ¸ë¦¬ê±° (ì‚¬ìš©ì ìƒì„± ì‹œ ìë™ìœ¼ë¡œ free í”Œëœ í• ë‹¹)
CREATE OR REPLACE FUNCTION create_default_subscription()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.user_subscriptions (user_id, subscription_plan)
  VALUES (NEW.id, 'free');
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER on_user_created_create_subscription
  AFTER INSERT ON public.users
  FOR EACH ROW
  EXECUTE FUNCTION create_default_subscription();
```

### API ì—”ë“œí¬ì¸íŠ¸

**`app/api/family/members/route.ts`** (ìˆ˜ì •):

```typescript
import { NextRequest, NextResponse } from "next/server";
import { auth } from "@clerk/nextjs/server";
import { createClerkSupabaseClient } from "@/lib/supabase/server";
import { canAddFamilyMember, SUBSCRIPTION_LIMITS } from "@/types/subscription";

// ê°€ì¡± êµ¬ì„±ì› ì¶”ê°€
export async function POST(request: NextRequest) {
  try {
    const { userId: clerkUserId } = await auth();
    if (!clerkUserId) {
      return NextResponse.json(
        { success: false, error: "Unauthorized" },
        { status: 401 }
      );
    }

    const supabase = await createClerkSupabaseClient();
    
    // 1. ì‚¬ìš©ì ì¡°íšŒ
    const { data: userData } = await supabase
      .from("users")
      .select("id")
      .eq("clerk_id", clerkUserId)
      .single();

    if (!userData) {
      return NextResponse.json(
        { success: false, error: "ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." },
        { status: 404 }
      );
    }

    // 2. êµ¬ë… ì •ë³´ ì¡°íšŒ
    const { data: subscription } = await supabase
      .from("user_subscriptions")
      .select("subscription_plan, is_active")
      .eq("user_id", userData.id)
      .single();

    const subscriptionPlan = subscription?.is_active 
      ? subscription.subscription_plan 
      : "free";

    // 3. í˜„ì¬ ê°€ì¡± êµ¬ì„±ì› ìˆ˜ í™•ì¸
    const { data: currentMembers, count } = await supabase
      .from("family_members")
      .select("id", { count: "exact" })
      .eq("user_id", userData.id);

    const currentCount = count || 0;

    // 4. ì¶”ê°€ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
    if (!canAddFamilyMember(currentCount, subscriptionPlan)) {
      const limit = SUBSCRIPTION_LIMITS[subscriptionPlan].maxFamilyMembers;
      return NextResponse.json(
        {
          success: false,
          error: `êµ¬ë… í”Œëœ(${subscriptionPlan})ì˜ ê°€ì¡± êµ¬ì„±ì› ì œí•œ(${limit}ëª…)ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.`,
          currentCount,
          limit,
          needsUpgrade: true,
        },
        { status: 403 }
      );
    }

    // 5. ê°€ì¡± êµ¬ì„±ì› ì¶”ê°€
    const body = await request.json();
    const { data: newMember, error } = await supabase
      .from("family_members")
      .insert({
        user_id: userData.id,
        ...body,
      })
      .select()
      .single();

    if (error) {
      throw error;
    }

    return NextResponse.json({
      success: true,
      data: newMember,
      message: "ê°€ì¡± êµ¬ì„±ì›ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.",
    });
  } catch (error) {
    console.error("ê°€ì¡± êµ¬ì„±ì› ì¶”ê°€ ì‹¤íŒ¨:", error);
    return NextResponse.json(
      {
        success: false,
        error: error instanceof Error ? error.message : "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
      },
      { status: 500 }
    );
  }
}
```

---

## ì¶”ê°€ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼

### ì§ˆë³‘ë³„ ì œì™¸ ìŒì‹ í™•ì¥

**`supabase/migrations/20251124050242_expand_disease_excluded_foods.sql`**:

```sql
-- ì§ˆë³‘ë³„ ì œì™¸ ìŒì‹ ë°ì´í„° í™•ì¥ (186ê°œ í•­ëª©)

-- ê¸°ì¡´ ë°ì´í„° ì‚­ì œ (ì¬ì‹¤í–‰ ì‹œ)
DELETE FROM public.disease_excluded_foods;

-- ë‹¹ë‡¨ë³‘ (diabetes) - 35ê°œ í•­ëª©
INSERT INTO public.disease_excluded_foods 
  (disease, excluded_food_type, food_name, reason, severity)
VALUES
  ('diabetes', 'ingredient', 'ì„¤íƒ•', 'í˜ˆë‹¹ ìƒìŠ¹ì˜ ì£¼ìš” ì›ì¸', 'high'),
  ('diabetes', 'ingredient', 'ê¿€', 'ë‹¹ë¶„ í•¨ëŸ‰ ë†’ìŒ', 'high'),
  ('diabetes', 'ingredient', 'ì‹œëŸ½', 'ë‹¹ë¶„ ë†ì¶•', 'high'),
  ('diabetes', 'ingredient', 'ì‚¬íƒ•', 'ìˆœìˆ˜ ë‹¹ë¶„', 'high'),
  ('diabetes', 'ingredient', 'ì´ˆì½œë¦¿', 'ë‹¹ë¶„ê³¼ ì§€ë°© ê³¼ë‹¤', 'high'),
  ('diabetes', 'ingredient', 'ì¼€ì´í¬', 'ë‹¹ë¶„ê³¼ ì •ì œ íƒ„ìˆ˜í™”ë¬¼', 'high'),
  ('diabetes', 'ingredient', 'ì¿ í‚¤', 'ë‹¹ë¶„ê³¼ ì •ì œ íƒ„ìˆ˜í™”ë¬¼', 'high'),
  ('diabetes', 'ingredient', 'ë¹™ê³¼ë¥˜', 'ë‹¹ë¶„ê³¼ ì¹¼ë¡œë¦¬ ê³¼ë‹¤', 'high'),
  ('diabetes', 'ingredient', 'íƒ„ì‚°ìŒë£Œ', 'ì•¡ìƒ ë‹¹ë¶„ ë¹ ë¥¸ í¡ìˆ˜', 'high'),
  ('diabetes', 'ingredient', 'ê³¼ì¼ì£¼ìŠ¤', 'ë†ì¶• ë‹¹ë¶„', 'medium'),
  ('diabetes', 'ingredient', 'í°ë¹µ', 'ì •ì œ íƒ„ìˆ˜í™”ë¬¼', 'medium'),
  ('diabetes', 'ingredient', 'í°ìŒ€', 'ì •ì œ íƒ„ìˆ˜í™”ë¬¼', 'medium'),
  ('diabetes', 'ingredient', 'ë–¡', 'ì •ì œ íƒ„ìˆ˜í™”ë¬¼ê³¼ ë‹¹ë¶„', 'medium'),
  ('diabetes', 'recipe_keyword', 'íŠ€ê¹€', 'ê¸°ë¦„ê³¼ ì¹¼ë¡œë¦¬ ë†’ìŒ', 'medium'),
  ('diabetes', 'recipe_keyword', 'ë‹¬ë‹¬í•œ', 'ë‹¹ë¶„ í•¨ëŸ‰ ë†’ìŒ', 'high'),
  ('diabetes', 'recipe_keyword', 'ë‹¬ì½¤í•œ', 'ë‹¹ë¶„ í•¨ëŸ‰ ë†’ìŒ', 'high'),
  ('diabetes', 'recipe_keyword', 'ë‹¨ë§›', 'ë‹¹ë¶„ í•¨ëŸ‰ ë†’ìŒ', 'high'),
  ('diabetes', 'recipe_keyword', 'ë””ì €íŠ¸', 'ë‹¹ë¶„ê³¼ ì§€ë°© ê³¼ë‹¤', 'high'),
  ('diabetes', 'ingredient', 'ê³¼ì', 'ë‹¹ë¶„ê³¼ ì •ì œ íƒ„ìˆ˜í™”ë¬¼', 'high'),
  ('diabetes', 'ingredient', 'ì ¤ë¦¬', 'ìˆœìˆ˜ ë‹¹ë¶„', 'high'),
  ('diabetes', 'ingredient', 'ìº”ë””', 'ìˆœìˆ˜ ë‹¹ë¶„', 'high'),
  ('diabetes', 'ingredient', 'íŒŒì´', 'ë‹¹ë¶„ê³¼ ì§€ë°© ê³¼ë‹¤', 'high'),
  ('diabetes', 'ingredient', 'ë„ë„›', 'ë‹¹ë¶„ê³¼ ê¸°ë¦„', 'high'),
  ('diabetes', 'ingredient', 'íŒ¬ì¼€ì´í¬', 'ì •ì œ íƒ„ìˆ˜í™”ë¬¼ê³¼ ì‹œëŸ½', 'medium'),
  ('diabetes', 'ingredient', 'ì™€í”Œ', 'ì •ì œ íƒ„ìˆ˜í™”ë¬¼ê³¼ ì‹œëŸ½', 'medium'),
  ('diabetes', 'ingredient', 'ì•„ì´ìŠ¤í¬ë¦¼', 'ë‹¹ë¶„ê³¼ ì§€ë°© ê³¼ë‹¤', 'high'),
  ('diabetes', 'ingredient', 'í‘¸ë”©', 'ë‹¹ë¶„ í•¨ëŸ‰ ë†’ìŒ', 'medium'),
  ('diabetes', 'ingredient', 'ìš”ê±°íŠ¸ (ê°€ë‹¹)', 'ì²¨ê°€ë‹¹ ë†’ìŒ', 'medium'),
  ('diabetes', 'ingredient', 'ì‹œë¦¬ì–¼ (ê°€ë‹¹)', 'ë‹¹ë¶„ê³¼ ì •ì œ íƒ„ìˆ˜í™”ë¬¼', 'medium'),
  ('diabetes', 'ingredient', 'ì—ë„ˆì§€ë°”', 'ìˆ¨ì€ ë‹¹ë¶„', 'medium'),
  ('diabetes', 'ingredient', 'ê·¸ë˜ë†€ë¼', 'ë‹¹ë¶„ í•¨ëŸ‰ ë†’ìŒ', 'medium'),
  ('diabetes', 'ingredient', 'ì½œë¼', 'ì•¡ìƒ ë‹¹ë¶„', 'high'),
  ('diabetes', 'ingredient', 'ì‚¬ì´ë‹¤', 'ì•¡ìƒ ë‹¹ë¶„', 'high'),
  ('diabetes', 'ingredient', 'ìŠ¤í¬ì¸ ìŒë£Œ', 'ë‹¹ë¶„ í•¨ëŸ‰ ë†’ìŒ', 'medium'),
  ('diabetes', 'ingredient', 'ì—ë„ˆì§€ë“œë§í¬', 'ë‹¹ë¶„ê³¼ ì¹´í˜ì¸', 'medium');

-- ê³ í˜ˆì•• (hypertension) - 40ê°œ í•­ëª©
INSERT INTO public.disease_excluded_foods 
  (disease, excluded_food_type, food_name, reason, severity)
VALUES
  ('hypertension', 'ingredient', 'ì†Œê¸ˆ', 'ë‚˜íŠ¸ë¥¨ ê³¼ë‹¤ ì„­ì·¨', 'high'),
  ('hypertension', 'ingredient', 'ê°„ì¥', 'ë‚˜íŠ¸ë¥¨ í•¨ëŸ‰ ë†’ìŒ', 'high'),
  ('hypertension', 'ingredient', 'ëœì¥', 'ë‚˜íŠ¸ë¥¨ í•¨ëŸ‰ ë†’ìŒ', 'medium'),
  ('hypertension', 'ingredient', 'ê³ ì¶”ì¥', 'ë‚˜íŠ¸ë¥¨ í•¨ëŸ‰ ë†’ìŒ', 'medium'),
  ('hypertension', 'ingredient', 'ìŒˆì¥', 'ë‚˜íŠ¸ë¥¨ í•¨ëŸ‰ ë†’ìŒ', 'medium'),
  ('hypertension', 'recipe_keyword', 'ì§ ë§›', 'ë‚˜íŠ¸ë¥¨ ê³¼ë‹¤', 'high'),
  ('hypertension', 'recipe_keyword', 'ì§œê²Œ', 'ë‚˜íŠ¸ë¥¨ ê³¼ë‹¤', 'high'),
  ('hypertension', 'ingredient', 'í–„', 'ê°€ê³µ ì‹í’ˆ, ë‚˜íŠ¸ë¥¨ ë†’ìŒ', 'high'),
  ('hypertension', 'ingredient', 'ì†Œì‹œì§€', 'ê°€ê³µ ì‹í’ˆ, ë‚˜íŠ¸ë¥¨ ë†’ìŒ', 'high'),
  ('hypertension', 'ingredient', 'ë² ì´ì»¨', 'ê°€ê³µ ìœ¡ë¥˜, ë‚˜íŠ¸ë¥¨ ë†’ìŒ', 'high'),
  ('hypertension', 'ingredient', 'ìŠ¤íŒ¸', 'ê°€ê³µ ìœ¡ë¥˜, ë‚˜íŠ¸ë¥¨ ë†’ìŒ', 'high'),
  ('hypertension', 'ingredient', 'ì¹˜ì¦ˆ', 'ë‚˜íŠ¸ë¥¨ê³¼ ì§€ë°© ë†’ìŒ', 'medium'),
  ('hypertension', 'ingredient', 'í”¼í´', 'ì†Œê¸ˆ ì ˆì„', 'high'),
  ('hypertension', 'ingredient', 'ê¹€ì¹˜', 'ì†Œê¸ˆ ì ˆì„', 'medium'),
  ('hypertension', 'ingredient', 'ì “ê°ˆ', 'ì†Œê¸ˆ ë†ì¶•', 'high'),
  ('hypertension', 'ingredient', 'ë©¸ì¹˜', 'ë‚˜íŠ¸ë¥¨ ë†’ìŒ', 'medium'),
  ('hypertension', 'ingredient', 'ë¼ë©´', 'ë‚˜íŠ¸ë¥¨ ê³¼ë‹¤', 'high'),
  ('hypertension', 'ingredient', 'í†µì¡°ë¦¼', 'ë‚˜íŠ¸ë¥¨ í•¨ëŸ‰ ë†’ìŒ', 'medium'),
  ('hypertension', 'ingredient', 'ëƒ‰ë™ì‹í’ˆ', 'ë‚˜íŠ¸ë¥¨ í•¨ëŸ‰ ë†’ìŒ', 'medium'),
  ('hypertension', 'recipe_keyword', 'êµ­ë¬¼', 'ë‚˜íŠ¸ë¥¨ ë†ì¶•', 'medium'),
  ('hypertension', 'recipe_keyword', 'ì°Œê°œ', 'ë‚˜íŠ¸ë¥¨ í•¨ëŸ‰ ë†’ìŒ', 'medium'),
  ('hypertension', 'recipe_keyword', 'ì¡°ë¦¼', 'ê°„ì¥ ì‚¬ìš©', 'medium'),
  ('hypertension', 'ingredient', 'ì¥ì•„ì°Œ', 'ì†Œê¸ˆ ì ˆì„', 'high'),
  ('hypertension', 'ingredient', 'ë§ˆìš”ë„¤ì¦ˆ', 'ë‚˜íŠ¸ë¥¨ê³¼ ì§€ë°© ë†’ìŒ', 'medium'),
  ('hypertension', 'ingredient', 'ì¼€ì²©', 'ë‚˜íŠ¸ë¥¨ê³¼ ë‹¹ë¶„', 'medium'),
  ('hypertension', 'ingredient', 'ë¨¸ìŠ¤íƒ€ë“œ', 'ë‚˜íŠ¸ë¥¨ í•¨ëŸ‰ ë†’ìŒ', 'medium'),
  ('hypertension', 'ingredient', 'êµ´ì†ŒìŠ¤', 'ë‚˜íŠ¸ë¥¨ í•¨ëŸ‰ ë†’ìŒ', 'high'),
  ('hypertension', 'ingredient', 'ì¹ ë¦¬ì†ŒìŠ¤', 'ë‚˜íŠ¸ë¥¨ê³¼ ë‹¹ë¶„', 'medium'),
  ('hypertension', 'ingredient', 'íƒ€ë°”ìŠ¤ì½”', 'ë‚˜íŠ¸ë¥¨ í•¨ëŸ‰ ë†’ìŒ', 'medium'),
  ('hypertension', 'ingredient', 'í›„ì¶”', 'ë‚˜íŠ¸ë¥¨ í•¨ëŸ‰ (ê³¼ë‹¤ ì‚¬ìš© ì‹œ)', 'low'),
  ('hypertension', 'ingredient', 'ì¡°ë¯¸ë£Œ', 'ë‚˜íŠ¸ë¥¨ í•¨ëŸ‰ ë†’ìŒ', 'high'),
  ('hypertension', 'ingredient', 'ì¹˜í‚¨', 'ë‚˜íŠ¸ë¥¨ê³¼ ê¸°ë¦„', 'medium'),
  ('hypertension', 'ingredient', 'í”¼ì', 'ë‚˜íŠ¸ë¥¨ê³¼ ì§€ë°© ê³¼ë‹¤', 'medium'),
  ('hypertension', 'ingredient', 'í–„ë²„ê±°', 'ë‚˜íŠ¸ë¥¨ê³¼ ì§€ë°© ê³¼ë‹¤', 'medium'),
  ('hypertension', 'ingredient', 'ìƒŒë“œìœ„ì¹˜ (ê°€ê³µìœ¡)', 'ë‚˜íŠ¸ë¥¨ í•¨ëŸ‰ ë†’ìŒ', 'medium'),
  ('hypertension', 'ingredient', 'ìŠ¤ë‚µ', 'ë‚˜íŠ¸ë¥¨ í•¨ëŸ‰ ë†’ìŒ', 'medium'),
  ('hypertension', 'ingredient', 'ê³¼ì', 'ë‚˜íŠ¸ë¥¨ê³¼ ë‹¹ë¶„', 'low'),
  ('hypertension', 'ingredient', 'ê°ìì¹©', 'ë‚˜íŠ¸ë¥¨ê³¼ ì§€ë°©', 'medium'),
  ('hypertension', 'ingredient', 'ìƒˆìš°ê¹¡', 'ë‚˜íŠ¸ë¥¨ í•¨ëŸ‰ ë†’ìŒ', 'medium'),
  ('hypertension', 'ingredient', 'í¬í…Œì´í† ì¹©', 'ë‚˜íŠ¸ë¥¨ê³¼ ì§€ë°©', 'medium');

-- í†µí’ (gout) - 30ê°œ í•­ëª©
INSERT INTO public.disease_excluded_foods 
  (disease, excluded_food_type, food_name, reason, severity)
VALUES
  ('gout', 'ingredient', 'ë“±í‘¸ë¥¸ìƒì„ ', 'í“¨ë¦° í•¨ëŸ‰ ë†’ìŒ', 'high'),
  ('gout', 'ingredient', 'ê³ ë“±ì–´', 'í“¨ë¦° í•¨ëŸ‰ ë†’ìŒ', 'high'),
  ('gout', 'ingredient', 'ê½ì¹˜', 'í“¨ë¦° í•¨ëŸ‰ ë†’ìŒ', 'high'),
  ('gout', 'ingredient', 'ì²­ì–´', 'í“¨ë¦° í•¨ëŸ‰ ë†’ìŒ', 'high'),
  ('gout', 'ingredient', 'ì •ì–´ë¦¬', 'í“¨ë¦° í•¨ëŸ‰ ë§¤ìš° ë†’ìŒ', 'high'),
  ('gout', 'ingredient', 'ë©¸ì¹˜', 'í“¨ë¦° í•¨ëŸ‰ ë†’ìŒ', 'high'),
  ('gout', 'ingredient', 'ìƒˆìš°', 'í“¨ë¦° í•¨ëŸ‰ ë†’ìŒ', 'high'),
  ('gout', 'ingredient', 'ì¡°ê°œ', 'í“¨ë¦° í•¨ëŸ‰ ë†’ìŒ', 'high'),
  ('gout', 'ingredient', 'ë‚´ì¥', 'í“¨ë¦° í•¨ëŸ‰ ë§¤ìš° ë†’ìŒ', 'high'),
  ('gout', 'ingredient', 'ê°„', 'í“¨ë¦° í•¨ëŸ‰ ë§¤ìš° ë†’ìŒ', 'high'),
  ('gout', 'ingredient', 'ì†Œê°„', 'í“¨ë¦° í•¨ëŸ‰ ë§¤ìš° ë†’ìŒ', 'high'),
  ('gout', 'ingredient', 'ë‹­ê°„', 'í“¨ë¦° í•¨ëŸ‰ ë§¤ìš° ë†’ìŒ', 'high'),
  ('gout', 'ingredient', 'ê³±ì°½', 'í“¨ë¦° í•¨ëŸ‰ ë†’ìŒ', 'high'),
  ('gout', 'ingredient', 'ìœ¡ë¥˜', 'í“¨ë¦° í•¨ëŸ‰ ë†’ìŒ', 'medium'),
  ('gout', 'ingredient', 'ì†Œê³ ê¸°', 'í“¨ë¦° í•¨ëŸ‰ ì¤‘ê°„', 'medium'),
  ('gout', 'ingredient', 'ë¼ì§€ê³ ê¸°', 'í“¨ë¦° í•¨ëŸ‰ ì¤‘ê°„', 'medium'),
  ('gout', 'ingredient', 'ì–‘ê³ ê¸°', 'í“¨ë¦° í•¨ëŸ‰ ë†’ìŒ', 'medium'),
  ('gout', 'recipe_keyword', 'ë§¥ì£¼', 'ì•Œì½”ì˜¬ê³¼ í“¨ë¦°', 'high'),
  ('gout', 'recipe_keyword', 'ìˆ ', 'ì•Œì½”ì˜¬ ê¸ˆì§€', 'high'),
  ('gout', 'ingredient', 'ë§¥ì£¼', 'ì•Œì½”ì˜¬ê³¼ í“¨ë¦°', 'high'),
  ('gout', 'ingredient', 'ì†Œì£¼', 'ì•Œì½”ì˜¬', 'high'),
  ('gout', 'ingredient', 'ì™€ì¸', 'ì•Œì½”ì˜¬', 'medium'),
  ('gout', 'ingredient', 'ë²„ì„¯', 'í“¨ë¦° í•¨ëŸ‰ ì¤‘ê°„', 'low'),
  ('gout', 'ingredient', 'ì‹œê¸ˆì¹˜', 'í“¨ë¦° í•¨ëŸ‰ ì¤‘ê°„', 'low'),
  ('gout', 'ingredient', 'ì•„ìŠ¤íŒŒë¼ê±°ìŠ¤', 'í“¨ë¦° í•¨ëŸ‰ ì¤‘ê°„', 'low'),
  ('gout', 'ingredient', 'ì½œë¦¬í”Œë¼ì›Œ', 'í“¨ë¦° í•¨ëŸ‰ ì¤‘ê°„', 'low'),
  ('gout', 'ingredient', 'ë² ì´ì»¨', 'ê°€ê³µ ìœ¡ë¥˜', 'medium'),
  ('gout', 'ingredient', 'ìœ¡ìˆ˜', 'í“¨ë¦° ë†ì¶•', 'medium'),
  ('gout', 'recipe_keyword', 'íƒ•', 'ìœ¡ìˆ˜ ì‚¬ìš©', 'medium'),
  ('gout', 'recipe_keyword', 'ì°œ', 'ìœ¡ë¥˜ ë†ì¶•', 'medium');

-- ì‹ ì¥ì§ˆí™˜ (kidney_disease) - 25ê°œ í•­ëª©
INSERT INTO public.disease_excluded_foods 
  (disease, excluded_food_type, food_name, reason, severity)
VALUES
  ('kidney_disease', 'ingredient', 'ì†Œê¸ˆ', 'ë‚˜íŠ¸ë¥¨ ì œí•œ', 'high'),
  ('kidney_disease', 'ingredient', 'ê°„ì¥', 'ë‚˜íŠ¸ë¥¨ ë†’ìŒ', 'high'),
  ('kidney_disease', 'ingredient', 'ëœì¥', 'ë‚˜íŠ¸ë¥¨ ë†’ìŒ', 'high'),
  ('kidney_disease', 'ingredient', 'ë°”ë‚˜ë‚˜', 'ì¹¼ë¥¨ ë†’ìŒ', 'high'),
  ('kidney_disease', 'ingredient', 'ì˜¤ë Œì§€', 'ì¹¼ë¥¨ ë†’ìŒ', 'high'),
  ('kidney_disease', 'ingredient', 'í† ë§ˆí† ', 'ì¹¼ë¥¨ ë†’ìŒ', 'medium'),
  ('kidney_disease', 'ingredient', 'ê°ì', 'ì¹¼ë¥¨ ë†’ìŒ', 'medium'),
  ('kidney_disease', 'ingredient', 'ê³ êµ¬ë§ˆ', 'ì¹¼ë¥¨ ë†’ìŒ', 'medium'),
  ('kidney_disease', 'ingredient', 'ì‹œê¸ˆì¹˜', 'ì¹¼ë¥¨ê³¼ ì¸ ë†’ìŒ', 'medium'),
  ('kidney_disease', 'ingredient', 'ìš°ìœ ', 'ì¸ê³¼ ì¹¼ë¥¨ ë†’ìŒ', 'medium'),
  ('kidney_disease', 'ingredient', 'ì¹˜ì¦ˆ', 'ì¸ê³¼ ë‚˜íŠ¸ë¥¨ ë†’ìŒ', 'medium'),
  ('kidney_disease', 'ingredient', 'ìš”ê±°íŠ¸', 'ì¸ê³¼ ì¹¼ë¥¨ ë†’ìŒ', 'medium'),
  ('kidney_disease', 'ingredient', 'ì½©', 'ì¸ê³¼ ì¹¼ë¥¨ ë†’ìŒ', 'medium'),
  ('kidney_disease', 'ingredient', 'ê²¬ê³¼ë¥˜', 'ì¸ê³¼ ì¹¼ë¥¨ ë†’ìŒ', 'medium'),
  ('kidney_disease', 'ingredient', 'í˜„ë¯¸', 'ì¸ í•¨ëŸ‰ ë†’ìŒ', 'low'),
  ('kidney_disease', 'ingredient', 'í†µê³¡ë¬¼', 'ì¸ í•¨ëŸ‰ ë†’ìŒ', 'low'),
  ('kidney_disease', 'recipe_keyword', 'êµ­ë¬¼', 'ë‚˜íŠ¸ë¥¨ê³¼ ì¹¼ë¥¨ ë†ì¶•', 'medium'),
  ('kidney_disease', 'ingredient', 'í–„', 'ê°€ê³µ ì‹í’ˆ, ì¸ ë†’ìŒ', 'high'),
  ('kidney_disease', 'ingredient', 'ì†Œì‹œì§€', 'ê°€ê³µ ì‹í’ˆ, ì¸ ë†’ìŒ', 'high'),
  ('kidney_disease', 'ingredient', 'ë² ì´ì»¨', 'ê°€ê³µ ìœ¡ë¥˜, ì¸ê³¼ ë‚˜íŠ¸ë¥¨', 'high'),
  ('kidney_disease', 'ingredient', 'í†µì¡°ë¦¼', 'ë‚˜íŠ¸ë¥¨ê³¼ ì¸ ë†’ìŒ', 'medium'),
  ('kidney_disease', 'ingredient', 'ì¸ìŠ¤í„´íŠ¸ì‹í’ˆ', 'ë‚˜íŠ¸ë¥¨ê³¼ ì¸ ë†’ìŒ', 'high'),
  ('kidney_disease', 'ingredient', 'ì½œë¼', 'ì¸ í•¨ëŸ‰ ë†’ìŒ', 'medium'),
  ('kidney_disease', 'ingredient', 'ì´ˆì½œë¦¿', 'ì¸ê³¼ ì¹¼ë¥¨ ë†’ìŒ', 'medium'),
  ('kidney_disease', 'ingredient', 'ì•„ë³´ì¹´ë„', 'ì¹¼ë¥¨ ë§¤ìš° ë†’ìŒ', 'high');

-- ê³ ì§€í˜ˆì¦ (hyperlipidemia) - 30ê°œ í•­ëª©
INSERT INTO public.disease_excluded_foods 
  (disease, excluded_food_type, food_name, reason, severity)
VALUES
  ('hyperlipidemia', 'ingredient', 'ë²„í„°', 'í¬í™”ì§€ë°© ë†’ìŒ', 'high'),
  ('hyperlipidemia', 'ingredient', 'ë§ˆê°€ë¦°', 'íŠ¸ëœìŠ¤ì§€ë°©', 'high'),
  ('hyperlipidemia', 'ingredient', 'ì‡¼íŠ¸ë‹', 'íŠ¸ëœìŠ¤ì§€ë°©', 'high'),
  ('hyperlipidemia', 'ingredient', 'íŒœìœ ', 'í¬í™”ì§€ë°© ë†’ìŒ', 'high'),
  ('hyperlipidemia', 'ingredient', 'ì½”ì½”ë„›ì˜¤ì¼', 'í¬í™”ì§€ë°© ë†’ìŒ', 'medium'),
  ('hyperlipidemia', 'ingredient', 'ì‚¼ê²¹ì‚´', 'í¬í™”ì§€ë°© ë†’ìŒ', 'high'),
  ('hyperlipidemia', 'ingredient', 'ê°ˆë¹„', 'í¬í™”ì§€ë°© ë†’ìŒ', 'high'),
  ('hyperlipidemia', 'ingredient', 'ë² ì´ì»¨', 'í¬í™”ì§€ë°© ë†’ìŒ', 'high'),
  ('hyperlipidemia', 'ingredient', 'ì†Œì‹œì§€', 'í¬í™”ì§€ë°© ë†’ìŒ', 'high'),
  ('hyperlipidemia', 'recipe_keyword', 'íŠ€ê¹€', 'ê¸°ë¦„ ê³¼ë‹¤', 'high'),
  ('hyperlipidemia', 'recipe_keyword', 'ë³¶ìŒ', 'ê¸°ë¦„ ì‚¬ìš©', 'medium'),
  ('hyperlipidemia', 'ingredient', 'ì¹˜í‚¨', 'ê¸°ë¦„ ê³¼ë‹¤', 'high'),
  ('hyperlipidemia', 'ingredient', 'ë„ë„›', 'íŠ¸ëœìŠ¤ì§€ë°©', 'high'),
  ('hyperlipidemia', 'ingredient', 'í¬ë£¨ì•„ìƒ', 'ë²„í„° ê³¼ë‹¤', 'high'),
  ('hyperlipidemia', 'ingredient', 'í¬ë¦¼', 'í¬í™”ì§€ë°© ë†’ìŒ', 'high'),
  ('hyperlipidemia', 'ingredient', 'íœ˜í•‘í¬ë¦¼', 'í¬í™”ì§€ë°© ë†’ìŒ', 'high'),
  ('hyperlipidemia', 'ingredient', 'ì•„ì´ìŠ¤í¬ë¦¼', 'í¬í™”ì§€ë°©ê³¼ ë‹¹ë¶„', 'medium'),
  ('hyperlipidemia', 'ingredient', 'ì¼€ì´í¬', 'í¬í™”ì§€ë°©ê³¼ ë‹¹ë¶„', 'medium'),
  ('hyperlipidemia', 'ingredient', 'ì¿ í‚¤', 'í¬í™”ì§€ë°©ê³¼ ë‹¹ë¶„', 'medium'),
  ('hyperlipidemia', 'ingredient', 'ê³¼ì', 'íŠ¸ëœìŠ¤ì§€ë°©', 'medium'),
  ('hyperlipidemia', 'ingredient', 'ë¼ë©´', 'í¬í™”ì§€ë°©ê³¼ ë‚˜íŠ¸ë¥¨', 'medium'),
  ('hyperlipidemia', 'ingredient', 'í”¼ì', 'í¬í™”ì§€ë°© ê³¼ë‹¤', 'medium'),
  ('hyperlipidemia', 'ingredient', 'í–„ë²„ê±°', 'í¬í™”ì§€ë°© ê³¼ë‹¤', 'medium'),
  ('hyperlipidemia', 'ingredient', 'ì¹˜ì¦ˆ', 'í¬í™”ì§€ë°© ë†’ìŒ', 'medium'),
  ('hyperlipidemia', 'ingredient', 'ë§ˆìš”ë„¤ì¦ˆ', 'ì§€ë°© ë†’ìŒ', 'medium'),
  ('hyperlipidemia', 'ingredient', 'ê°ìíŠ€ê¹€', 'ê¸°ë¦„ ê³¼ë‹¤', 'high'),
  ('hyperlipidemia', 'ingredient', 'ìƒˆìš°íŠ€ê¹€', 'ê¸°ë¦„ ê³¼ë‹¤', 'high'),
  ('hyperlipidemia', 'ingredient', 'ëˆê¹ŒìŠ¤', 'ê¸°ë¦„ ê³¼ë‹¤', 'high'),
  ('hyperlipidemia', 'ingredient', 'íƒ•ìˆ˜ìœ¡', 'ê¸°ë¦„ê³¼ ë‹¹ë¶„', 'high'),
  ('hyperlipidemia', 'ingredient', 'ì–‘ë…ì¹˜í‚¨', 'ê¸°ë¦„ê³¼ ë‹¹ë¶„', 'high');

-- ë¹„ë§Œ (obesity) - 26ê°œ í•­ëª©
INSERT INTO public.disease_excluded_foods 
  (disease, excluded_food_type, food_name, reason, severity)
VALUES
  ('obesity', 'ingredient', 'ì„¤íƒ•', 'ë¹ˆ ì¹¼ë¡œë¦¬', 'high'),
  ('obesity', 'recipe_keyword', 'íŠ€ê¹€', 'ì¹¼ë¡œë¦¬ ê³¼ë‹¤', 'high'),
  ('obesity', 'ingredient', 'íŒ¨ìŠ¤íŠ¸í‘¸ë“œ', 'ì¹¼ë¡œë¦¬ì™€ ì§€ë°© ê³¼ë‹¤', 'high'),
  ('obesity', 'ingredient', 'ì¹˜í‚¨', 'ì¹¼ë¡œë¦¬ì™€ ê¸°ë¦„', 'high'),
  ('obesity', 'ingredient', 'í”¼ì', 'ì¹¼ë¡œë¦¬ ê³¼ë‹¤', 'high'),
  ('obesity', 'ingredient', 'í–„ë²„ê±°', 'ì¹¼ë¡œë¦¬ ê³¼ë‹¤', 'high'),
  ('obesity', 'ingredient', 'ë¼ë©´', 'ì¹¼ë¡œë¦¬ì™€ ë‚˜íŠ¸ë¥¨', 'medium'),
  ('obesity', 'ingredient', 'ê³¼ì', 'ë¹ˆ ì¹¼ë¡œë¦¬', 'medium'),
  ('obesity', 'ingredient', 'ì•„ì´ìŠ¤í¬ë¦¼', 'ì¹¼ë¡œë¦¬ì™€ ë‹¹ë¶„', 'high'),
  ('obesity', 'ingredient', 'ì¼€ì´í¬', 'ì¹¼ë¡œë¦¬ì™€ ë‹¹ë¶„', 'high'),
  ('obesity', 'ingredient', 'ì¿ í‚¤', 'ì¹¼ë¡œë¦¬ì™€ ë‹¹ë¶„', 'medium'),
  ('obesity', 'ingredient', 'ë„ë„›', 'ì¹¼ë¡œë¦¬ì™€ ë‹¹ë¶„', 'high'),
  ('obesity', 'ingredient', 'íƒ„ì‚°ìŒë£Œ', 'ë¹ˆ ì¹¼ë¡œë¦¬', 'high'),
  ('obesity', 'ingredient', 'ì£¼ìŠ¤', 'ë‹¹ë¶„ ë†ì¶•', 'medium'),
  ('obesity', 'ingredient', 'ë¹µ', 'ì •ì œ íƒ„ìˆ˜í™”ë¬¼', 'medium'),
  ('obesity', 'ingredient', 'ë²„í„°', 'ì¹¼ë¡œë¦¬ì™€ ì§€ë°©', 'high'),
  ('obesity', 'ingredient', 'ë§ˆìš”ë„¤ì¦ˆ', 'ì¹¼ë¡œë¦¬ì™€ ì§€ë°©', 'high'),
  ('obesity', 'ingredient', 'ì‚¼ê²¹ì‚´', 'ì¹¼ë¡œë¦¬ì™€ ì§€ë°©', 'high'),
  ('obesity', 'ingredient', 'ê°ˆë¹„', 'ì¹¼ë¡œë¦¬ì™€ ì§€ë°©', 'high'),
  ('obesity', 'ingredient', 'ê°ìíŠ€ê¹€', 'ì¹¼ë¡œë¦¬ì™€ ê¸°ë¦„', 'high'),
  ('obesity', 'recipe_keyword', 'ë‹¬ë‹¬í•œ', 'ë‹¹ë¶„ ê³¼ë‹¤', 'high'),
  ('obesity', 'recipe_keyword', 'ê¸°ë¦„ì§„', 'ì§€ë°© ê³¼ë‹¤', 'high'),
  ('obesity', 'ingredient', 'ì´ˆì½œë¦¿', 'ì¹¼ë¡œë¦¬ì™€ ë‹¹ë¶„', 'medium'),
  ('obesity', 'ingredient', 'ì‚¬íƒ•', 'ë¹ˆ ì¹¼ë¡œë¦¬', 'medium'),
  ('obesity', 'ingredient', 'ì—ë„ˆì§€ë°”', 'ì¹¼ë¡œë¦¬ ë†’ìŒ', 'low'),
  ('obesity', 'ingredient', 'ê·¸ë˜ë†€ë¼', 'ë‹¹ë¶„ê³¼ ì¹¼ë¡œë¦¬', 'low');

-- ì´ 186ê°œ í•­ëª© ì‚½ì… ì™„ë£Œ
```

### ë ˆì‹œí”¼ ì‚¬ìš© ì´ë ¥ í…Œì´ë¸”

**`supabase/migrations/20251124051500_recipe_usage_history.sql`**:

```sql
-- ë ˆì‹œí”¼ ì‚¬ìš© ì´ë ¥ í…Œì´ë¸” (ë©”ë‰´ ì¤‘ë³µ ë°©ì§€ìš©)
CREATE TABLE IF NOT EXISTS public.recipe_usage_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  family_member_id UUID REFERENCES public.family_members(id) ON DELETE CASCADE,
  recipe_title TEXT NOT NULL,
  recipe_url TEXT,
  meal_type TEXT CHECK (meal_type IN ('breakfast', 'lunch', 'dinner', 'snack')),
  used_date DATE NOT NULL DEFAULT CURRENT_DATE,
  created_at TIMESTAMPTZ DEFAULT now()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_recipe_usage_history_user_id 
  ON public.recipe_usage_history(user_id);
CREATE INDEX idx_recipe_usage_history_family_member_id 
  ON public.recipe_usage_history(family_member_id);
CREATE INDEX idx_recipe_usage_history_used_date 
  ON public.recipe_usage_history(used_date);
CREATE INDEX idx_recipe_usage_history_recipe_title 
  ON public.recipe_usage_history(recipe_title);

-- ë³µí•© ì¸ë±ìŠ¤: ì¤‘ë³µ ì²´í¬ ìµœì í™”
CREATE INDEX idx_recipe_usage_user_title_date 
  ON public.recipe_usage_history(user_id, recipe_title, used_date);

-- RLS ë¹„í™œì„±í™”
ALTER TABLE public.recipe_usage_history DISABLE ROW LEVEL SECURITY;

-- ê¶Œí•œ ë¶€ì—¬
GRANT ALL ON TABLE public.recipe_usage_history 
  TO anon, authenticated, service_role;

-- ìë™ ì •ë¦¬ í•¨ìˆ˜ (90ì¼ ì´ìƒ ëœ ì´ë ¥ ì‚­ì œ)
CREATE OR REPLACE FUNCTION cleanup_old_recipe_history()
RETURNS void AS $$
BEGIN
  DELETE FROM public.recipe_usage_history
  WHERE used_date < CURRENT_DATE - INTERVAL '90 days';
END;
$$ LANGUAGE plpgsql;

-- ë§¤ì¼ ìë™ ì •ë¦¬ (Supabase pg_cron ì‚¬ìš© ì‹œ)
-- SELECT cron.schedule('cleanup-recipe-history', '0 2 * * *', 'SELECT cleanup_old_recipe_history()');
```

---

## ì°¸ê³  ìë£Œ

- [Harris-Benedict ê³µì‹](https://en.wikipedia.org/wiki/Harris%E2%80%93Benedict_equation)
- [Edamam Recipe Search API](https://developer.edamam.com/edamam-docs-recipe-api)
- [ì‹í’ˆì•ˆì „ë‚˜ë¼ API](https://www.foodsafetykorea.go.kr/api/)
- [Supabase ê³µì‹ ë¬¸ì„œ](https://supabase.com/docs)
- [Clerk + Supabase í†µí•© ê°€ì´ë“œ](https://clerk.com/docs/integrations/databases/supabase)
- [Next.js 15 ê³µì‹ ë¬¸ì„œ](https://nextjs.org/docs)

---

## ë§ˆë¬´ë¦¬

ì´ ë¬¸ì„œëŠ” AI ë§ì¶¤ ì‹ë‹¨ ê¸°ëŠ¥ì˜ ì „ì²´ êµ¬í˜„ ê³¼ì •ì„ ë‹¤ë£¹ë‹ˆë‹¤. ë‹¤ë¥¸ í”„ë¡œì íŠ¸ì— ì ìš©í•  ë•ŒëŠ”:

1. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ í”„ë¡œì íŠ¸ì— ë§ê²Œ ì¡°ì •
2. ì™¸ë¶€ APIë¥¼ í•„ìš”ì— ë”°ë¼ ë³€ê²½
3. ì¹¼ë¡œë¦¬ ê³„ì‚° ë¡œì§ì„ ì‚¬ìš©ì ê·¸ë£¹ì— ë§ê²Œ ìˆ˜ì •
4. UI ì»´í¬ë„ŒíŠ¸ë¥¼ í”„ë¡œì íŠ¸ ë””ìì¸ì— ë§ê²Œ ì»¤ìŠ¤í„°ë§ˆì´ì§•

ì§ˆë¬¸ì´ë‚˜ ì¶”ê°€ ì„¤ëª…ì´ í•„ìš”í•˜ë©´ ì–¸ì œë“ ì§€ ë¬¸ì˜í•˜ì„¸ìš”!

---

## ë³€ê²½ ì´ë ¥

### v2.0.0 (2025-11-24)

**ì£¼ìš” ì¶”ê°€ ê¸°ëŠ¥**:

1. **ì œì²  ê³¼ì¼ ê°„ì‹ ì¶”ì²œ ì‹œìŠ¤í…œ**
   - 11ì¢… ê³¼ì¼ ë°ì´í„°ë² ì´ìŠ¤ (ì´ëª¨ì§€ í¬í•¨)
   - ì›”ë³„ ì œì²  ê³¼ì¼ ìë™ í•„í„°ë§
   - ì§ˆë³‘ë³„ ê³¼ì¼ ì œì™¸ ë¡œì§ (ë‹¹ë‡¨, í†µí’ ë“±)
   - ì„±ì¥ê¸° ì–´ë¦°ì´ ìš°ì„  ì¶”ì²œ
   - í´ë°± ë¡œì§ (ë°”ë‚˜ë‚˜ â†’ ë”¸ê¸°)
   - UI: í° ì´ëª¨ì§€ + ê³¼ì¼ëª… + ìˆ˜ëŸ‰/ì¹¼ë¡œë¦¬ í‘œì‹œ
   - ì´ ì¹¼ë¡œë¦¬ ê³„ì‚°ì—ì„œ ê°„ì‹ ì œì™¸

2. **ì •ë°€ ì¹¼ë¡œë¦¬ ê³„ì‚° ì‹œìŠ¤í…œ**
   - í•œêµ­ì˜ì–‘í•™íšŒ ê¸°ì¤€ ì—°ë ¹ë³„ ê¶Œì¥ ì¹¼ë¡œë¦¬
   - 18ì„¸ ë¯¸ë§Œ ìƒì„¸ ì—°ë ¹ êµ¬ë¶„ (1-2, 3-5, 6-8, 9-11, 12-14, 15-18ì„¸)
   - 12ì„¸ ì´ìƒ Harris-Benedict ê³µì‹ ì ìš©
   - ì§ˆë³‘ë³„ ì¹¼ë¡œë¦¬ ì¡°ì • (7ê°€ì§€ ì§ˆë³‘)
   - ë³µí•© ì§ˆë³‘ ì²˜ë¦¬ (ê°€ì¥ ë‚®ì€ ê³„ìˆ˜ ì ìš©)
   - ìƒì„¸ ì½˜ì†” ë¡œê·¸ë¡œ ê³„ì‚° ê³¼ì • ì¶”ì 

3. **ê°€ì¡± ì‹ë‹¨ íƒ­ ì¸í„°í˜ì´ìŠ¤**
   - ì‚¬ìš©ì ë³¸ì¸ + ê°€ì¡± êµ¬ì„±ì› íƒ­ ì „í™˜
   - í† ê¸€ ìŠ¤ìœ„ì¹˜ë¡œ í†µí•© ì‹ë‹¨ í¬í•¨/ì œì™¸
   - ì‹¤ì‹œê°„ í†µí•© ì¹¼ë¡œë¦¬ í•©ì‚° í‘œì‹œ
   - ê±´ê°• ìƒíƒœ ìš”ì•½ í‘œì‹œ
   - ëª©í‘œ ì¹¼ë¡œë¦¬ ëŒ€ë¹„ í˜„ì¬ ì¹¼ë¡œë¦¬

4. **êµ¬ë… ê¸°ë°˜ ê°€ì¡± êµ¬ì„±ì› ì œí•œ**
   - êµ¬ë… í”Œëœë³„ ì œí•œ (free: 1ëª…, premium: 8ëª…, enterprise: 20ëª…)
   - ê°€ì¡± êµ¬ì„±ì› ì¶”ê°€ ì‹œ ì œí•œ í™•ì¸
   - ì—…ê·¸ë ˆì´ë“œ ì•ˆë‚´ ë©”ì‹œì§€

5. **ì§ˆë³‘ë³„ ì œì™¸ ìŒì‹ í™•ì¥**
   - ì´ 186ê°œ í•­ëª© ì¶”ê°€
   - ë‹¹ë‡¨ 35ê°œ, ê³ í˜ˆì•• 40ê°œ, í†µí’ 30ê°œ, ì‹ ì¥ì§ˆí™˜ 25ê°œ, ê³ ì§€í˜ˆì¦ 30ê°œ, ë¹„ë§Œ 26ê°œ
   - severity ë ˆë²¨ (high, medium, low)
   - ì¬ë£Œ ìˆ˜ì¤€ + ë ˆì‹œí”¼ í‚¤ì›Œë“œ í•„í„°ë§

6. **ë ˆì‹œí”¼ ì‚¬ìš© ì´ë ¥ ì‹œìŠ¤í…œ**
   - ë©”ë‰´ ì¤‘ë³µ ë°©ì§€ (30ì¼ ê¸°ì¤€)
   - ìë™ ì´ë ¥ ì •ë¦¬ (90ì¼ ì´ìƒ)
   - ë³µí•© ì¸ë±ìŠ¤ë¡œ ì„±ëŠ¥ ìµœì í™”

**ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜**:
- `20251124050242_expand_disease_excluded_foods.sql` (186ê°œ í•­ëª©)
- `20251124051500_recipe_usage_history.sql` (ë ˆì‹œí”¼ ì´ë ¥ í…Œì´ë¸”)
- `20251124060000_user_subscriptions.sql` (êµ¬ë… ì •ë³´ í…Œì´ë¸”)

**ìƒˆ íŒŒì¼**:
- `lib/diet/seasonal-fruits.ts` (ì œì²  ê³¼ì¼ ë°ì´í„° ë° ì¶”ì²œ ë¡œì§)
- `types/subscription.ts` (êµ¬ë… íƒ€ì… ì •ì˜)
- `components/diet/family-diet-tabs.tsx` (íƒ­ ì¸í„°í˜ì´ìŠ¤)
- `components/diet/meal-card.tsx` (ê°„ì‹ ì¹´ë“œ, ì´ëª¨ì§€ í‘œì‹œ)

**ìˆ˜ì •ëœ íŒŒì¼**:
- `lib/diet/calorie-calculator.ts` (ì •ë°€ ì¹¼ë¡œë¦¬ ê³„ì‚° ë¡œì§)
- `lib/diet/family-diet-generator.ts` (ê³¼ì¼ ê°„ì‹ í†µí•©)
- `components/home/ai-diet-section.tsx` (íƒ­ ì¸í„°í˜ì´ìŠ¤ í†µí•©)
- `types/recipe.ts` (emoji, imageUrl í•„ë“œ ì¶”ê°€)
- `app/api/family/members/route.ts` (êµ¬ë… ì œí•œ í™•ì¸)

### v1.0.0 (2024-11-24)

**ì´ˆê¸° ë²„ì „**:
- ê°œì¸ ë§ì¶¤ ì‹ë‹¨ ìƒì„±
- ê°€ì¡± í†µí•© ì‹ë‹¨ ìƒì„±
- Harris-Benedict ê³µì‹ ê¸°ë°˜ ì¹¼ë¡œë¦¬ ê³„ì‚°
- ì§ˆë³‘/ì•Œë ˆë¥´ê¸° í•„í„°ë§
- í•œì‹ êµ¬ì¡°í™” (ë°¥ + ë°˜ì°¬ 3ê°œ + êµ­/ì°Œê°œ)
- Edamam API í†µí•©
- í´ë°± ë ˆì‹œí”¼ ì‹œìŠ¤í…œ
- Cron ìë™ ì‹ë‹¨ ìƒì„±

---

## ì™„ì „í•œ êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

ë‹¤ë¥¸ í”„ë¡œì íŠ¸ì—ì„œ ì²˜ìŒë¶€í„° êµ¬í˜„í•  ë•Œ ë‹¤ìŒ ìˆœì„œëŒ€ë¡œ ì§„í–‰í•˜ì„¸ìš”:

### Phase 1: í™˜ê²½ ì„¤ì • (Day 1)

- [ ] Next.js 15 í”„ë¡œì íŠ¸ ìƒì„±
- [ ] í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
  ```bash
  pnpm add @supabase/supabase-js @clerk/nextjs lucide-react
  pnpm add -D @types/node typescript
  ```
- [ ] Supabase í”„ë¡œì íŠ¸ ìƒì„±
- [ ] Clerk í”„ë¡œì íŠ¸ ìƒì„±
- [ ] Edamam API í‚¤ ë°œê¸‰
- [ ] í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (`.env.local`)

### Phase 2: ë°ì´í„°ë² ì´ìŠ¤ (Day 1-2)

- [ ] ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰
  1. `setup_schema.sql` (users í…Œì´ë¸”)
  2. `20250124000001_user_health_profile.sql`
  3. `20250122000000_family_health_section_a.sql` (family_members, disease_excluded_foods, íŠ¸ë¦¬ê±°)
  4. `20250126000000_diet_plans.sql`
  5. `20251124050242_expand_disease_excluded_foods.sql` (186ê°œ í•­ëª©)
  6. `20251124051500_recipe_usage_history.sql`
  7. `20251124060000_user_subscriptions.sql`
- [ ] ì¸ë±ìŠ¤ ìƒì„± í™•ì¸
- [ ] RLS ë¹„í™œì„±í™” í™•ì¸ (ê°œë°œ í™˜ê²½)

### Phase 3: ì¸ì¦ ì„¤ì • (Day 2)

- [ ] Clerk ë¯¸ë“¤ì›¨ì–´ ì„¤ì • (`middleware.ts`)
- [ ] Supabase í´ë¼ì´ì–¸íŠ¸ íŒŒì¼ ìƒì„±
  - [ ] `lib/supabase/clerk-client.ts`
  - [ ] `lib/supabase/server.ts`
  - [ ] `lib/supabase/service-role.ts`
- [ ] ì‚¬ìš©ì ë™ê¸°í™” API (`/api/sync-user`)

### Phase 4: íƒ€ì… ì •ì˜ (Day 2)

- [ ] `types/family.ts` (FamilyMember, UserHealthProfile, Disease)
- [ ] `types/recipe.ts` (RecipeDetail, MealComposition, DailyDietPlan, FamilyDietPlan)
- [ ] `types/subscription.ts` (SubscriptionPlan, SubscriptionLimits)

### Phase 5: í•µì‹¬ ë¡œì§ (Day 3-4)

- [ ] `lib/diet/calorie-calculator.ts` (ì •ë°€ ì¹¼ë¡œë¦¬ ê³„ì‚°)
- [ ] `lib/diet/food-filtering.ts` (ì§ˆë³‘ í•„í„°ë§)
- [ ] `lib/diet/seasonal-fruits.ts` (ì œì²  ê³¼ì¼ ì¶”ì²œ)
- [ ] `lib/recipes/unified-recipe-service.ts` (Edamam ì—°ë™)
- [ ] `lib/recipes/fallback-recipes.ts` (í´ë°± ë ˆì‹œí”¼)
- [ ] `lib/diet/recipe-history.ts` (ë©”ë‰´ ì¤‘ë³µ ë°©ì§€)

### Phase 6: ì‹ë‹¨ ìƒì„± (Day 4-5)

- [ ] `lib/diet/personal-diet-generator.ts` (ê°œì¸ ì‹ë‹¨)
- [ ] `lib/diet/family-diet-generator.ts` (ê°€ì¡± ì‹ë‹¨)
- [ ] ê³¼ì¼ ê°„ì‹ ë¡œì§ í†µí•©
- [ ] ì´ ì˜ì–‘ ì •ë³´ ê³„ì‚° (ê°„ì‹ ì œì™¸)

### Phase 7: API ë¼ìš°íŠ¸ (Day 5-6)

- [ ] `app/api/diet/personal/route.ts`
- [ ] `app/api/family/diet/generate/route.ts`
- [ ] `app/api/family/diet/[date]/route.ts`
- [ ] `app/api/family/members/route.ts` (êµ¬ë… ì œí•œ í¬í•¨)
- [ ] `app/api/health/profile/route.ts`
- [ ] `app/api/cron/generate-daily-diets/route.ts`

### Phase 8: UI ì»´í¬ë„ŒíŠ¸ (Day 6-7)

- [ ] shadcn/ui ì»´í¬ë„ŒíŠ¸ ì„¤ì¹˜
  ```bash
  pnpx shadcn@latest add card button tabs switch
  ```
- [ ] `components/diet/daily-diet-view.tsx`
- [ ] `components/diet/meal-composition-card.tsx`
- [ ] `components/diet/meal-card.tsx` (ê³¼ì¼ ì´ëª¨ì§€ í‘œì‹œ)
- [ ] `components/diet/family-diet-tabs.tsx` (íƒ­ ì¸í„°í˜ì´ìŠ¤)
- [ ] `components/home/ai-diet-section.tsx`

### Phase 9: í…ŒìŠ¤íŠ¸ & ë””ë²„ê¹… (Day 7-8)

- [ ] ê°œì¸ ì‹ë‹¨ ìƒì„± í…ŒìŠ¤íŠ¸
- [ ] ê°€ì¡± ì‹ë‹¨ ìƒì„± í…ŒìŠ¤íŠ¸
- [ ] ì§ˆë³‘ í•„í„°ë§ í™•ì¸
- [ ] ì¹¼ë¡œë¦¬ ê³„ì‚° ê²€ì¦
- [ ] ê³¼ì¼ ê°„ì‹ ì¶”ì²œ í™•ì¸
- [ ] íƒ­ ì¸í„°í˜ì´ìŠ¤ ë™ì‘ í™•ì¸
- [ ] êµ¬ë… ì œí•œ í…ŒìŠ¤íŠ¸

### Phase 10: ë°°í¬ (Day 8)

- [ ] Vercel ë°°í¬
- [ ] í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
- [ ] Cron Job ì„¤ì • (`vercel.json`)
- [ ] í”„ë¡œë•ì…˜ í…ŒìŠ¤íŠ¸

---

## ì˜ˆìƒ ë¹„ìš©

### Supabase (ë¬´ë£Œ í”Œëœ)
- 500MB ë°ì´í„°ë² ì´ìŠ¤
- 1GB íŒŒì¼ ì €ì¥ì†Œ
- 50,000 ì›”ê°„ í™œì„± ì‚¬ìš©ì

### Clerk (ë¬´ë£Œ í”Œëœ)
- 10,000 ì›”ê°„ í™œì„± ì‚¬ìš©ì
- ê¸°ë³¸ ì¸ì¦ ê¸°ëŠ¥

### Edamam Recipe Search API
- **Developer í”Œëœ**: $0/ì›” (5 API calls/ë¶„, 5000 calls/ì›”)
- **Basic í”Œëœ**: $49/ì›” (10 API calls/ë¶„, 10000 calls/ì›”)
- **Startup í”Œëœ**: $149/ì›” (30 API calls/ë¶„, 50000 calls/ì›”)

### Vercel (ë¬´ë£Œ í”Œëœ)
- 100GB ëŒ€ì—­í­
- ë¬´ì œí•œ ì›¹ì‚¬ì´íŠ¸
- Cron Job í¬í•¨

**ì¶”ì • ì›”ê°„ ë¹„ìš© (100 ì‚¬ìš©ì ê¸°ì¤€)**:
- ë¬´ë£Œ í”Œëœ ì‚¬ìš© ì‹œ: $0
- Edamam Basic ì¶”ê°€ ì‹œ: $49/ì›”
- **ì´ê³„**: $0 ~ $49/ì›”

---

**ë¬¸ì„œ ë²„ì „**: 2.0.0  
**ìµœì¢… ìˆ˜ì •ì¼**: 2025ë…„ 11ì›” 24ì¼  
**ì‘ì„±ì**: AI Assistant  
**í˜ì´ì§€ ìˆ˜**: ì•½ 120í˜ì´ì§€ (A4 ê¸°ì¤€)

