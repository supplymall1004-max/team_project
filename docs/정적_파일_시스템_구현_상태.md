# 정적 파일 기반 식약처 레시피 시스템 구현 상태

## 📋 구현 완료 항목

### 1. 데이터베이스 마이그레이션 ✅
- `recipes` 테이블에 `static_file_path`, `static_file_updated_at` 컬럼 추가
- 관련 인덱스 추가 완료
- 마이그레이션 파일: `supabase/migrations/20260131000000_add_static_file_support_for_recipes.sql`

### 2. 정적 파일 로더 구현 ✅
- `lib/mfds/static-recipe-loader.ts` - 마크다운 파일에서 레시피 로드
- `lib/mfds/reference-parser.ts` - 참고사항 섹션 파싱
- 기능:
  - 파일 경로로 레시피 로드
  - RCP_SEQ로 레시피 로드
  - 전체 레시피 로드
  - 레시피 검색
  - 카테고리별 필터링

### 3. API 라우트 수정 ✅
모든 API 라우트가 **정적 파일 우선, API 폴백** 방식으로 수정됨:

- ✅ `/api/mfds-recipes` - 레시피 목록 조회
- ✅ `/api/mfds-recipes/search` - 레시피 검색
- ✅ `/api/diet/meal/breakfast/[date]` - 아침 식단
- ✅ `/api/diet/meal/lunch/[date]` - 점심 식단
- ✅ `/api/diet/meal/dinner/[date]` - 저녁 식단

### 4. 컴포넌트 수정 ✅
- ✅ `components/home/mfds-recipe-section.tsx` - 홈페이지 레시피 섹션

### 5. 식단 생성 로직 수정 ✅
- ✅ `lib/diet/queries.ts`:
  - `getMfdsRecipesOnly()` - 정적 파일 우선 사용
  - `getRecipesWithNutrition()` - 정적 파일 우선 사용
- ✅ `lib/diet/personal-diet-generator.ts` - `getRecipesWithNutrition()` 사용
- ✅ `lib/diet/weekly-diet-generator.ts` - `getRecipesWithNutrition()` 사용
- ✅ `lib/diet/family-diet-generator.ts` - `getRecipesWithNutrition()` 사용

### 6. 데이터 수집 스크립트 ✅
- ✅ `scripts/collect-mfds-recipes.ts` - 식약처 API에서 데이터 수집하여 마크다운 파일 생성
- 기능:
  - 식약처 API에서 레시피 데이터 수집
  - 마크다운 형식으로 변환
  - 카테고리별 분류
  - 영양 정보 인덱스 생성

## ⚠️ 현재 문제점

### 1. 실제 데이터 부재
- API 호출이 타임아웃되어 데이터 수집 실패
- `docs/mfds-recipes/recipes/` 디렉토리에 레시피 파일이 없음
- 원인: 네트워크 문제 또는 API 키 문제 가능성

### 2. API 연결 문제
- 식약처 API 호출 시 30초 타임아웃 발생
- 재시도 로직 작동하지만 계속 실패

## 🔄 데이터 흐름

### 건강식단 생성
```
사용자 요청
  ↓
generatePersonalDiet()
  ↓
getRecipesWithNutrition()
  ↓
[1] 데이터베이스 레시피 조회
  ↓ (부족한 경우)
[2] 정적 파일에서 식약처 레시피 로드 (우선)
  ↓ (실패 시)
[3] 식약처 API 호출 (폴백)
  ↓
식단 생성
```

### 주간식단 생성
```
사용자 요청
  ↓
generateWeeklyDiet()
  ↓
getRecipesWithNutrition()
  ↓
[1] 데이터베이스 레시피 조회
  ↓ (부족한 경우)
[2] 정적 파일에서 식약처 레시피 로드 (우선)
  ↓ (실패 시)
[3] 식약처 API 호출 (폴백)
  ↓
7일치 식단 생성
```

### 건강 시각화 자료
```
식단 조회 API
  ↓
/api/diet/meal/breakfast|lunch|dinner/[date]
  ↓
[1] 정적 파일에서 레시피 로드 (우선)
  ↓ (실패 시)
[2] 식약처 API 호출 (폴백)
  ↓
영양 정보 추출
  ↓
시각화 컴포넌트에 전달
```

## 📊 사용 위치 확인

### ✅ 건강식단
- `lib/diet/personal-diet-generator.ts` → `getRecipesWithNutrition()` 사용
- 정적 파일 우선 사용 ✅

### ✅ 주간식단
- `lib/diet/weekly-diet-generator.ts` → `getRecipesWithNutrition()` 사용
- 정적 파일 우선 사용 ✅

### ✅ 건강 시각화 자료
- `app/api/diet/meal/breakfast|lunch|dinner/[date]/route.ts`
- 정적 파일 우선 사용 ✅
- `app/diet/breakfast|lunch|dinner/[date]/page.tsx` - NutritionCharts 컴포넌트 사용

### ✅ 기타 자료
- 홈페이지 레시피 섹션: `components/home/mfds-recipe-section.tsx` ✅
- 레시피 검색: `/api/mfds-recipes/search` ✅

## 🚀 다음 단계

### 1. API 연결 문제 해결
- 네트워크 연결 확인
- API 키 유효성 확인
- 타임아웃 시간 조정 (현재 30초)

### 2. 데이터 수집 재시도
```bash
# 환경 변수 확인 후
pnpm tsx scripts/collect-mfds-recipes.ts
```

### 3. 테스트용 샘플 데이터 생성 (선택)
- 수동으로 몇 개의 레시피 마크다운 파일 생성
- 시스템 동작 확인

## 📝 마크다운 파일 형식

레시피 파일은 다음 형식을 따릅니다:

```markdown
---
rcp_seq: "12345"
rcp_nm: "된장찌개"
rcp_way2: "끓이기"
rcp_pat2: "찌개"
---

# 된장찌개

본문 내용...

---

## 참고사항

### 기본 정보
- **레시피 순번 (RCP_SEQ)**: 12345
- **레시피명 (RCP_NM)**: 된장찌개
...

### 영양 정보
- **칼로리 (INFO_ENG)**: 150
- **탄수화물 (INFO_CAR)**: 20
...
```

## ✅ 결론

**구현 상태**: 모든 코드는 정적 파일을 우선 사용하도록 구현 완료 ✅

**남은 작업**: 실제 데이터 수집 (API 연결 문제 해결 필요)

**현재 동작**: 정적 파일이 없으면 기존 API로 폴백하여 정상 작동 ✅

