# 정적 파일 기반 식약처 레시피 시스템 마이그레이션 완료 보고서

## 마이그레이션 정보

- **마이그레이션 파일**: `supabase/migrations/20260131000000_add_static_file_support_for_recipes.sql`
- **적용 일시**: 2026-01-31
- **상태**: ✅ 성공적으로 적용됨

## 추가된 컬럼

### recipes 테이블

1. **static_file_path** (TEXT, NULL 가능)
   - 목적: 정적 파일 경로 저장 (마크다운 파일 경로)
   - 예시: `docs/mfds-recipes/recipes/1.md`
   - 설명: 정적 파일 기반 레시피의 경우 이 컬럼에 파일 경로가 저장됨

2. **static_file_updated_at** (TIMESTAMPTZ, NULL 가능)
   - 목적: 정적 파일 마지막 업데이트 시간 추적
   - 설명: 파일 업데이트 시 이 컬럼이 갱신됨

## 추가된 인덱스

1. **idx_recipes_foodsafety_rcp_seq**
   - 컬럼: `foodsafety_rcp_seq`
   - 조건: `WHERE foodsafety_rcp_seq IS NOT NULL`
   - 목적: 식약처 레시피 순번으로 빠른 조회

2. **idx_recipes_static_file_path**
   - 컬럼: `static_file_path`
   - 조건: `WHERE static_file_path IS NOT NULL`
   - 목적: 정적 파일 경로로 빠른 조회

3. **idx_recipes_foodsafety_static** (복합 인덱스)
   - 컬럼: `foodsafety_rcp_seq`, `static_file_path`
   - 조건: `WHERE foodsafety_rcp_seq IS NOT NULL`
   - 목적: 두 컬럼 조합 조회 최적화

## 유지된 관계성

### 외래키 관계

- **diet_plans.recipe_id** → **recipes.id**
  - 제약조건명: `diet_plans_recipe_id_fkey`
  - 삭제 규칙: `CASCADE` (레시피 삭제 시 식단도 삭제)
  - 업데이트 규칙: 기본값 유지

**결론**: 기존 데이터베이스 관계는 모두 유지되며, 하위 호환성이 보장됩니다.

## 하위 호환성

### 기존 기능 유지

1. **기존 API 기반 레시피**
   - `static_file_path`가 NULL인 경우 기존 로직 사용
   - API 호출로 데이터 조회

2. **정적 파일 기반 레시피**
   - `static_file_path`가 있는 경우 정적 파일 로더 사용
   - 파일 시스템에서 직접 조회

3. **하이브리드 지원**
   - 우선순위: 정적 파일 > API 호출
   - 정적 파일이 없으면 API 호출로 폴백

## 다음 단계

1. **정적 파일 로더 구현**
   - `lib/mfds/static-recipe-loader.ts` 생성
   - 마크다운 파서 구현
   - 참고사항 섹션 파서 구현

2. **데이터 수집 스크립트**
   - `scripts/collect-mfds-recipes.ts` 작성
   - 식약처 API에서 모든 레시피 수집
   - 마크다운 파일 생성

3. **API 라우트 수정**
   - 정적 파일 로더 통합
   - API 호출 제거 또는 폴백으로 변경

4. **컴포넌트 수정**
   - 정적 파일 로더 사용
   - UI 변경 없음

## 성능 개선 예상

### 현재 (API 호출)
- 레시피 조회: 1-10초
- 식단 생성: 5-30초
- 네트워크 의존: 필수

### 개선 후 (정적 파일)
- 레시피 조회: < 10ms
- 식단 생성: < 100ms
- 네트워크 의존: 없음

**성능 향상: 50-300배**

## 주의사항

1. **기존 데이터**
   - 기존 `recipes` 테이블 데이터는 영향 없음
   - `static_file_path`가 NULL인 경우 기존 로직 사용

2. **데이터 마이그레이션**
   - `foodsafety_recipes_cache` 테이블 데이터를 정적 파일로 변환 필요
   - 변환 스크립트 작성 필요

3. **파일 시스템 구조**
   - `docs/mfds-recipes/` 디렉토리 구조 생성 필요
   - 마크다운 파일 형식 정의 필요

