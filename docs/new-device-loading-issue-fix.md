# 새 기기 접속 무한 로딩 문제 해결 보고서

## 문제 현상
- **기존 사용자**: 정상 접속 ✅
- **새 기기 사용자**: 무한 로딩 발생 ❌

## 원인 분석

### 1. IntroVideo 컴포넌트 문제 (주요 원인)
**문제점:**
- 새 기기에서 동영상 파일(`/icons/intro.mp4`) 로드 실패 시 무한 로딩
- 타임아웃이 1초로 짧고, 에러 핸들러 부재
- 동영상 요소를 찾지 못하면 `showVideo`가 `false`로 설정되지 않음

**영향:**
- 새 기기/브라우저에서 동영상 파일이 없거나 네트워크 문제로 로드 실패 시
- 검은 화면이 계속 표시되어 사용자가 페이지를 볼 수 없음

### 2. useSyncUser 훅 문제
**문제점:**
- 동기화 실패 시 `syncedRef.current`가 `true`로 설정되지 않아 무한 재시도
- 새 기기에서는 인증이 안 되어 있어서 `userId`가 `null`일 수 있음

**영향:**
- 비로그인 사용자도 동기화를 시도하여 불필요한 API 호출
- 에러 발생 시 무한 재시도로 인한 성능 저하

### 3. Clerk 인증 초기화 지연
**문제점:**
- 새 기기에서는 Clerk 세션이 없어서 인증 초기화에 시간이 걸림
- `isLoaded`가 `false`인 동안 일부 컴포넌트가 로딩 상태로 대기

**영향:**
- 인증 초기화가 완료될 때까지 페이지가 로드되지 않을 수 있음

## 수정 사항

### 1. IntroVideo 컴포넌트 개선 ✅

**수정 내용:**
1. **에러 핸들러 추가**
   - `video.addEventListener("error", handleError)` 추가
   - `onError` prop 추가
   - 에러 발생 시 즉시 메인 콘텐츠 표시

2. **타임아웃 개선**
   - 최대 시도 횟수: 20회 (1초)
   - 안전장치 타임아웃: 2초 → 3초로 증가
   - 타임아웃 시 `hasSeenIntro`를 로컬 스토리지에 저장하여 재방문 시 스킵

3. **안전장치 추가**
   - 최대 3초 후 자동으로 메인 콘텐츠 표시
   - 동영상 재생 실패 시 즉시 메인 콘텐츠 표시 (3초 대기 없음)

**수정된 파일:**
- `components/intro-video.tsx`

### 2. useSyncUser 훅 개선 ✅

**수정 내용:**
1. **무한 재시도 방지**
   - 모든 에러 케이스에서 `syncedRef.current = true` 설정
   - 타임아웃, 네트워크 에러, 서버 에러, 기타 에러 발생 시 재시도 중단

2. **비로그인 사용자 처리 개선**
   - 비로그인 사용자는 약간의 지연(500ms) 후 동기화 시도
   - 로그인 사용자는 빠르게(100ms) 동기화 시도

**수정된 파일:**
- `hooks/use-sync-user.ts`

### 3. API 라우트 개선 ✅

**수정 내용:**
1. **중복 키 에러 처리**
   - `app/api/sync-user/route.ts`: 중복 키 에러 발생 시 기존 사용자 재조회
   - `lib/supabase/ensure-user.ts`: 중복 키 에러 처리 추가

2. **에러 코드 처리 개선**
   - `PGRST116` 에러 무시 (사용자가 없는 정상 케이스)

**수정된 파일:**
- `app/api/sync-user/route.ts`
- `lib/supabase/ensure-user.ts`

## 테스트 체크리스트

### 새 기기에서 테스트해야 할 항목:
1. ✅ 인트로 동영상이 로드되지 않아도 메인 콘텐츠가 표시되는가?
2. ✅ 비로그인 사용자가 정상적으로 홈페이지를 볼 수 있는가?
3. ✅ 새 사용자가 로그인 후 정상적으로 접속할 수 있는가?
4. ✅ 동영상 파일이 없어도 페이지가 로드되는가?
5. ✅ 네트워크가 느린 환경에서도 타임아웃 후 메인 콘텐츠가 표시되는가?

## 추가 권장 사항

### 1. 환경 변수 확인
Vercel 배포 환경에서 다음 환경 변수가 제대로 설정되어 있는지 확인:
- `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY`
- `CLERK_SECRET_KEY`
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `SUPABASE_SERVICE_ROLE_KEY`

### 2. 동영상 파일 확인
- `/public/icons/intro.mp4` 파일이 존재하는지 확인
- 파일 크기가 너무 크면 로드 시간이 길어질 수 있음
- CDN을 사용하여 로드 속도 개선 고려

### 3. 모니터링
- Vercel 로그에서 에러 패턴 확인
- 새 사용자 접속 시 발생하는 에러 로그 분석
- 성능 메트릭 모니터링

## 예상 결과

수정 후:
- ✅ 새 기기에서도 정상적으로 접속 가능
- ✅ 동영상 로드 실패 시에도 메인 콘텐츠 표시
- ✅ 무한 로딩 문제 해결
- ✅ 사용자 경험 개선

## 참고 사항

- 인트로 동영상은 첫 방문 시에만 표시되며, 이후에는 로컬 스토리지에 저장되어 스킵됩니다.
- 동영상이 로드되지 않아도 사용자는 정상적으로 사이트를 이용할 수 있습니다.
- 사용자 동기화는 백그라운드에서 비동기로 처리되며, 페이지 로딩을 방해하지 않습니다.
